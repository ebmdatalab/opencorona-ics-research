----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\08_an_model_checks_asthma.log
  log type:  text
 opened on:  27 Jul 2020, 13:55:10

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. * Exposure labels 
. local lab1: label exposure 1

. local lab2: label exposure 2

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.03009         0.48        1         0.4888
      2.exposure  |      0.01744         0.16        1         0.6883
      ------------+---------------------------------------------------
      global test |                      0.53        2         0.7688
      ----------------------------------------------------------------

. local univar_p1 = round(r(phtest)[2,4],0.001)

. local univar_p2 = round(r(phtest)[3,4],0.001)

. 
. di `univar_p1'
.489

. di `univar_p2'
.688

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab1'", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1a.svg", as(svg) replace
(file asthma_output/schoenplot1a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab2'", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1b.svg", as(svg) replace
(file asthma_output/schoenplot1b.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7201.731
Iteration 1:   log likelihood = -6727.2325
Iteration 2:   log likelihood = -6662.5988
Iteration 3:   log likelihood =  -6658.249
Iteration 4:   log likelihood = -6657.1834
Iteration 5:   log likelihood = -6657.0444
Iteration 6:   log likelihood = -6657.0411
Iteration 7:   log likelihood = -6657.0411
Refining estimates:
Iteration 0:   log likelihood = -6657.0411

Cox regression -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(6)       =     1089.38
Log likelihood  =   -6657.0411                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.020163   .1551406     0.13   0.896      .757223    1.374407
      ICS (High Dose)  |   1.613729   .2794614     2.76   0.006     1.149269    2.265893
                       |
                1.male |   1.504651   .1325132     4.64   0.000     1.266109    1.788135
                  age1 |   1.210453   .0950897     2.43   0.015      1.03772    1.411939
                  age2 |   .7821648   .1217926    -1.58   0.115     .5764423    1.061306
                  age3 |   2.020898   .8126089     1.75   0.080     .9189116    4.444419
----------------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.03199         0.54        1         0.4610
      2.exposure  |      0.01862         0.18        1         0.6680
      0b.male     |            .            .        1             .
      1.male      |     -0.10560         6.01        1         0.0142
      age1        |      0.06805         1.66        1         0.1975
      age2        |     -0.08212         2.45        1         0.1175
      age3        |      0.09004         2.99        1         0.0838
      ------------+---------------------------------------------------
      global test |                     19.20        6         0.0038
      ----------------------------------------------------------------

. local multivar1_p1 = round(r(phtest)[2,4],0.001)

. local multivar1_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab1'", position(11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2a.svg", as(svg) replace
(file asthma_output/schoenplot2a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab2'", position(11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2b.svg", as(svg) replace
(file asthma_output/schoenplot2b.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5482.5839
Iteration 1:   log likelihood = -4997.5432
Iteration 2:   log likelihood = -4829.9297
Iteration 3:   log likelihood = -4825.2612
Iteration 4:   log likelihood = -4824.9596
Iteration 5:   log likelihood =  -4824.946
Iteration 6:   log likelihood =  -4824.946
Refining estimates:
Iteration 0:   log likelihood =  -4824.946

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(28)      =     1315.28
Log likelihood  =    -4824.946                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
     ICS (Low/Medium Dose)  |   1.144791   .1748102     0.89   0.376     .8486866    1.544206
           ICS (High Dose)  |   1.547167    .270485     2.50   0.013      1.09831    2.179462
                            |
                     1.male |   1.535925   .1405994     4.69   0.000     1.283661    1.837762
                       age1 |   1.201588    .094378     2.34   0.019     1.030145    1.401563
                       age2 |   .7790454   .1222021    -1.59   0.111     .5728517    1.059457
                       age3 |   2.027303   .8248598     1.74   0.082     .9132416    4.500406
                            |
                  obese4cat |
         Obese I (30-34.9)  |    1.14361   .1250702     1.23   0.220     .9229682    1.416997
        Obese II (35-39.9)  |   1.118823   .1762495     0.71   0.476     .8216195    1.523534
           Obese III (40+)  |   1.765617   .3130296     3.21   0.001     1.247341    2.499238
                            |
               smoke_nomiss |
                    Former  |   1.105273   .1014431     1.09   0.275     .9233057    1.323103
                   Current  |    .629419   .1588651    -1.83   0.067     .3837928    1.032245
                            |
                        imd |
                         2  |   1.191277    .181378     1.15   0.250       .88392    1.605508
                         3  |   1.370203    .203583     2.12   0.034     1.024034    1.833392
                         4  |   1.612842   .2388067     3.23   0.001     1.206585    2.155885
           5 most deprived  |   1.890839    .288363     4.18   0.000     1.402303    2.549573
                            |
                        ckd |
                       CKD  |   1.452152    .152974     3.54   0.000     1.181256    1.785172
             1.hypertension |   1.358296   .1460935     2.85   0.004     1.100126    1.677053
            1.heart_failure |    1.47402   .1972703     2.90   0.004     1.133929    1.916112
      1.other_heart_disease |   1.170935   .1268764     1.46   0.145     .9468933    1.447986
                            |
                    diabcat |
       Controlled diabetes  |   1.673222   .1821346     4.73   0.000     1.351755    2.071138
     Uncontrolled diabetes  |   2.662427    .357741     7.29   0.000     2.045995     3.46458
Diabetes, no hba1c measure  |   2.049076   1.195459     1.23   0.219     .6530637    6.429256
                            |
              1.cancer_ever |   1.480409   .1643678     3.53   0.000     1.190896    1.840303
                   1.statin |   .8565244   .0843728    -1.57   0.116     .7061408    1.038935
              1.flu_vaccine |    .815003   .0898607    -1.86   0.064     .6566098    1.011605
     1.pneumococcal_vaccine |   .7952829   .1311861    -1.39   0.165     .5755876    1.098833
            1.exacerbations |   1.279446   .1246753     2.53   0.011     1.057004    1.548699
            1.immunodef_any |   2.365231   1.372398     1.48   0.138     .7585314    7.375194
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.02423         0.31        1         0.5768
      2.exposure  |      0.02012         0.21        1         0.6440
      0b.male     |            .            .        1             .
      1.male      |     -0.09927         5.47        1         0.0193
      age1        |      0.06804         1.66        1         0.1971
      age2        |     -0.07750         2.25        1         0.1332
      age3        |      0.08359         2.70        1         0.1003
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.07241         2.77        1         0.0960
      3.obese4cat |     -0.00368         0.01        1         0.9326
      4.obese4cat |     -0.03148         0.52        1         0.4709
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.06808         2.41        1         0.1209
      3.smoke_no~s|      0.00594         0.02        1         0.8888
      1b.imd      |            .            .        1             .
      2.imd       |      0.06497         2.21        1         0.1369
      3.imd       |      0.01062         0.06        1         0.8081
      4.imd       |      0.02599         0.35        1         0.5522
      5.imd       |      0.03257         0.55        1         0.4573
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.07106         2.93        1         0.0868
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.00145         0.00        1         0.9712
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|      0.04118         0.97        1         0.3254
      0b.other_~se|            .            .        1             .
      1.other_h~se|     -0.00698         0.03        1         0.8672
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.05017         1.29        1         0.2567
      3.diabcat   |     -0.02912         0.47        1         0.4940
      4.diabcat   |      0.01916         0.19        1         0.6593
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.04358         1.05        1         0.3054
      0b.statin   |            .            .        1             .
      1.statin    |     -0.02147         0.26        1         0.6133
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.02753         0.43        1         0.5141
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.01665         0.14        1         0.7036
      0b.exacerb~s|            .            .        1             .
      1.exacerba~s|     -0.04730         1.19        1         0.2759
      0b.immunod~y|            .            .        1             .
      1.immunode~y|      0.01429         0.11        1         0.7422
      ------------+---------------------------------------------------
      global test |                     38.97       28         0.0814
      ----------------------------------------------------------------

. local multivar2_p1 = round(r(phtest)[2,4],0.001)

. local multivar2_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) /// 
>                           title ("Schoenfeld residuals against time, fully adjusted `lab1'", position(11) size(medsmall))                 

.                           
. graph export "$outdir/schoenplot3a.svg", as(svg) replace
(file asthma_output/schoenplot3a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted `lab2'", position(11) size(medsmall))                 

.                           
. graph export "$outdir/schoenplot3b.svg", as(svg) replace
(file asthma_output/schoenplot3b.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption for $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("`lab1'") _tab

. file write tablecontent ("`univar_p1'") _tab ("`multivar1_p1'") _tab ("`multivar2_p1'") _n

. 
. file write tablecontent ("`lab2'") _tab

. file write tablecontent ("`univar_p2'") _tab ("`multivar1_p2'") _tab ("`multivar2_p2'") _n

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\08_an_model_checks_asthma.log
  log type:  text
 closed on:  27 Jul 2020, 14:06:18
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
