-------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\08_an_model_checks_asthma.log
  log type:  text
 opened on:  27 May 2020, 10:46:43

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. * Exposure labels 
. local lab1: label exposure 1

. local lab2: label exposure 2

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.02329         0.27        1         0.6035
      2.exposure  |      0.01565         0.12        1         0.7271
      ------------+---------------------------------------------------
      global test |                      0.28        2         0.8704
      ----------------------------------------------------------------

. local univar_p1 = round(r(phtest)[2,4],0.001)

. local univar_p2 = round(r(phtest)[3,4],0.001)

. 
. di `univar_p1'
.604

. di `univar_p2'
.727

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab1'", position(11) size
> (medsmall)) 

. 
. graph export "$outdir/schoenplot1a.svg", as(svg) replace
(file asthma_output/schoenplot1a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab2'", position(11) size
> (medsmall)) 

. 
. graph export "$outdir/schoenplot1b.svg", as(svg) replace
(file asthma_output/schoenplot1b.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6765.9464
Iteration 1:   log likelihood = -6318.7882
Iteration 2:   log likelihood = -6256.3317
Iteration 3:   log likelihood = -6252.1372
Iteration 4:   log likelihood = -6251.1395
Iteration 5:   log likelihood = -6251.0062
Iteration 6:   log likelihood = -6251.0028
Iteration 7:   log likelihood = -6251.0028
Refining estimates:
Iteration 0:   log likelihood = -6251.0028

Cox regression -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(6)       =     1029.89
Log likelihood  =   -6251.0028                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.012286   .1589323     0.08   0.938     .7441518    1.377034
      ICS (High Dose)  |   1.649428   .2936761     2.81   0.005     1.163535    2.338232
                       |
                1.male |   1.556736   .1411906     4.88   0.000     1.303209    1.859585
                  age1 |   1.198015   .0972167     2.23   0.026     1.021854    1.404545
                  age2 |   .8067994   .1299159    -1.33   0.182     .5884366    1.106194
                  age3 |   1.843432   .7670512     1.47   0.142     .8155353    4.166887
----------------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.02660         0.35        1         0.5519
      2.exposure  |      0.01823         0.17        1         0.6838
      0b.male     |            .            .        1             .
      1.male      |     -0.10060         5.11        1         0.0238
      age1        |      0.05387         1.02        1         0.3131
      age2        |     -0.07407         1.93        1         0.1649
      age3        |      0.08441         2.53        1         0.1119
      ------------+---------------------------------------------------
      global test |                     16.23        6         0.0126
      ----------------------------------------------------------------

. local multivar1_p1 = round(r(phtest)[2,4],0.001)

. local multivar1_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab1'", position
> (11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2a.svg", as(svg) replace
(file asthma_output/schoenplot2a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab2'", position
> (11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2b.svg", as(svg) replace
(file asthma_output/schoenplot2b.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss             
>              ///
>                                                                                 i.imd                      
>                      ///
>                                                                                 i.ckd                      
>                      ///             
>                                                                                 i.hypertension             
>              ///             
>                                                                                 i.heart_failure            
>              ///             
>                                                                                 i.other_heart_disease      
>      ///             
>                                                                                 i.diabcat                  
>                      ///             
>                                                                                 i.cancer_ever              
>              ///                                     
>                                                                                 i.statin                   
>                      ///             
>                                                                                 i.flu_vaccine              
>              ///     
>                                                                                 i.pneumococcal_vaccine     
>      ///
>                                                                                 i.exacerbations, strata(stp
> )    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5149.6348
Iteration 1:   log likelihood = -4684.6614
Iteration 2:   log likelihood = -4533.5396
Iteration 3:   log likelihood = -4529.2292
Iteration 4:   log likelihood = -4528.9096
Iteration 5:   log likelihood =  -4528.893
Iteration 6:   log likelihood = -4528.8929
Refining estimates:
Iteration 0:   log likelihood = -4528.8929

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(27)      =     1241.48
Log likelihood  =   -4528.8929                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
     ICS (Low/Medium Dose)  |   1.126957   .1775661     0.76   0.448      .827542    1.534705
           ICS (High Dose)  |   1.556837   .2797001     2.46   0.014     1.094755    2.213957
                            |
                     1.male |    1.58446   .1493574     4.88   0.000     1.317175    1.905982
                       age1 |    1.19255   .0975773     2.15   0.031     1.015849    1.399987
                       age2 |   .7936626   .1296431    -1.41   0.157     .5762275    1.093145
                       age3 |   1.920779   .8137025     1.54   0.123     .8373006    4.406291
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.148338   .1295256     1.23   0.220     .9205754    1.432452
        Obese II (35-39.9)  |   1.126762   .1831664     0.73   0.463      .819334    1.549543
           Obese III (40+)  |    1.84806   .3331873     3.41   0.001     1.297934    2.631355
                            |
               smoke_nomiss |
                    Former  |   1.174491   .1118428     1.69   0.091     .9745242     1.41549
                   Current  |   .6775693   .1761812    -1.50   0.134     .4070285    1.127931
                            |
                        imd |
                         2  |   1.137756   .1792869     0.82   0.413     .8354435    1.549462
                         3  |    1.35428   .2063044     1.99   0.047      1.00471    1.825477
                         4  |   1.606945   .2434277     3.13   0.002     1.194145    2.162445
           5 most deprived  |   1.787087   .2820855     3.68   0.000     1.311555    2.435033
                            |
                        ckd |
                       CKD  |   1.499126   .1624395     3.74   0.000     1.212287    1.853835
             1.hypertension |   1.379962   .1535305     2.89   0.004     1.109597    1.716206
            1.heart_failure |   1.421935   .1986333     2.52   0.012     1.081368     1.86976
      1.other_heart_disease |   1.115623   .1254038     0.97   0.330     .8950276    1.390588
                            |
                    diabcat |
       Controlled diabetes  |   1.727267   .1928826     4.89   0.000     1.387735    2.149872
     Uncontrolled diabetes  |    2.66102   .3694787     7.05   0.000     2.027029    3.493303
Diabetes, no hba1c measure  |   2.214069   1.292583     1.36   0.173     .7051088    6.952264
                            |
              1.cancer_ever |   1.438399   .1657127     3.16   0.002     1.147666    1.802782
                   1.statin |   .8522579    .086325    -1.58   0.114     .6988003    1.039415
              1.flu_vaccine |   .9313031   .0991818    -0.67   0.504     .7558574    1.147472
     1.pneumococcal_vaccine |   .8221504   .1390954    -1.16   0.247     .5901207    1.145412
            1.exacerbations |   1.294631   .1298146     2.58   0.010      1.06364    1.575786
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.01958         0.19        1         0.6614
      2.exposure  |      0.02149         0.23        1         0.6320
      0b.male     |            .            .        1             .
      1.male      |     -0.09954         5.17        1         0.0230
      age1        |      0.05573         1.11        1         0.2923
      age2        |     -0.07256         1.93        1         0.1648
      age3        |      0.08139         2.48        1         0.1156
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.08925         3.96        1         0.0465
      3.obese4cat |     -0.00475         0.01        1         0.9155
      4.obese4cat |     -0.01745         0.15        1         0.6980
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.01858         0.17        1         0.6818
      3.smoke_no~s|      0.02894         0.44        1         0.5089
      1b.imd      |            .            .        1             .
      2.imd       |      0.04324         0.92        1         0.3380
      3.imd       |      0.00932         0.04        1         0.8368
      4.imd       |      0.01599         0.13        1         0.7228
      5.imd       |      0.00499         0.01        1         0.9117
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.02893         0.45        1         0.5013
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.00009         0.00        1         0.9983
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|      0.02285         0.28        1         0.5981
      0b.other_~se|            .            .        1             .
      1.other_h~se|     -0.05479         1.60        1         0.2058
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.04570         1.02        1         0.3133
      3.diabcat   |     -0.03495         0.65        1         0.4205
      4.diabcat   |      0.02908         0.42        1         0.5167
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.07284         2.77        1         0.0963
      0b.statin   |            .            .        1             .
      1.statin    |      0.01421         0.11        1         0.7443
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.00811         0.03        1         0.8535
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.00845         0.03        1         0.8516
      0b.exacerb~s|            .            .        1             .
      1.exacerba~s|     -0.06365         2.01        1         0.1566
      ------------+---------------------------------------------------
      global test |                     33.68       27         0.1755
      ----------------------------------------------------------------

. local multivar2_p1 = round(r(phtest)[2,4],0.001)

. local multivar2_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) /// 
>                           title ("Schoenfeld residuals against time, fully adjusted `lab1'", position(11) s
> ize(medsmall))                 

.                           
. graph export "$outdir/schoenplot3a.svg", as(svg) replace
(file asthma_output/schoenplot3a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted `lab2'", position(11) s
> ize(medsmall))                 

.                           
. graph export "$outdir/schoenplot3b.svg", as(svg) replace
(file asthma_output/schoenplot3b.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("`lab1'") _tab

. file write tablecontent ("`univar_p1'") _tab ("`multivar1_p1'") _tab ("`multivar2_p1'") _n

. 
. file write tablecontent ("`lab2'") _tab

. file write tablecontent ("`univar_p2'") _tab ("`multivar1_p2'") _tab ("`multivar2_p2'") _n

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\08_an_model_checks_asthma.log
  log type:  text
 closed on:  27 May 2020, 10:57:32
-------------------------------------------------------------------------------------------------------------
