-------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\04_an_descriptive_table_asthma.log
  log type:  text
 opened on:  27 May 2020, 10:38:13

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset, clear

. 
. /* PROGRAMS TO AUTOMATE TABULATIONS===========================================*/ 
. 
. ********************************************************************************
. * All below code from K Baskharan 
. * Generic code to output one row of table
. 
. cap prog drop generaterow

. program define generaterow
  1. syntax, variable(varname) condition(string) 
  2.         
.         cou
  3.         local overalldenom=r(N)
  4.         
.         qui sum `variable' if `variable' `condition'
  5.         file write tablecontent (r(max)) _tab
  6.         
.         cou if `variable' `condition'
  7.         local rowdenom = r(N)
  8.         local colpct = 100*(r(N)/`overalldenom')
  9.         file write tablecontent %9.0gc (`rowdenom')  (" (") %3.1f (`colpct') (")") _tab
 10. 
.         cou if exposure == 0 
 11.         local rowdenom = r(N)
 12.         cou if exposure == 0 & `variable' `condition'
 13.         local pct = 100*(r(N)/`rowdenom') 
 14.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _tab
 15. 
.         cou if exposure == 1 
 16.         local rowdenom = r(N)
 17.         cou if exposure == 1 & `variable' `condition'
 18.         local pct = 100*(r(N)/`rowdenom')
 19.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 20. 
.         cou if exposure == 2
 21.         local rowdenom = r(N)
 22.         cou if exposure == 2 & `variable' `condition'
 23.         local pct = 100*(r(N)/`rowdenom')
 24.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 25. 
.         cou if exposure >= .
 26.         local rowdenom = r(N)
 27.         cou if exposure >= . & `variable' `condition'
 28.         local pct = 100*(r(N)/`rowdenom')
 29.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _n
 30.         
. end

. 
. /* Explanatory Notes 
> 
> defines a program (SAS macro/R function equivalent), generate row
> the syntax row specifies two inputs for the program: 
> 
>         a VARNAME which is your variable 
>         a CONDITION which is a string of some condition you impose 
>         
> the program counts if variable and condition and returns the counts
> column percentages are then automatically generated
> this is then written to the text file 'tablecontent' 
> the number followed by space, brackets, formatted pct, end bracket and then tab
> 
> the format %3.1f specifies length of 3, followed by 1 dp. 
> 
> */ 
. 
. ********************************************************************************
. * Generic code to output one section (varible) within table (calls above)
. 
. cap prog drop tabulatevariable

. prog define tabulatevariable
  1. syntax, variable(varname) min(real) max(real) [missing]
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4. 
.         forvalues varlevel = `min'/`max'{ 
  5.                 generaterow, variable(`variable') condition("==`varlevel'")
  6.         }
  7.         
.         if "`missing'"!="" generaterow, variable(`variable') condition(">=.")
  8. 
. end

. 
. ********************************************************************************
. 
. /* Explanatory Notes 
> 
> defines program tabulate variable 
> syntax is : 
> 
>         - a VARNAME which you stick in variable 
>         - a numeric minimum 
>         - a numeric maximum 
>         - optional missing option, default value is . 
> 
> forvalues lowest to highest of the variable, manually set for each var
> run the generate row program for the level of the variable 
> if there is a missing specified, then run the generate row for missing vals
> 
> */ 
. 
. ********************************************************************************
. * Generic code to summarize a continous variable 
. 
. cap prog drop summarizevariable 

. prog define summarizevariable
  1. syntax, variable(varname) 
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4.         
.         qui summarize `variable', d
  5.         file write tablecontent ("Median (IQR)") _tab 
  6.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  7.                                                         
.         qui summarize `variable' if exposure == 0, d
  8.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  9. 
.         qui summarize `variable' if exposure == 1, d
 10.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 11.         
.         qui summarize `variable' if exposure == 2, d
 12.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 13. 
.         qui summarize `variable' if exposure >= ., d
 14.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _n
 15.         
.         qui summarize `variable', d
 16.         file write tablecontent ("Min, Max") _tab 
 17.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 18.                                                         
.         qui summarize `variable' if exposure == 0, d
 19.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 20. 
.         qui summarize `variable' if exposure == 1, d
 21.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 22.         
.         qui summarize `variable' if exposure == 2, d
 23.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 24. 
.         qui summarize `variable' if exposure >= ., d
 25.         file write tablecontent (r(min)) (", ") (r(max)) ("") _n
 26.         
. end

. 
. 
. /* INVOKE PROGRAMS FOR TABLE 1================================================*/ 
. 
. *Set up output file
. cap file close tablecontent

. file open tablecontent using ./$outdir/table1.txt, write text replace

. 
. file write tablecontent ("Table 1: Demographic and Clinical Characteristics - $population") _n

. 
. * Exposure labelled columns
. 
. local lab0: label exposure 0

. local lab1: label exposure 1

. local lab2: label exposure 2

. local labu: label exposure .u

. 
. 
. file write tablecontent _tab ("Total")                                                    _tab ///
>                                                          ("`lab0'")                                        
>            _tab ///
>                                                          ("`lab1'")                                        
>        _tab ///
>                                                          ("`lab2'")                                        
>                _tab ///
>                                                          ("`labu'")                                        
>                _n 

. 
. * DEMOGRAPHICS (more than one level, potentially missing) 
. 
. gen byte cons=1

. tabulatevariable, variable(cons) min(1) max(1) 
  1,285,438
  1,285,438
  108,419
  108,419
  608,737
  608,737
  101,044
  101,044
  467,238
  467,238

. file write tablecontent _n 

. 
. tabulatevariable, variable(agegroup) min(1) max(6) 
  1,285,438
  417,391
  108,419
  36,243
  608,737
  144,935
  101,044
  18,819
  467,238
  217,394
  1,285,438
  235,446
  108,419
  22,071
  608,737
  107,819
  101,044
  18,458
  467,238
  87,098
  1,285,438
  253,196
  108,419
  21,855
  608,737
  130,372
  101,044
  23,750
  467,238
  77,219
  1,285,438
  181,904
  108,419
  13,968
  608,737
  105,846
  101,044
  18,962
  467,238
  43,128
  1,285,438
  130,588
  108,419
  9,206
  608,737
  79,752
  101,044
  13,897
  467,238
  27,733
  1,285,438
  66,913
  108,419
  5,076
  608,737
  40,013
  101,044
  7,158
  467,238
  14,666

. file write tablecontent _n 

. 
. tabulatevariable, variable(male) min(0) max(1) 
  1,285,438
  750,273
  108,419
  61,812
  608,737
  363,365
  101,044
  62,466
  467,238
  262,630
  1,285,438
  535,165
  108,419
  46,607
  608,737
  245,372
  101,044
  38,578
  467,238
  204,608

. file write tablecontent _n 

. 
. tabulatevariable, variable(bmicat) min(1) max(6) missing
  1,285,438
  19,138
  108,419
  1,637
  608,737
  7,616
  101,044
  1,150
  467,238
  8,735
  1,285,438
  340,655
  108,419
  28,138
  608,737
  152,984
  101,044
  20,944
  467,238
  138,589
  1,285,438
  394,734
  108,419
  32,877
  608,737
  196,505
  101,044
  30,761
  467,238
  134,591
  1,285,438
  239,269
  108,419
  20,063
  608,737
  122,130
  101,044
  22,291
  467,238
  74,785
  1,285,438
  112,067
  108,419
  9,495
  608,737
  56,836
  101,044
  11,883
  467,238
  33,853
  1,285,438
  67,788
  108,419
  5,930
  608,737
  34,092
  101,044
  8,245
  467,238
  19,521
  1,285,438
  111,787
  108,419
  10,279
  608,737
  38,574
  101,044
  5,770
  467,238
  57,164

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke) min(1) max(3) missing 
  1,285,438
  589,884
  108,419
  45,378
  608,737
  268,806
  101,044
  41,216
  467,238
  234,484
  1,285,438
  498,030
  108,419
  42,263
  608,737
  254,242
  101,044
  44,127
  467,238
  157,398
  1,285,438
  195,410
  108,419
  20,621
  608,737
  85,387
  101,044
  15,657
  467,238
  73,745
  1,285,438
  2,114
  108,419
  157
  608,737
  302
  101,044
  44
  467,238
  1,611

. file write tablecontent _n 

. 
. tabulatevariable, variable(ethnicity) min(1) max(5) missing 
  1,285,438
  882,905
  108,419
  74,335
  608,737
  427,840
  101,044
  71,260
  467,238
  309,470
  1,285,438
  12,974
  108,419
  977
  608,737
  5,028
  101,044
  848
  467,238
  6,121
  1,285,438
  72,145
  108,419
  5,708
  608,737
  32,365
  101,044
  5,865
  467,238
  28,207
  1,285,438
  20,507
  108,419
  1,548
  608,737
  8,145
  101,044
  1,456
  467,238
  9,358
  1,285,438
  12,178
  108,419
  890
  608,737
  4,859
  101,044
  878
  467,238
  5,551
  1,285,438
  284,729
  108,419
  24,961
  608,737
  130,500
  101,044
  20,737
  467,238
  108,531

. file write tablecontent _n 

. 
. tabulatevariable, variable(imd) min(1) max(5) missing
  1,285,438
  260,614
  108,419
  21,105
  608,737
  124,439
  101,044
  17,785
  467,238
  97,285
  1,285,438
  261,476
  108,419
  21,694
  608,737
  124,188
  101,044
  18,951
  467,238
  96,643
  1,285,438
  258,473
  108,419
  22,006
  608,737
  121,848
  101,044
  20,191
  467,238
  94,428
  1,285,438
  258,291
  108,419
  22,362
  608,737
  121,025
  101,044
  21,469
  467,238
  93,435
  1,285,438
  246,584
  108,419
  21,252
  608,737
  117,237
  101,044
  22,648
  467,238
  85,447
  1,285,438
  0
  108,419
  0
  608,737
  0
  101,044
  0
  467,238
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(diabcat) min(1) max(4) missing
  1,285,438
  1,126,588
  108,419
  93,581
  608,737
  523,732
  101,044
  83,053
  467,238
  426,222
  1,285,438
  105,765
  108,419
  8,934
  608,737
  57,792
  101,044
  12,233
  467,238
  26,806
  1,285,438
  48,871
  108,419
  5,549
  608,737
  25,272
  101,044
  5,437
  467,238
  12,613
  1,285,438
  4,214
  108,419
  355
  608,737
  1,941
  101,044
  321
  467,238
  1,597
  1,285,438
  0
  108,419
  0
  608,737
  0
  101,044
  0
  467,238
  0

. file write tablecontent _n 

. 
. file write tablecontent _n _n

. 
. ** COPD TREATMENT VARIABLES (binary)
. foreach treat of varlist        saba_single             ///
>                                                         high_dose_ics           ///
>                                                         low_med_dose_ics        ///
>                                                         ics_single              ///
>                                                         sama_single             ///
>                                                         laba_single                     ///
>                                                         lama_single                     ///
>                                                         laba_ics                        ///
>                                                         laba_lama                       ///
>                                                         laba_lama_ics           ///
>                             ltra_single                 ///     
>                                                 {               
  2. 
. local lab: variable label `treat'
  3. file write tablecontent ("`lab'") _n 
  4.         
. generaterow, variable(`treat') condition("==0")
  5. generaterow, variable(`treat') condition("==1")
  6. 
. file write tablecontent _n
  7. 
. }
  1,285,438
  679,429
  108,419
  0
  608,737
  191,824
  101,044
  22,843
  467,238
  464,762
  1,285,438
  606,009
  108,419
  108,419
  608,737
  416,913
  101,044
  78,201
  467,238
  2,476
  1,285,438
  1,181,477
  108,419
  108,419
  608,737
  605,820
  101,044
  0
  467,238
  467,238
  1,285,438
  103,961
  108,419
  0
  608,737
  2,917
  101,044
  101,044
  467,238
  0
  1,285,438
  669,156
  108,419
  108,419
  608,737
  0
  101,044
  93,499
  467,238
  467,238
  1,285,438
  616,282
  108,419
  0
  608,737
  608,737
  101,044
  7,545
  467,238
  0
  1,285,438
  994,629
  108,419
  108,419
  608,737
  327,993
  101,044
  90,979
  467,238
  467,238
  1,285,438
  290,809
  108,419
  0
  608,737
  280,744
  101,044
  10,065
  467,238
  0
  1,285,438
  1,282,617
  108,419
  108,303
  608,737
  607,108
  101,044
  100,147
  467,238
  467,059
  1,285,438
  2,821
  108,419
  116
  608,737
  1,629
  101,044
  897
  467,238
  179
  1,285,438
  1,276,923
  108,419
  107,876
  608,737
  602,780
  101,044
  99,543
  467,238
  466,724
  1,285,438
  8,515
  108,419
  543
  608,737
  5,957
  101,044
  1,501
  467,238
  514
  1,285,438
  1,269,050
  108,419
  108,419
  608,737
  600,692
  101,044
  92,701
  467,238
  467,238
  1,285,438
  16,388
  108,419
  0
  608,737
  8,045
  101,044
  8,343
  467,238
  0
  1,285,438
  853,929
  108,419
  108,419
  608,737
  270,670
  101,044
  7,602
  467,238
  467,238
  1,285,438
  431,509
  108,419
  0
  608,737
  338,067
  101,044
  93,442
  467,238
  0
  1,285,438
  1,285,078
  108,419
  108,419
  608,737
  608,498
  101,044
  100,923
  467,238
  467,238
  1,285,438
  360
  108,419
  0
  608,737
  239
  101,044
  121
  467,238
  0
  1,285,438
  1,284,166
  108,419
  108,419
  608,737
  607,551
  101,044
  100,958
  467,238
  467,238
  1,285,438
  1,272
  108,419
  0
  608,737
  1,186
  101,044
  86
  467,238
  0
  1,285,438
  1,215,578
  108,419
  108,419
  608,737
  568,259
  101,044
  77,995
  467,238
  460,905
  1,285,438
  69,860
  108,419
  0
  608,737
  40,478
  101,044
  23,049
  467,238
  6,333

. 
. ** COMORBIDITIES (categorical and continous)
. 
. ** COMORBIDITIES (binary)
. 
. foreach comorb of varlist       asthma_ever                                             ///
>                                                         ckd                                                
>              ///
>                                                         copd                                               
>      ///
>                                                         hypertension                                    ///
>                                                         heart_failure                                   ///
>                                                         other_heart_disease                             ///
>                                                         diabetes                                           
>      ///
>                                                         cancer_ever                                     ///
>                                                         immunodef_any                                   ///
>                                                         other_respiratory                               ///
>                                                         statin                                             
>      ///
>                                                         insulin                                            
>      ///
>                                                         oral_steroids                                   ///
>                                                         flu_vaccine                                     ///
>                                                         pneumococcal_vaccine                    ///
>                                                         exacerbations                                   ///
>                                                         gp_consult {
  2. 
. local lab: variable label `comorb'
  3. file write tablecontent ("`lab'") _n 
  4.                                                         
. generaterow, variable(`comorb') condition("==0")
  5. generaterow, variable(`comorb') condition("==1")
  6. file write tablecontent _n
  7. 
. }
  1,285,438
  0
  108,419
  0
  608,737
  0
  101,044
  0
  467,238
  0
  1,285,438
  1,285,438
  108,419
  108,419
  608,737
  608,737
  101,044
  101,044
  467,238
  467,238
  1,285,438
  1,224,184
  108,419
  103,325
  608,737
  573,314
  101,044
  93,989
  467,238
  453,556
  1,285,438
  61,254
  108,419
  5,094
  608,737
  35,423
  101,044
  7,055
  467,238
  13,682
  1,285,438
  1,285,438
  108,419
  108,419
  608,737
  608,737
  101,044
  101,044
  467,238
  467,238
  1,285,438
  0
  108,419
  0
  608,737
  0
  101,044
  0
  467,238
  0
  1,285,438
  977,386
  108,419
  82,602
  608,737
  432,422
  101,044
  67,210
  467,238
  395,152
  1,285,438
  308,052
  108,419
  25,817
  608,737
  176,315
  101,044
  33,834
  467,238
  72,086
  1,285,438
  1,263,065
  108,419
  106,442
  608,737
  596,175
  101,044
  98,056
  467,238
  462,392
  1,285,438
  22,373
  108,419
  1,977
  608,737
  12,562
  101,044
  2,988
  467,238
  4,846
  1,285,438
  1,206,423
  108,419
  101,534
  608,737
  564,867
  101,044
  91,904
  467,238
  448,118
  1,285,438
  79,015
  108,419
  6,885
  608,737
  43,870
  101,044
  9,140
  467,238
  19,120
  1,285,438
  1,126,588
  108,419
  93,581
  608,737
  523,732
  101,044
  83,053
  467,238
  426,222
  1,285,438
  158,850
  108,419
  14,838
  608,737
  85,005
  101,044
  17,991
  467,238
  41,016
  1,285,438
  1,218,096
  108,419
  102,722
  608,737
  571,205
  101,044
  94,298
  467,238
  449,871
  1,285,438
  67,342
  108,419
  5,697
  608,737
  37,532
  101,044
  6,746
  467,238
  17,367
  1,285,438
  1,260,834
  108,419
  106,150
  608,737
  598,531
  101,044
  99,415
  467,238
  456,738
  1,285,438
  24,604
  108,419
  2,269
  608,737
  10,206
  101,044
  1,629
  467,238
  10,500
  1,285,438
  1,285,438
  108,419
  108,419
  608,737
  608,737
  101,044
  101,044
  467,238
  467,238
  1,285,438
  0
  108,419
  0
  608,737
  0
  101,044
  0
  467,238
  0
  1,285,438
  1,064,378
  108,419
  90,316
  608,737
  475,767
  101,044
  74,825
  467,238
  423,470
  1,285,438
  221,060
  108,419
  18,103
  608,737
  132,970
  101,044
  26,219
  467,238
  43,768
  1,285,438
  1,262,629
  108,419
  105,740
  608,737
  597,050
  101,044
  98,402
  467,238
  461,437
  1,285,438
  22,809
  108,419
  2,679
  608,737
  11,687
  101,044
  2,642
  467,238
  5,801
  1,285,438
  1,171,904
  108,419
  99,286
  608,737
  538,017
  101,044
  78,491
  467,238
  456,110
  1,285,438
  113,534
  108,419
  9,133
  608,737
  70,720
  101,044
  22,553
  467,238
  11,128
  1,285,438
  719,150
  108,419
  68,942
  608,737
  270,917
  101,044
  41,729
  467,238
  337,562
  1,285,438
  566,288
  108,419
  39,477
  608,737
  337,820
  101,044
  59,315
  467,238
  129,676
  1,285,438
  1,197,757
  108,419
  101,965
  608,737
  558,613
  101,044
  91,294
  467,238
  445,885
  1,285,438
  87,681
  108,419
  6,454
  608,737
  50,124
  101,044
  9,750
  467,238
  21,353
  1,285,438
  1,076,191
  108,419
  93,206
  608,737
  487,066
  101,044
  64,328
  467,238
  431,591
  1,285,438
  209,247
  108,419
  15,213
  608,737
  121,671
  101,044
  36,716
  467,238
  35,647
  1,285,438
  90,530
  108,419
  5,833
  608,737
  19,830
  101,044
  2,217
  467,238
  62,650
  1,285,438
  1,194,908
  108,419
  102,586
  608,737
  588,907
  101,044
  98,827
  467,238
  404,588

. 
. * COMORBIDITIES (continous)
. 
. summarizevariable, variable(gp_consult_count)

. summarizevariable, variable(exacerbation_count)

. 
. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\04_an_descriptive_table_asthma.log
  log type:  text
 closed on:  27 May 2020, 10:38:54
-------------------------------------------------------------------------------------------------------------
