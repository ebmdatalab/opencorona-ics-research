--------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\00_cr_create_analysis_dataset.log
  log type:  text
 opened on:  18 May 2020, 09:51:13

. 
. /* SET FU DATES===============================================================*/ 
. * Censoring dates for each outcome (largely, last date outcome data available)
. 
. global ituadmissioncensor       = "20/04/2020"

. global cpnsdeathcensor          = "25/04/2020"

. global onscoviddeathcensor      = "06/04/2020"

. global indexdate                        = "01/03/2020"

. 
. /* RENAME VARAIBLES===========================================================*/
. 
. rename bmi_date_measured                                bmi_date_measured
  (all newnames==oldnames)

. rename bp_dias_date_measured                            bp_dias_date

. rename bp_sys_date_measured                                     bp_sys_date

. 
. /* CONVERT STRINGS TO DATE====================================================*/
. /* Comorb dates are given with month only, so adding day 15 to enable
>    them to be processed as dates                                                                      
>                     */
. 
. //                                              asthma                                          ///
. 
. foreach var of varlist  aplastic_anaemia                                ///
>                                                 bmi_date_measured                               ///
>                                                 copd                                            ///
>                                                 creatinine_date                                 ///
>                                                 diabetes                                        ///
>                                                 flu_vaccine                                           
>   ///
>                                                 haem_cancer                                     ///
>                                                 heart_failure                                   ///
>                                                 hiv                                             ///
>                                                 hypertension                                    ///
>                                                 esrf                                                  
>   ///
>                                                 ili                                             ///
>                                                 lung_cancer                                     ///
>                                                 other_cancer                                    ///
>                                                 other_heart_disease                             ///
>                                                 other_respiratory                               ///
>                                                 permanent_immunodeficiency      ///
>                                                 pneumococcal_vaccine                    ///
>                                                 smoking_status_date                             ///
>                                                 temporary_immunodeficiency      ///
>                                                 insulin                                               
>   ///
>                                                 statin                                                
>   ///
>                                                 ics_single                      ///
>                                                 low_med_dose_ics                                ///
>                                                 high_dose_ics                                   ///
>                                                 saba_single                     ///
>                                                 sama_single                     ///
>                                                 laba_single                     ///
>                                                 lama_single                     ///
>                                                 laba_ics                            ///
>                                                 laba_lama                           ///
>                                                 laba_lama_ics                                   ///
>                                                 oral_steroids                                   ///
>                         ltra_single {
  2.                                                         
.                 capture confirm string variable `var'
  3.                 if _rc!=0 {
  4.                         assert `var'==.
  5.                         rename `var' `var'_date
  6.                 }
  7.         
.                 else {
  8.                                 replace `var' = `var' + "-15"
  9.                                 rename `var' `var'_dstr
 10.                                 replace `var'_dstr = " " if `var'_dstr == "-15"
 11.                                 gen `var'_date = date(`var'_dstr, "YMD") 
 12.                                 order `var'_date, after(`var'_dstr)
 13.                                 drop `var'_dstr
 14.                 }
 15.         
.         format `var'_date %td
 16. }
variable aplastic_anaemia was str7 now str10
(1,348,183 real changes made)
(1,348,028 real changes made)
(1,348,028 missing values generated)
variable bmi_date_measured was str7 now str10
(1,348,183 real changes made)
(85,802 real changes made)
(85,802 missing values generated)
variable copd was str7 now str10
(1,348,183 real changes made)
(1,317,278 real changes made)
(1,317,278 missing values generated)
variable creatinine_date was str7 now str10
(1,348,183 real changes made)
(201,365 real changes made)
(201,365 missing values generated)
variable diabetes was str7 now str10
(1,348,183 real changes made)
(1,175,740 real changes made)
(1,175,740 missing values generated)
variable flu_vaccine was str7 now str10
(1,348,183 real changes made)
(1,315,051 real changes made)
(1,315,051 missing values generated)
variable haem_cancer was str7 now str10
(1,348,183 real changes made)
(1,340,306 real changes made)
(1,340,306 missing values generated)
variable heart_failure was str7 now str10
(1,348,183 real changes made)
(1,322,334 real changes made)
(1,322,334 missing values generated)
variable hiv was str7 now str10
(1,348,183 real changes made)
(1,324,615 real changes made)
(1,324,615 missing values generated)
variable hypertension was str7 now str10
(1,348,183 real changes made)
(1,014,605 real changes made)
(1,014,605 missing values generated)
variable esrf was str7 now str10
(1,348,183 real changes made)
(1,346,272 real changes made)
(1,346,272 missing values generated)
variable ili was str7 now str10
(1,348,183 real changes made)
(1,175,740 real changes made)
(1,175,740 missing values generated)
variable lung_cancer was str7 now str10
(1,348,183 real changes made)
(1,346,319 real changes made)
(1,346,319 missing values generated)
variable other_cancer was str7 now str10
(1,348,183 real changes made)
(1,282,042 real changes made)
(1,282,042 missing values generated)
variable other_heart_disease was str7 now str10
(1,348,183 real changes made)
(1,260,004 real changes made)
(1,260,004 missing values generated)
variable other_respiratory was str7 now str10
(1,348,183 real changes made)
(1,327,453 real changes made)
(1,327,453 missing values generated)
variable permanent_immunodeficiency was str7 now str10
(1,348,183 real changes made)
(1,346,388 real changes made)
(1,346,388 missing values generated)
variable pneumococcal_vaccine was str7 now str10
(1,348,183 real changes made)
(1,334,226 real changes made)
(1,334,226 missing values generated)
variable smoking_status_date was str7 now str10
(1,348,183 real changes made)
(2,181 real changes made)
(2,181 missing values generated)
variable temporary_immunodeficiency was str7 now str10
(1,348,183 real changes made)
(1,343,874 real changes made)
(1,343,874 missing values generated)
variable insulin was str7 now str10
(1,348,183 real changes made)
(1,323,594 real changes made)
(1,323,594 missing values generated)
variable statin was str7 now str10
(1,348,183 real changes made)
(1,107,831 real changes made)
(1,107,831 missing values generated)
variable ics_single was str7 now str10
(1,348,183 real changes made)
(1,045,595 real changes made)
(1,045,595 missing values generated)
variable low_med_dose_ics was str7 now str10
(1,348,183 real changes made)
(699,197 real changes made)
(699,197 missing values generated)
variable high_dose_ics was str7 now str10
(1,348,183 real changes made)
(1,234,549 real changes made)
(1,234,549 missing values generated)
variable saba_single was str7 now str10
(1,348,183 real changes made)
(707,552 real changes made)
(707,552 missing values generated)
variable sama_single was str7 now str10
(1,348,183 real changes made)
(1,344,858 real changes made)
(1,344,858 missing values generated)
variable laba_single was str7 now str10
(1,348,183 real changes made)
(1,338,967 real changes made)
(1,338,967 missing values generated)
variable lama_single was str7 now str10
(1,348,183 real changes made)
(1,326,856 real changes made)
(1,326,856 missing values generated)
variable laba_ics was str7 now str10
(1,348,183 real changes made)
(886,375 real changes made)
(886,375 missing values generated)
variable laba_lama was str7 now str10
(1,348,183 real changes made)
(1,347,324 real changes made)
(1,347,324 missing values generated)
variable laba_lama_ics was str7 now str10
(1,348,183 real changes made)
(1,346,605 real changes made)
(1,346,605 missing values generated)
variable oral_steroids was str7 now str10
(1,348,183 real changes made)
(1,225,200 real changes made)
(1,225,200 missing values generated)
variable ltra_single was str7 now str10
(1,348,183 real changes made)
(1,272,145 real changes made)
(1,272,145 missing values generated)

. 
. * Note - outcome dates are handled separtely below 
. 
. /* RENAME VARAIBLES===========================================================*/
. *  An extra 'date' added to the end of some variable names, remove 
. 
. rename creatinine_date_date             creatinine_measured_date

. rename smoking_status_date_date         smoking_status_measured_date

. rename bmi_date_measured_date           bmi_measured_date

. 
. * Some names too long for loops below, shorten
. 
. rename permanent_immunodeficiency_date perm_immunodef_date

. rename temporary_immunodeficiency_date temp_immunodef_date

. 
. /* CREATE BINARY VARIABLES====================================================*/
. *  Remove dates occuring after the index date
. *  Make variables for all conditions occuring before index
. 
. //                                              asthma                                          ///
. 
. foreach var of varlist  aplastic_anaemia_date                           ///
>                                                 bmi_measured_date                                     
>   ///
>                                                 copd_date                                       ///
>                                                 creatinine_measured_date                        ///
>                                                 diabetes_date                                   ///
>                                                 haem_cancer_date                                ///
>                                                 heart_failure_date                                    
>   ///
>                                                 hiv_date                                        ///
>                                                 hypertension_date                               ///
>                                                 esrf_date                                             
>           ///
>                                                 flu_vaccine_date                                      
>   ///
>                                                 ili_date                                        ///
>                                                 lung_cancer_date                                ///
>                                                 other_cancer_date                               ///
>                                                 other_heart_disease_date                        ///
>                                                 other_respiratory_date                          ///
>                                                 perm_immunodef_date                             ///
>                                                 pneumococcal_vaccine_date                       ///
>                                                 smoking_status_measured_date            ///
>                                                 temp_immunodef_date                             ///
>                                                 insulin_date                                          
>   ///
>                                                 statin_date                                           
>   ///
>                                                 ics_single_date                     ///
>                                                 low_med_dose_ics_date                           ///
>                                                 high_dose_ics_date                                    
>   ///
>                                                 saba_single_date                    ///
>                                                 sama_single_date                    ///
>                                                 laba_single_date                    ///
>                                                 lama_single_date                    ///
>                                                 laba_ics_date                       ///
>                                                 laba_lama_date                      ///
>                                                 laba_lama_ics_date                                    
>   ///
>                                                 oral_steroids_date                                    
>   ///
>                         ltra_single_date {
  2.         
.         replace `var' = . if (`var' >= date("$indexdate", "DMY"))
  3.         local newvar =  substr("`var'", 1, length("`var'") - 5)
  4.         gen `newvar' = (`var'< date("$indexdate", "DMY"))
  5.         order `newvar', after(`var')
  6.         
. }
(3 real changes made, 3 to missing)
(61,815 real changes made, 61,815 to missing)
(1,090 real changes made, 1,090 to missing)
(9 real changes made, 9 to missing)
(1,560 real changes made, 1,560 to missing)
(111 real changes made, 111 to missing)
(477 real changes made, 477 to missing)
(96 real changes made, 96 to missing)
(1,786 real changes made, 1,786 to missing)
(53 real changes made, 53 to missing)
(0 real changes made)
(1,560 real changes made, 1,560 to missing)
(77 real changes made, 77 to missing)
(846 real changes made, 846 to missing)
(698 real changes made, 698 to missing)
(395 real changes made, 395 to missing)
(20 real changes made, 20 to missing)
(0 real changes made)
(12 real changes made, 12 to missing)
(164 real changes made, 164 to missing)
(0 real changes made)
(0 real changes made)
(2 real changes made, 2 to missing)
(2 real changes made, 2 to missing)
(0 real changes made)
(3 real changes made, 3 to missing)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1 real change made, 1 to missing)
(0 real changes made)

. 
. /* 
>         Potential checks: 
>         Confirm each covariate is defined before the index date
>     Confirm each coviariate is defined using date occurring in the past 50 years 
> 
> */ 
. 
. /* CREATE VARIABLES===========================================================*/
. 
. /* DEMOGRAPHICS */ 
. 
. * Sex
. gen male = 1 if sex == "M"
(787,445 missing values generated)

. replace male = 0 if sex == "F"
(787,413 real changes made)

. 
. * Ethnicity 
. replace ethnicity = .u if ethnicity == .
(297,944 real changes made, 297,944 to missing)

. 
. label define ethnicity  1 "White"                                       ///
>                                                 2 "Mixed"                                       ///
>                                                 3 "Asian or Asian British"      ///
>                                                 4 "Black"                                       ///
>                                                 5 "Other"                                       ///
>                                                 .u "Unknown"

. 
. label values ethnicity ethnicity

. 
. * STP 
. rename stp stp_old

. bysort stp_old: gen stp = 1 if _n==1
(1,348,151 missing values generated)

. replace stp = sum(stp)
(1,348,182 real changes made)

. drop stp_old

. 
. /*  IMD  */
. * Group into 5 groups
. rename imd imd_o

. egen imd = cut(imd_o), group(5) icodes

. 
. * add one to create groups 1 - 5 
. replace imd = imd + 1
(1,348,183 real changes made)

. 
. * - 1 is missing, should be excluded from population 
. replace imd = .u if imd_o == -1
(12,883 real changes made, 12,883 to missing)

. drop imd_o

. 
. * Reverse the order (so high is more deprived)
. recode imd 5 = 1 4 = 2 3 = 3 2 = 4 1 = 5 .u = .u
(imd: 1067143 changes made)

. 
. label define imd 1 "1 least deprived" 2 "2" 3 "3" 4 "4" 5 "5 most deprived" .u "Unknown"

. label values imd imd 

. 
. /*  Age variables  */ 
. 
. * Create categorised age
. recode age 18/39.9999 = 1 /// 
>            40/49.9999 = 2 ///
>                    50/59.9999 = 3 ///
>                60/69.9999 = 4 ///
>                    70/79.9999 = 5 ///
>                    80/max = 6, gen(agegroup) 
(1348183 differences between age and agegroup)

. 
. label define agegroup   1 "18-<40" ///
>                                                 2 "40-<50" ///
>                                                 3 "50-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

.                                                 
. label values agegroup agegroup

. 
. * Create binary age
. recode age min/69.999 = 0 ///
>            70/max = 1, gen(age70)
(1348183 differences between age and age70)

. 
. * Check there are no missing ages
. assert age < .

. assert agegroup < .

. assert age70 < .

. 
. * Create restricted cubic splines fir age
. mkspline age = age, cubic nknots(4)

. 
. /*  Body Mass Index  */
. * NB: watch for missingness
. 
. * Recode strange values 
. summarize bmi, d

                             bmi
-------------------------------------------------------------
      Percentiles      Smallest
 1%            0             -1
 5%            0             -1
10%         19.4             -1       Obs           1,348,183
25%         23.3             -1       Sum of Wgt.   1,348,183

50%         27.2                      Mean           51.88291
                        Largest       Std. Dev.      3013.189
75%         31.9         762000
90%         37.3         816000       Variance        9079307
95%         41.2         900000       Skewness        159.074
99%         50.2         960000       Kurtosis       32379.15

. replace bmi = . if bmi == 0 
(90,066 real changes made, 90,066 to missing)

. replace bmi = . if !inrange(bmi, 15, 50)
(17,625 real changes made, 17,625 to missing)

. 
. * Restrict to within 10 years of index and aged > 16 
. gen bmi_time = (date("$indexdate", "DMY") - bmi_measured_date)/365.25
(147,617 missing values generated)

. gen bmi_age = round(age - bmi_time, 0)
(147,617 missing values generated)

. 
. replace bmi = . if bmi_age < 16 
(6,076 real changes made, 6,076 to missing)

. replace bmi = . if bmi_time > 10 
(60,283 real changes made, 60,283 to missing)

. 
. * Set to missing if no date, and vice versa 
. replace bmi = . if bmi_measured_date == . 
(0 real changes made)

. replace bmi_measured_date = . if bmi == . 
(26,433 real changes made, 26,433 to missing)

. replace bmi_measured_date = . if bmi == . 
(0 real changes made)

. 
. gen     bmicat = .
(1,348,183 missing values generated)

. recode  bmicat . = 1 if bmi < 18.5
(bmicat: 19374 changes made)

. recode  bmicat . = 2 if bmi < 25
(bmicat: 343261 changes made)

. recode  bmicat . = 3 if bmi < 30
(bmicat: 396878 changes made)

. recode  bmicat . = 4 if bmi < 35
(bmicat: 238322 changes made)

. recode  bmicat . = 5 if bmi < 40
(bmicat: 110274 changes made)

. recode  bmicat . = 6 if bmi < .
(bmicat: 66024 changes made)

. replace bmicat = .u if bmi >= .
(174,050 real changes made, 174,050 to missing)

. 
. label define bmicat 1 "Underweight (<18.5)"     ///
>                                         2 "Normal (18.5-24.9)"          ///
>                                         3 "Overweight (25-29.9)"        ///
>                                         4 "Obese I (30-34.9)"           ///
>                                         5 "Obese II (35-39.9)"          ///
>                                         6 "Obese III (40+)"                     ///
>                                         .u "Unknown (.u)"

.                                         
. label values bmicat bmicat

. 
. * Create less  granular categorisation
. recode bmicat 1/3 .u = 1 4 = 2 5 = 3 6 = 4, gen(obese4cat)
(1328809 differences between bmicat and obese4cat)

. 
. label define obese4cat  1 "No record of obesity"        ///
>                                                 2 "Obese I (30-34.9)"           ///
>                                                 3 "Obese II (35-39.9)"          ///
>                                                 4 "Obese III (40+)"             

. 
. label values obese4cat obese4cat

. order obese4cat, after(bmicat)

. 
. /*  Smoking  */
. 
. * Smoking 
. label define smoke 1 "Never" 2 "Former" 3 "Current" .u "Unknown (.u)"

. 
. gen     smoke = 1  if smoking_status == "N"
(733,821 missing values generated)

. replace smoke = 2  if smoking_status == "E"
(527,742 real changes made)

. replace smoke = 3  if smoking_status == "S"
(203,898 real changes made)

. replace smoke = .u if smoking_status == "M"
(2,181 real changes made, 2,181 to missing)

. replace smoke = .u if smoking_status == "" 
(0 real changes made)

. 
. label values smoke smoke

. drop smoking_status

. 
. * Create non-missing 3-category variable for current smoking
. * Assumes missing smoking is never smoking 
. recode smoke .u = 1, gen(smoke_nomiss)
(2181 differences between smoke and smoke_nomiss)

. order smoke_nomiss, after(smoke)

. label values smoke_nomiss smoke

. 
. /* CLINICAL COMORBIDITIES */ 
. 
. /* Exacerbation */ 
. /* Commented out until in both datasets 
> replace exacerbation_count = 0 if exacerbation_count <1 
> 
> * those with no count assumed to have no visits 
> replace exacerbation_count = 0 if exacerbation_count == . 
> gen exacerbation = (exacerbation_count >= 1)
> 
> */ 
. 
. /* GP consultation rate */ 
. replace gp_consult_count = 0 if gp_consult_count <1 
(0 real changes made)

. 
. * those with no count assumed to have no visits 
. replace gp_consult_count = 0 if gp_consult_count == . 
(0 real changes made)

. gen gp_consult = (gp_consult_count >=1)

. 
. /*  Cancer  */
. 
. gen cancer_ever =   (haem_cancer == 1 | /// 
>                      lung_cancer == 1 | /// 
>                                          other_cancer ==1)              

.                                          
. gen cancer_ever_date = max(haem_cancer_date, lung_cancer_date, other_cancer_date)
(1,275,147 missing values generated)

. 
. /*  Immunosuppression  */
. 
. * Immunosuppressed:
. * HIV, permanent immunodeficiency ever, OR 
. * temporary immunodeficiency or aplastic anaemia last year
. gen temp1  = max(hiv, perm_immunodef)

. gen temp2  = inrange(temp_immunodef_date, (date("$indexdate", "DMY") - 365), date("$indexdate", "DMY")
> )

. gen temp3  = inrange(aplastic_anaemia_date, (date("$indexdate", "DMY") - 365), date("$indexdate", "DMY
> "))

. 
. egen immunodef_any = rowmax(temp1 temp2 temp3)

. drop temp1 temp2 temp3

. order immunodef_any, after(temp_immunodef_date)

. 
. /* eGFR */
. 
. * Set implausible creatinine values to missing (Note: zero changed to missing)
. replace creatinine = . if !inrange(creatinine, 20, 3000) 
(204,256 real changes made, 204,256 to missing)

. 
. * Remove creatinine dates if no measurements, and vice versa 
. 
. replace creatinine = . if creatinine_measured_date == . 
(9 real changes made, 9 to missing)

. replace creatinine_measured_date = . if creatinine == . 
(2,891 real changes made, 2,891 to missing)

. replace creatinine_measured = . if creatinine == . 
(204,265 real changes made, 204,265 to missing)

. 
. * Divide by 88.4 (to convert umol/l to mg/dl)
. gen SCr_adj = creatinine/88.4
(204,265 missing values generated)

. 
. gen min = .
(1,348,183 missing values generated)

. replace min = SCr_adj/0.7 if male==0
(703,154 real changes made)

. replace min = SCr_adj/0.9 if male==1
(440,739 real changes made)

. replace min = min^-0.329  if male==0
(703,154 real changes made)

. replace min = min^-0.411  if male==1
(440,739 real changes made)

. replace min = 1 if min<1
(755,318 real changes made)

. 
. gen max=.
(1,348,183 missing values generated)

. replace max=SCr_adj/0.7 if male==0
(703,154 real changes made)

. replace max=SCr_adj/0.9 if male==1
(440,739 real changes made)

. replace max=max^-1.209
(1,143,893 real changes made)

. replace max=1 if max>1
(592,865 real changes made)

. 
. gen egfr=min*max*141
(204,290 missing values generated)

. replace egfr=egfr*(0.993^age)
(1,143,893 real changes made)

. replace egfr=egfr*1.018 if male==0
(703,154 real changes made)

. label var egfr "egfr calculated using CKD-EPI formula with no eth"

. 
. * Categorise into ckd stages
. egen egfr_cat = cut(egfr), at(0, 15, 30, 45, 60, 5000)
(204290 missing values generated)

. recode egfr_cat 0 = 5 15 = 4 30 = 3 45 = 2 60 = 0, generate(ckd_egfr)
(1143893 differences between egfr_cat and ckd_egfr)

. 
. * 0 = "No CKD"  2 "stage 3a" 3 "stage 3b" 4 "stage 4" 5 "stage 5"
. 
. * Add in end stage renal failure and create a single CKD variable 
. gen ckd = 1 if esrf == 1 
(1,346,325 missing values generated)

. replace ckd = 1 if ckd_egfr != . & ckd_egfr >= 1
(80,085 real changes made)

. replace ckd = 0 if ckd_egfr == . & esrf == 0 
(204,249 real changes made)

. 
. label define ckd 0 "No CKD" 1 "CKD"

. label values ckd ckd

. label var ckd "CKD stage calc without eth"

. 
. * Create date (most recent measure prior to index)
. gen temp1_ckd_date = creatinine_measured_date if ckd_egfr >=1
(1,266,767 missing values generated)

. gen temp2_ckd_date = esrf_date if esrf == 1
(1,346,325 missing values generated)

. gen ckd_date = max(temp1_ckd_date,temp2_ckd_date) 
(1,266,215 missing values generated)

. format ckd_date %td 

. 
. /* OUTCOME AND SURVIVAL TIME==================================================*/
. 
. /*  Cohort entry and censor dates  */
. 
. * Date of cohort entry, 1 Mar 2020
. gen enter_date = date("$indexdate", "DMY")

. 
. * Date of study end (typically: last date of outcome data available)
. **** NOTE!! ITU ADMISSION TO BE REPLACED WITH ECDS OUTCOME 
. gen ituadmissioncensor_date     = date("$ituadmissioncensor",   "DMY") 

. gen cpnsdeathcensor_date                = date("$cpnsdeathcensor",              "DMY")

. gen onscoviddeathcensor_date    = date("$onscoviddeathcensor",  "DMY")

. 
. * Format the dates
. format  enter_date                                      ///
>                 cpnsdeathcensor_date            ///
>                 onscoviddeathcensor_date        ///
>                 ituadmissioncensor_date  %td

. 
. /*   Outcomes   */
. 
. * Dates of: ITU admission, CPNS death, ONS-covid death
. * Recode to dates from the strings 
. foreach var of varlist  died_date_ons           ///
>                                                 died_date_cpns          ///
>                                                 icu_date_admitted  {
  2.                                                 
.         confirm string variable `var'
  3.         rename `var' `var'_dstr
  4.         gen `var' = date(`var'_dstr, "YMD")
  5.         drop `var'_dstr
  6.         format `var' %td 
  7.         
. }
(1,345,724 missing values generated)
(1,347,728 missing values generated)
(1,347,939 missing values generated)

. 
. rename icu_date_admitted itu_date

. 
. * Date of Covid death in ONS
. gen died_date_onscovid = died_date_ons if died_ons_covid_flag_any == 1
(1,347,495 missing values generated)

. 
. format died_date_ons %td

. format died_date_onscovid %td 

. 
. * Binary indicators for outcomes
. gen cpnsdeath           = (died_date_cpns               < .)

. gen onscoviddeath       = (died_date_onscovid   < .)

. gen ituadmission        = (itu_date                     < .)

. 
. /*  Create survival times  */
. 
. * For looping later, name must be stime_binary_outcome_name
. 
. * Survival time = last followup date (first: end study, death, or that outcome)
. gen stime_ituadmission  = min(ituadmissioncensor_date,  itu_date,               died_date_ons)

. gen stime_cpnsdeath     = min(cpnsdeathcensor_date,     died_date_cpns, died_date_ons)

. gen stime_onscoviddeath = min(onscoviddeathcensor_date,                                 died_date_ons)

. 
. * If outcome was after censoring occurred, set to zero
. replace ituadmission    = 0 if (itu_date                        > ituadmissioncensor_date) 
(17 real changes made)

. replace cpnsdeath               = 0 if (died_date_cpns          > cpnsdeathcensor_date) 
(0 real changes made)

. replace onscoviddeath   = 0 if (died_date_onscovid      > onscoviddeathcensor_date) 
(450 real changes made)

. 
. * Format date variables
. format  stime* %td 

. 
. /* LABEL VARIABLES============================================================*/
. *  Label variables you are intending to keep, drop the rest 
. 
. describe, fullname 

Contains data
  obs:     1,348,183                          
 vars:           136                          
--------------------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
--------------------------------------------------------------------------------------------------------
patient_id      long    %12.0g                
died_ons_covid_flag_any
                byte    %8.0g                 
died_ons_covid_flag_underlying
                byte    %8.0g                 
age             int     %8.0g                 
sex             str1    %9s                   
ethnicity       byte    %22.0g     ethnicity
                                              
ethnicity_date  int     %8.0g                 
bmi             float   %9.0g                 
bmi_measured_date
                float   %td                   
bmi_measured    float   %9.0g                 
smoking_status_measured_date
                float   %td                   
smoking_status_measured
                float   %9.0g                 
high_dose_ics_date
                float   %td                   
high_dose_ics   float   %9.0g                 
high_dose_ics_single_ing
                str7    %9s                   
high_dose_ics_multiple_ingredien
                str7    %9s                   high_dose_ics_multiple_ingredient
low_med_dose_ics_single_ingredie
                str7    %9s                   low_med_dose_ics_single_ingredient
low_med_dose_ics_multiple_ingred
                str7    %9s                   low_med_dose_ics_multiple_ingredient
low_med_dose_ics_date
                float   %td                   
low_med_dose_ics
                float   %9.0g                 
ics_single_date float   %td                   
ics_single      float   %9.0g                 
oral_steroids_date
                float   %td                   
oral_steroids   float   %9.0g                 
saba_single_date
                float   %td                   
saba_single     float   %9.0g                 
sama_single_date
                float   %td                   
sama_single     float   %9.0g                 
laba_single_date
                float   %td                   
laba_single     float   %9.0g                 
lama_single_date
                float   %td                   
lama_single     float   %9.0g                 
laba_ics_date   float   %td                   
laba_ics        float   %9.0g                 
laba_lama_date  float   %td                   
laba_lama       float   %9.0g                 
laba_lama_ics_date
                float   %td                   
laba_lama_ics   float   %9.0g                 
ltra_single_date
                float   %td                   
ltra_single     float   %9.0g                 
copd_date       float   %td                   
copd            float   %9.0g                 
other_respiratory_date
                float   %td                   
other_respiratory
                float   %9.0g                 
asthma_ever     str7    %9s                   
other_heart_disease_date
                float   %td                   
other_heart_disease
                float   %9.0g                 
ili_date        float   %td                   
ili             float   %9.0g                 
hypertension_date
                float   %td                   
hypertension    float   %9.0g                 
heart_failure_date
                float   %td                   
heart_failure   float   %9.0g                 
bp_sys          float   %9.0g                 
bp_sys_date     str7    %9s                   
bp_dias         float   %9.0g                 
bp_dias_date    str7    %9s                   
diabetes_date   float   %td                   
diabetes        float   %9.0g                 
lung_cancer_date
                float   %td                   
lung_cancer     float   %9.0g                 
haem_cancer_date
                float   %td                   
haem_cancer     float   %9.0g                 
other_cancer_date
                float   %td                   
other_cancer    float   %9.0g                 
aplastic_anaemia_date
                float   %td                   
aplastic_anaemia
                float   %9.0g                 
hiv_date        float   %td                   
hiv             float   %9.0g                 
perm_immunodef_date
                float   %td                   
perm_immunodef  float   %9.0g                 
temp_immunodef_date
                float   %td                   
immunodef_any   float   %9.0g                 
temp_immunodef  float   %9.0g                 
creatinine      double  %8.0g                 
creatinine_measured_date
                float   %td                   
creatinine_measured
                float   %9.0g                 
sle             str7    %9s                   
interstitial_lung_dis
                str7    %9s                   
ra              str7    %9s                   
ms              str7    %9s                   
temporal_arteritis
                str7    %9s                   
esrf_date       float   %td                   
esrf            float   %9.0g                 
recent_flu_vaccine_tpp_table
                int     %8.0g                 
recent_flu_pneumococcal_tpp_tabl
                int     %8.0g                 recent_flu_pneumococcal_tpp_table
flu_vaccine_date
                float   %td                   
flu_vaccine     float   %9.0g                 
pneumococcal_vaccine_date
                float   %td                   
pneumococcal_vaccine
                float   %9.0g                 
insulin_date    float   %td                   
insulin         float   %9.0g                 
statin_date     float   %td                   
statin          float   %9.0g                 
gp_consult_count
                int     %8.0g                 
male            float   %9.0g                 
stp             float   %9.0g                 
imd             float   %16.0g     imd        
agegroup        int     %9.0g      agegroup   RECODE of age
age70           int     %9.0g                 RECODE of age
age1            float   %9.0g                 
age2            float   %9.0g                 
age3            float   %9.0g                 
bmi_time        float   %9.0g                 
bmi_age         float   %9.0g                 
bmicat          float   %20.0g     bmicat     
obese4cat       float   %20.0g     obese4cat
                                              RECODE of bmicat
smoke           float   %12.0g     smoke      
smoke_nomiss    float   %12.0g     smoke      RECODE of smoke
gp_consult      float   %9.0g                 
cancer_ever     float   %9.0g                 
cancer_ever_date
                float   %9.0g                 
SCr_adj         float   %9.0g                 
min             float   %9.0g                 
max             float   %9.0g                 
egfr            float   %9.0g                 egfr calculated using CKD-EPI formula with no eth
egfr_cat        float   %9.0g                 
ckd_egfr        float   %9.0g                 RECODE of egfr_cat
ckd             float   %9.0g      ckd        CKD stage calc without eth
temp1_ckd_date  float   %9.0g                 
temp2_ckd_date  float   %9.0g                 
ckd_date        float   %td                   
enter_date      float   %td                   
ituadmissioncensor_date
                float   %td                   
cpnsdeathcensor_date
                float   %td                   
onscoviddeathcensor_date
                float   %td                   
died_date_ons   float   %td                   
died_date_cpns  float   %td                   
itu_date        float   %td                   
died_date_onscovid
                float   %td                   
cpnsdeath       float   %9.0g                 
onscoviddeath   float   %9.0g                 
ituadmission    float   %9.0g                 
stime_ituadmission
                float   %td                   
stime_cpnsdeath float   %td                   
stime_onscoviddeath
                float   %td                   
--------------------------------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. 
. * Demographics
. label var patient_id                            "Patient ID"

. label var age                                           "Age (years)"

. label var agegroup                                      "Grouped age"

. label var age70                                         "70 years and older"

. label var sex                                           "Sex"

. label var male                                          "Male"

. label var bmi                                           "Body Mass Index (BMI, kg/m2)"

. label var bmicat                                        "Grouped BMI"

. label var bmi_measured_date             "Body Mass Index (BMI, kg/m2), date measured"

. label var obese4cat                                     "Evidence of obesity (4 categories)"

. label var smoke                                         "Smoking status"

. label var smoke_nomiss                          "Smoking status (missing set to non)"

. label var imd                                           "Index of Multiple Deprivation (IMD)"

. label var ethnicity                                     "Ethnicity"

. label var stp                                           "Sustainability and Transformation Partnership
> "

. 
. label var age1                                          "Age spline 1"

. label var age2                                          "Age spline 2"

. label var age3                                          "Age spline 3"

. 
. * Treatment variables 
. 
. label var high_dose_ics                         "High Dose ICS"

. label var low_med_dose_ics                      "Low/Medium Dose ICS"

. label var ics_single                    "Single ICS"

. label var saba_single                           "Single SABA"

. label var sama_single                   "Single SAMA"

. label var laba_single                           "Single LABA"

. label var lama_single                           "Single LAMA"

. label var laba_ics                                      "LABA ICS"              

. label var laba_lama                             "LABA LAMA"

. label var laba_lama_ics                         "LABA LAMA ICS"

. label var ltra_single                           "Single LTRA"

. 
. label var oral_steroids                         "Oral Steroids"

. 
. label var high_dose_ics_date            "High Dose ICS Date"

. label var low_med_dose_ics_date         "Low/Medium Dose ICS Date"

. label var ics_single_date               "Single ICS Date"

. label var saba_single_date                      "Single SABA Date"

. label var sama_single_date              "Single SAMA Date"

. label var laba_single_date                      "Single LABA Date"

. label var lama_single_date                      "Single LAMA Date"

. label var laba_ics_date                         "LABA ICS Date"         

. label var laba_lama_date                        "LABA LAMA Date"

. label var laba_lama_ics_date            "LABA LAMA ICS Date"

. label var ltra_single_date                      "Single LTRA Date"

. 
. label var oral_steroids_date                    "Oral Steroids Date"

. 
. * Comorbidities of interest 
. 
. label var ckd                                                   "Chronic kidney disease" 

. label var egfr_cat                                              "Calculated eGFR"

. label var hypertension                              "Diagnosed hypertension"

. label var heart_failure                             "Heart Failure"

. *label var asthma                                               "Asthma"
. label var ili                                                   "Infleunza Like Illness"

. label var other_respiratory                     "Other Respiratory Diseases"

. label var other_heart_disease                   "Other Heart Diseases"

. label var copd                                                  "COPD"

. label var diabetes                                              "Diabetes"

. label var cancer_ever                                   "Cancer"

. label var immunodef_any                                 "Immunosuppressed (combination algorithm)"

. 
. label var statin                                                "Recent Statin"

. label var insulin                                               "Recent Insulin"

. label var flu_vaccine                                   "Flu vaccine"

. label var pneumococcal_vaccine                  "Pneumococcal Vaccine"

. label var gp_consult                                    "GP consultation in last year"

. label var gp_consult_count                              "GP consultation count"

. *label var exacerbation                                 "Exacerbation in last year"
. *label var exacerbation_count                   "Exacerbation Count"
. 
. label var ckd_date                                      "Chronic kidney disease Date" 

. label var hypertension_date                         "Diagnosed hypertension Date"

. label var heart_failure_date                    "Heart Failure Date"

. *label var asthma                                               "Asthma  Date"
. label var ili_date                                              "Infleunza Like Illness Date"

. label var other_respiratory_date                "Other Respiratory Diseases Date"

. label var other_heart_disease_date              "Other Heart Diseases Date"

. label var copd_date                                     "COPD Date"

. label var diabetes_date                                 "Diabetes Date"

. label var cancer_ever_date                              "Cancer Date"

. 
. label var statin_date                                   "Recent Statin Date"

. label var insulin_date                                  "Recent Insulin Date"

. label var flu_vaccine_date                              "Flu vaccine Date"

. label var pneumococcal_vaccine_date     "Pneumococcal Vaccine Date"

. 
. * Outcomes and follow-up
. label var enter_date                                    "Date of study entry"

. label var ituadmissioncensor_date               "Date of admin censoring for itu admission (icnarc)"

. label var cpnsdeathcensor_date                  "Date of admin censoring for cpns deaths"

. label var onscoviddeathcensor_date              "Date of admin censoring for ONS deaths"

. 
. label var ituadmission                                  "Failure/censoring indicator for outcome: ITU 
> admission"

. label var cpnsdeath                                             "Failure/censoring indicator for outco
> me: CPNS covid death"

. label var onscoviddeath                                 "Failure/censoring indicator for outcome: ONS 
> covid death"

. 
. label var died_date_cpns                                "Date of CPNS Death"

. label var died_date_onscovid                    "Date of ONS Death"

. label var itu_date                                              "Date of ITU Admission"

. 
. * Survival times
. label var  stime_ituadmission                   "Survival time (date); outcome ITU admission"

. label var  stime_cpnsdeath                              "Survival time (date); outcome CPNS covid deat
> h"

. label var  stime_onscoviddeath                  "Survival time (date); outcome ONS covid death"

. 
. /* TIDY DATA==================================================================*/
. *  Drop variables that are needed (those labelled)
. ds, not(varlabel)
died_ons_c~y  asthma_ever   haem_cance~e  hiv           creatinine~d  esrf          temp1_ckd_~e
died_ons_c~g  bp_sys        haem_cancer   perm_immun~e  sle           recent_flu~e  temp2_ckd_~e
ethnicity_~e  bp_sys_date   other_canc~e  perm_immun~f  interstiti~s  bmi_time      died_dat~ons
bmi_measured  bp_dias       other_cancer  temp_immun~e  ra            bmi_age
smoking_st~e  bp_dias_date  aplastic_a~e  temp_immun~f  ms            SCr_adj
smoking_st~d  lung_cance~e  aplastic_a~a  creatinine    temporal_a~s  min
high_dose_~g  lung_cancer   hiv_date      creatinine~e  esrf_date     max

. drop `r(varlist)'

.         
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\00_cr_create_analysis_dataset.log
  log type:  text
 closed on:  18 May 2020, 09:52:58
--------------------------------------------------------------------------------------------------------
