----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\07_an_models_interact_asthma.log
  log type:  text
 opened on:  27 Jul 2020, 13:49:28

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* The smallest age group in COPD is much smaller than for asthma (35-40). 
>    To be able to fit a meaningful model, combining this with the category above, 
>    to create a category 35 - 50 */ 
. /* So few deaths occuring below 50 years this cannot be used as a category, 
>    so updating to 35-60 */ 
.    
. recode agegroup(1 = 2)
(agegroup: 417459 changes made)

. recode agegroup(2 = 3)
(agegroup: 652949 changes made)

. tab agegroup, nolabel 

Grouped age |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,237       70.48       70.48
          4 |    181,994       14.15       84.63
          5 |    130,684       10.16       94.79
          6 |     66,940        5.21      100.00
------------+-----------------------------------
      Total |  1,285,855      100.00

. 
. label define agegroup2  3 "35-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

.                                                 
. label values agegroup agegroup2

. tab agegroup 

Grouped age |      Freq.     Percent        Cum.
------------+-----------------------------------
     35-<60 |    906,237       70.48       70.48
     60-<70 |    181,994       14.15       84.63
     70-<80 |    130,684       10.16       94.79
        80+ |     66,940        5.21      100.00
------------+-----------------------------------
      Total |  1,285,855      100.00

. 
. /* Check Counts */ 
. 
. bysort agegroup: tab exposure $outcome, row

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> agegroup = 35-<60

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |    80,176          7 |    80,183 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |   383,175         49 |   383,224 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    61,033         14 |    61,047 
                      |     99.98       0.02 |    100.00 
----------------------+----------------------+----------
                Total |   524,384         70 |   524,454 
                      |     99.99       0.01 |    100.00 

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> agegroup = 60-<70

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |    13,965          9 |    13,974 
                      |     99.94       0.06 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |   105,855         42 |   105,897 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    18,951         19 |    18,970 
                      |     99.90       0.10 |    100.00 
----------------------+----------------------+----------
                Total |   138,771         70 |   138,841 
                      |     99.95       0.05 |    100.00 

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> agegroup = 70-<80

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |     9,195         14 |     9,209 
                      |     99.85       0.15 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |    79,710        100 |    79,810 
                      |     99.87       0.13 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    13,871         33 |    13,904 
                      |     99.76       0.24 |    100.00 
----------------------+----------------------+----------
                Total |   102,776        147 |   102,923 
                      |     99.86       0.14 |    100.00 

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-> agegroup = 80+

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |     5,056         19 |     5,075 
                      |     99.63       0.37 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |    39,857        184 |    40,041 
                      |     99.54       0.46 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |     7,117         39 |     7,156 
                      |     99.46       0.54 |    100.00 
----------------------+----------------------+----------
                Total |    52,030        242 |    52,272 
                      |     99.54       0.46 |    100.00 


. 
. /* Univariable model */ 
. 
. stcox i.exposure i.agegroup

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7201.731
Iteration 1:   log likelihood = -6813.3659
Iteration 2:   log likelihood = -6748.4611
Iteration 3:   log likelihood = -6725.5981
Iteration 4:   log likelihood = -6725.4723
Iteration 5:   log likelihood = -6725.4723
Refining estimates:
Iteration 0:   log likelihood = -6725.4723

Cox regression -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(5)       =      952.52
Log likelihood  =   -6725.4723                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.030909   .1568921     0.20   0.841     .7650279    1.389194
      ICS (High Dose)  |   1.652176   .2863819     2.90   0.004     1.176284      2.3206
                       |
              agegroup |
               60-<70  |    3.73212   .6314758     7.78   0.000     2.678749     5.19971
               70-<80  |   10.59447   1.541427    16.22   0.000     7.965898     14.0904
                  80+  |   34.60903   4.705069    26.07   0.000     26.51364    45.17619
----------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.agegroup

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7201.731
Iteration 1:   log likelihood = -6818.4706
Iteration 2:   log likelihood = -6748.0593
Iteration 3:   log likelihood = -6721.1003
Iteration 4:   log likelihood = -6720.8957
Iteration 5:   log likelihood = -6720.8957
Refining estimates:
Iteration 0:   log likelihood = -6720.8957

Cox regression -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(11)      =      961.67
Log likelihood  =   -6720.8957                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |   1.464491   .5917438     0.94   0.345     .6633602    3.233137
             ICS (High Dose)  |   2.627051   1.216088     2.09   0.037     1.060324    6.508759
                              |
                     agegroup |
                      60-<70  |   7.387941   3.723172     3.97   0.000     2.751428    19.83758
                      70-<80  |   17.46358   8.084065     6.18   0.000      7.04861    43.26761
                         80+  |   43.35084   19.16719     8.53   0.000     18.22411    103.1214
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .4201199   .2294123    -1.59   0.112     .1440664    1.225134
ICS (Low/Medium Dose)#70-<80  |   .5622867   .2781438    -1.16   0.244     .2132543    1.482579
   ICS (Low/Medium Dose)#80+  |    .837565     .39404    -0.38   0.706     .3330911    2.106075
      ICS (High Dose)#60-<70  |   .5917416   .3638265    -0.85   0.393     .1773288    1.974627
      ICS (High Dose)#70-<80  |   .5943794   .3341328    -0.93   0.355     .1974955    1.788835
         ICS (High Dose)#80+  |   .5553773   .3003962    -1.09   0.277      .192391    1.603215
-----------------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./asthma_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      9.15
(Assumption: A nested in B)                           Prob > chi2 =    0.1651

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.agegroup i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7201.731
Iteration 1:   log likelihood = -6806.7577
Iteration 2:   log likelihood = -6739.7344
Iteration 3:   log likelihood = -6716.8757
Iteration 4:   log likelihood =   -6716.75
Iteration 5:   log likelihood = -6716.7499
Refining estimates:
Iteration 0:   log likelihood = -6716.7499

Cox regression -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(6)       =      969.96
Log likelihood  =   -6716.7499                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.031017   .1569248     0.20   0.841     .7650853    1.389383
      ICS (High Dose)  |   1.655617     .28702     2.91   0.004     1.178675    2.325548
                       |
              agegroup |
               60-<70  |   3.759739   .6361977     7.83   0.000     2.698505    5.238324
               70-<80  |   10.79339   1.571276    16.34   0.000     8.114127    14.35733
                  80+  |   35.96557   4.901806    26.29   0.000     27.53438    46.97844
                       |
                1.male |   1.448039   .1271406     4.22   0.000     1.219111    1.719957
----------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.agegroup i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7201.731
Iteration 1:   log likelihood = -6811.9507
Iteration 2:   log likelihood =  -6739.304
Iteration 3:   log likelihood = -6712.3513
Iteration 4:   log likelihood = -6712.1468
Iteration 5:   log likelihood = -6712.1467
Refining estimates:
Iteration 0:   log likelihood = -6712.1467

Cox regression -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(12)      =      979.17
Log likelihood  =   -6712.1467                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |   1.478304   .5973342     0.97   0.333     .6696089    3.263671
             ICS (High Dose)  |   2.682602   1.241876     2.13   0.033     1.082688    6.646743
                              |
                     agegroup |
                      60-<70  |   7.429309   3.744033     3.98   0.000     2.766825    19.94872
                      70-<80  |   17.98724   8.327451     6.24   0.000       7.2592    44.56978
                         80+  |   45.82059   20.26855     8.65   0.000     19.25463    109.0401
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .4214911   .2301614    -1.58   0.114     .1445364    1.229135
ICS (Low/Medium Dose)#70-<80  |   .5562985   .2751853    -1.19   0.236     .2109805    1.466809
   ICS (Low/Medium Dose)#80+  |   .8237435   .3875518    -0.41   0.680     .3275834    2.071391
      ICS (High Dose)#60-<70  |   .5881726   .3616331    -0.86   0.388     .1762587    1.962723
      ICS (High Dose)#70-<80  |   .5825914    .327518    -0.96   0.337      .193571    1.753428
         ICS (High Dose)#80+  |   .5396101    .291892    -1.14   0.254     .1869126    1.557836
                              |
                       1.male |   1.448909    .127227     4.22   0.000     1.219826    1.721013
-----------------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./asthma_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      9.21
(Assumption: A nested in B)                           Prob > chi2 =    0.1623

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.agegroup i.male $varlist, strata(stp)                                        

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5482.5839
Iteration 1:   log likelihood = -5060.4577
Iteration 2:   log likelihood = -4903.7267
Iteration 3:   log likelihood = -4872.7712
Iteration 4:   log likelihood = -4872.5057
Iteration 5:   log likelihood = -4872.5056
Refining estimates:
Iteration 0:   log likelihood = -4872.5056

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(28)      =     1220.16
Log likelihood  =   -4872.5056                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
     ICS (Low/Medium Dose)  |   1.156563    .176703     0.95   0.341     .8572751    1.560336
           ICS (High Dose)  |   1.578378   .2762018     2.61   0.009     1.120104    2.224147
                            |
                   agegroup |
                    60-<70  |    2.86424   .5108901     5.90   0.000     2.019212    4.062907
                    70-<80  |   7.049562   1.177575    11.69   0.000     5.081307    9.780223
                       80+  |   18.27137   3.107509    17.08   0.000     13.09191    25.49996
                            |
                     1.male |   1.474189   .1344653     4.25   0.000     1.232857    1.762763
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.076127   .1168898     0.68   0.499     .8697721    1.331441
        Obese II (35-39.9)  |   1.026043   .1604743     0.16   0.869     .7551561    1.394102
           Obese III (40+)  |   1.580463   .2773017     2.61   0.009     1.120562    2.229117
                            |
               smoke_nomiss |
                    Former  |   1.127752   .1036242     1.31   0.191     .9418906    1.350289
                   Current  |   .5735392   .1446001    -2.21   0.027     .3499122     .940085
                            |
                        imd |
                         2  |    1.18136   .1798662     1.09   0.274     .8765641    1.592137
                         3  |   1.358558   .2018626     2.06   0.039     1.015317    1.817836
                         4  |   1.587166   .2350805     3.12   0.002     1.187266    2.121762
           5 most deprived  |   1.853822   .2828046     4.05   0.000     1.374723    2.499889
                            |
                        ckd |
                       CKD  |   1.599711   .1670019     4.50   0.000     1.303708    1.962921
             1.hypertension |   1.527093    .168635     3.83   0.000     1.229896    1.896106
            1.heart_failure |   1.566718    .209793     3.35   0.001     1.205064     2.03691
      1.other_heart_disease |   1.209178   .1317066     1.74   0.081     .9767314    1.496942
                            |
                    diabcat |
       Controlled diabetes  |   1.711351   .1876511     4.90   0.000     1.380398    2.121652
     Uncontrolled diabetes  |   2.658624   .3586309     7.25   0.000     2.040964    3.463206
Diabetes, no hba1c measure  |   2.123433    1.23892     1.29   0.197      .676712    6.663052
                            |
              1.cancer_ever |   1.506912   .1679322     3.68   0.000     1.211237    1.874765
                   1.statin |   .8179952   .0814005    -2.02   0.044     .6730476    .9941586
              1.flu_vaccine |   .8581449   .0958413    -1.37   0.171     .6894373    1.068136
     1.pneumococcal_vaccine |    .798439   .1318441    -1.36   0.173     .5776771    1.103566
            1.exacerbations |   1.276208   .1244259     2.50   0.012     1.054222    1.544937
            1.immunodef_any |   2.226098   1.291238     1.38   0.168     .7141818    6.938726
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.agegroup i.male $varlist, strata(stp)                       

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5482.5839
Iteration 1:   log likelihood = -5064.6335
Iteration 2:   log likelihood =  -4907.292
Iteration 3:   log likelihood = -4868.9777
Iteration 4:   log likelihood = -4868.4685
Iteration 5:   log likelihood = -4868.4682
Refining estimates:
Iteration 0:   log likelihood = -4868.4682

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,490                  Number of obs    =     818,490
No. of failures =          529
Time at risk    =     53964849
                                                LR chi2(34)      =     1228.23
Log likelihood  =   -4868.4682                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |    1.50127   .6075186     1.00   0.315     .6792091     3.31829
             ICS (High Dose)  |   2.351943   1.092413     1.84   0.066     .9463834    5.845026
                              |
                     agegroup |
                      60-<70  |   5.246933   2.664751     3.26   0.001     1.939131    14.19724
                      70-<80  |   10.77013   5.081426     5.04   0.000      4.27187    27.15339
                         80+  |   20.71349   9.453158     6.64   0.000     8.468075    50.66662
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .4656041    .254311    -1.40   0.162     .1596225    1.358124
ICS (Low/Medium Dose)#70-<80  |   .6219089   .3078339    -0.96   0.337     .2357203    1.640803
   ICS (Low/Medium Dose)#80+  |   .9422306   .4437418    -0.13   0.899     .3743565    2.371532
      ICS (High Dose)#60-<70  |   .6215638   .3822669    -0.77   0.439     .1862043    2.074826
      ICS (High Dose)#70-<80  |    .625624   .3520322    -0.83   0.405     .2076592    1.884846
         ICS (High Dose)#80+  |   .6196064   .3355811    -0.88   0.377     .2143394    1.791141
                              |
                       1.male |    1.47581   .1346354     4.27   0.000     1.234176    1.764753
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.076456    .116941     0.68   0.498     .8700127    1.331885
          Obese II (35-39.9)  |   1.027491   .1607658     0.17   0.862     .7561278    1.396242
             Obese III (40+)  |   1.572178   .2760937     2.58   0.010     1.114347     2.21811
                              |
                 smoke_nomiss |
                      Former  |   1.125823   .1034596     1.29   0.197     .9402587    1.348009
                     Current  |   .5722763   .1442754    -2.21   0.027     .3491493    .9379946
                              |
                          imd |
                           2  |   1.179979   .1796539     1.09   0.277      .875543    1.590271
                           3  |   1.356505    .201568     2.05   0.040     1.013767    1.815116
                           4  |   1.583299   .2345577     3.10   0.002       1.1843    2.116723
             5 most deprived  |   1.849223   .2821059     4.03   0.000     1.371309    2.493695
                              |
                          ckd |
                         CKD  |   1.599814   .1668312     4.51   0.000     1.304082    1.962611
               1.hypertension |   1.522191   .1679606     3.81   0.000     1.226158    1.889696
              1.heart_failure |   1.571873   .2102519     3.38   0.001     1.209377    2.043023
        1.other_heart_disease |   1.209611   .1316588     1.75   0.080     .9772315    1.497248
                              |
                      diabcat |
         Controlled diabetes  |   1.707957   .1872216     4.88   0.000     1.377751    2.117305
       Uncontrolled diabetes  |   2.655988   .3581812     7.24   0.000     2.039083    3.459533
  Diabetes, no hba1c measure  |   2.103261   1.227154     1.27   0.203     .6702809    6.599779
                              |
                1.cancer_ever |   1.505285   .1677339     3.67   0.000     1.209955    1.872699
                     1.statin |   .8169195   .0812513    -2.03   0.042     .6722306    .9927507
                1.flu_vaccine |   .8571379    .095678    -1.38   0.167     .6887084    1.066758
       1.pneumococcal_vaccine |    .800907   .1322633    -1.34   0.179      .579446    1.107009
              1.exacerbations |   1.274091   .1242456     2.48   0.013     1.052432    1.542436
              1.immunodef_any |   2.211792   1.283066     1.37   0.171     .7095125    6.894909
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./asthma_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      8.07
(Assumption: A nested in B)                           Prob > chi2 =    0.2327

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 3: Current ICS use and $tableoutcome, Age Interaction - $population Population") _n

. file write tablecontent _tab _tab _tab _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab _tab  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab ("Events") _tab ("Person-weeks") _tab ("Rate per 1,000") _tab ///
>                                                 ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                 local lab2: label exposure 2
  7.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.                 file write tablecontent ("`lab0'") _tab
  8. 
.                         count if exposure == 0  & `variable' == `varlevel' & $outcome == 1
  9.                         local event = r(N)
 10.                         bysort exposure `variable': egen total_follow_up = total(_t)
 11.                         summarize total_follow_up if exposure == 0 & `variable' == `varlevel'
 12.                         local person_week = r(mean)/7
 13.                         local rate = 1000*(`event'/`person_week')
 14.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 15.         file write tablecontent ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _n
 16.                         
.                 * Second row, exposure = 1 (comparator)
.                 
.                 file write tablecontent ("`lab1'") _tab
 17. 
.                         count if exposure == 1 & `variable' == `varlevel' & $outcome == 1
 18.                         local event = r(N)
 19.                         summarize total_follow_up if exposure == 1 & `variable' == `varlevel'
 20.                         local person_week = r(mean)/7
 21.                         local rate = 1000*(`event'/`person_week')
 22.                 
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 23. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 24.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 25.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 26. 
.                 estimates use ./$tempdir/multivar1_int
 27.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 28.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 29. 
.                 estimates use ./$tempdir/multivar2_int
 30.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 31.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 32.                 
.                 * Third row, exposure = 2 (comparator)
. 
.                 file write tablecontent ("`lab2'") _tab  
 33. 
.                         count if exposure == 2 & `variable' == `varlevel' & $outcome == 1
 34.                         local event = r(N)
 35.                         summarize total_follow_up if exposure == 2 & `variable' == `varlevel'
 36.                         local person_week = r(mean)/7
 37.                         local rate = 1000*(`event'/`person_week')
 38.                         
.                 file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab
 39. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 40.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 41.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 42. 
.                 estimates use ./$tempdir/multivar1_int
 43.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 44.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _tab
 45. 
.                 estimates use ./$tempdir/multivar2_int
 46.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 47.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab _n 
 48.                 
.                 *drop macro, so this can be redefined
.                 drop total_follow_up
 49.         
.         } 
 50.                 
. end

. 
. printinteraction, variable(agegroup) min(3) max(6) 
  7

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     80,183     5290722           0    5290722    5290722
  49

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    383,224    2.53e+07           0   2.53e+07   2.53e+07
  14

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     61,047     4027923           0    4027923    4027923
  9

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     13,974      921076           0     921076     921076
  42

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    105,897     6984610           0    6984610    6984610
  19

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     18,970     1250710           0    1250710    1250710
  14

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      9,209      606318           0     606318     606318
  100

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     79,810     5258390           0    5258390    5258390
  33

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     13,904      915383           0     915383     915383
  19

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      5,075      332070           0     332070     332070
  184

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     40,041     2621823           0    2621823    2621823
  39

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |      7,156      467561           0     467561     467561

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\07_an_models_interact_asthma.log
  log type:  text
 closed on:  27 Jul 2020, 13:55:10
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
