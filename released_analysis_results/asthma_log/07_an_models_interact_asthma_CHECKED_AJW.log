-------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\07_an_models_interact_asthma.log
  log type:  text
 opened on:  27 May 2020, 10:41:27

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Age Interaction============================================================*/ 
. 
. /* The smallest age group in COPD is much smaller than for asthma (35-40). 
>    To be able to fit a meaningful model, combining this with the category above, 
>    to create a category 35 - 50 */ 
. /* So few deaths occuring below 50 years this cannot be used as a category, 
>    so updating to 35-60 */ 
.    
. recode agegroup(1 = 2)
(agegroup: 417391 changes made)

. recode agegroup(2 = 3)
(agegroup: 652837 changes made)

. tab agegroup, nolabel 

Grouped age |      Freq.     Percent        Cum.
------------+-----------------------------------
          3 |    906,033       70.48       70.48
          4 |    181,904       14.15       84.64
          5 |    130,588       10.16       94.79
          6 |     66,913        5.21      100.00
------------+-----------------------------------
      Total |  1,285,438      100.00

. 
. label define agegroup2  3 "35-<60" ///
>                                                 4 "60-<70" ///
>                                                 5 "70-<80" ///
>                                                 6 "80+"

.                                                 
. label values agegroup agegroup2

. tab agegroup 

Grouped age |      Freq.     Percent        Cum.
------------+-----------------------------------
     35-<60 |    906,033       70.48       70.48
     60-<70 |    181,904       14.15       84.64
     70-<80 |    130,588       10.16       94.79
        80+ |     66,913        5.21      100.00
------------+-----------------------------------
      Total |  1,285,438      100.00

. 
. /* Check Counts */ 
. 
. bysort agegroup: tab exposure $outcome, row

-------------------------------------------------------------------------------------------------------------
-> agegroup = 35-<60

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |    80,163          6 |    80,169 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |   383,079         47 |   383,126 
                      |     99.99       0.01 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    61,015         12 |    61,027 
                      |     99.98       0.02 |    100.00 
----------------------+----------------------+----------
                Total |   524,257         65 |   524,322 
                      |     99.99       0.01 |    100.00 

-------------------------------------------------------------------------------------------------------------
-> agegroup = 60-<70

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |    13,959          9 |    13,968 
                      |     99.94       0.06 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |   105,807         39 |   105,846 
                      |     99.96       0.04 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    18,944         18 |    18,962 
                      |     99.91       0.09 |    100.00 
----------------------+----------------------+----------
                Total |   138,710         66 |   138,776 
                      |     99.95       0.05 |    100.00 

-------------------------------------------------------------------------------------------------------------
-> agegroup = 70-<80

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |     9,192         14 |     9,206 
                      |     99.85       0.15 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |    79,659         93 |    79,752 
                      |     99.88       0.12 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |    13,864         33 |    13,897 
                      |     99.76       0.24 |    100.00 
----------------------+----------------------+----------
                Total |   102,715        140 |   102,855 
                      |     99.86       0.14 |    100.00 

-------------------------------------------------------------------------------------------------------------
-> agegroup = 80+

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
     Asthma Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
            SABA only |     5,059         17 |     5,076 
                      |     99.67       0.33 |    100.00 
----------------------+----------------------+----------
ICS (Low/Medium Dose) |    39,842        171 |    40,013 
                      |     99.57       0.43 |    100.00 
----------------------+----------------------+----------
      ICS (High Dose) |     7,120         38 |     7,158 
                      |     99.47       0.53 |    100.00 
----------------------+----------------------+----------
                Total |    52,021        226 |    52,247 
                      |     99.57       0.43 |    100.00 


. 
. /* Univariable model */ 
. 
. stcox i.exposure i.agegroup

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6765.9464
Iteration 1:   log likelihood = -6399.4953
Iteration 2:   log likelihood = -6337.4731
Iteration 3:   log likelihood = -6317.5027
Iteration 4:   log likelihood = -6317.4002
Iteration 5:   log likelihood = -6317.4001
Refining estimates:
Iteration 0:   log likelihood = -6317.4001

Cox regression -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(5)       =      897.09
Log likelihood  =   -6317.4001                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.024297   .1609404     0.15   0.879     .7528053    1.393699
      ICS (High Dose)  |   1.690835   .3013297     2.95   0.003     1.192355    2.397712
                       |
              agegroup |
               60-<70  |   3.788251   .6626454     7.61   0.000      2.68872    5.337427
               70-<80  |   10.86519   1.633858    15.86   0.000     8.091655    14.58939
                  80+  |   34.78281      4.904    25.17   0.000     26.38484    45.85375
----------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.agegroup

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6765.9464
Iteration 1:   log likelihood = -6408.8913
Iteration 2:   log likelihood =  -6338.957
Iteration 3:   log likelihood = -6312.6716
Iteration 4:   log likelihood = -6312.4517
Iteration 5:   log likelihood = -6312.4516
Refining estimates:
Iteration 0:   log likelihood = -6312.4516

Cox regression -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(11)      =      906.99
Log likelihood  =   -6312.4516                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |   1.639039   .7105631     1.14   0.254     .7007656    3.833591
             ICS (High Dose)  |   2.627465   1.313733     1.93   0.053     .9861346     7.00064
                              |
                     agegroup |
                      60-<70  |   8.621386   4.543869     4.09   0.000       3.0687    24.22142
                      70-<80  |   20.37654   9.942735     6.18   0.000     7.830449    53.02422
                         80+  |    45.2145   21.47047     8.03   0.000     17.82698    114.6774
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .3485902   .1986339    -1.85   0.064     .1140993    1.064994
ICS (Low/Medium Dose)#70-<80  |   .4674112     .24293    -1.46   0.143     .1687718    1.294489
   ICS (Low/Medium Dose)#80+  |   .7781229   .3910907    -0.50   0.618     .2905545    2.083861
      ICS (High Dose)#60-<70  |   .5604958   .3617985    -0.90   0.370       .15817    1.986189
      ICS (High Dose)#70-<80  |   .5943708   .3525033    -0.88   0.380     .1858813     1.90055
         ICS (High Dose)#80+  |    .604743   .3500931    -0.87   0.385     .1944464    1.880796
-----------------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/univar_int, replace 
file ./asthma_tempdata/univar_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      9.90
(Assumption: A nested in B)                           Prob > chi2 =    0.1291

. local univar_p = round(r(p),0.001)

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. 
. stcox i.exposure i.agegroup i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6765.9464
Iteration 1:   log likelihood =  -6392.037
Iteration 2:   log likelihood = -6327.6342
Iteration 3:   log likelihood = -6307.6684
Iteration 4:   log likelihood =  -6307.566
Iteration 5:   log likelihood = -6307.5659
Refining estimates:
Iteration 0:   log likelihood = -6307.5659

Cox regression -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(6)       =      916.76
Log likelihood  =   -6307.5659                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.024405   .1609754     0.15   0.878     .7528589    1.393894
      ICS (High Dose)  |   1.694694   .3020654     2.96   0.003      1.19501    2.403317
                       |
              agegroup |
               60-<70  |   3.818765   .6680346     7.66   0.000     2.710305    5.380562
               70-<80  |   11.08843   1.668402    15.99   0.000     8.256489    14.89171
                  80+  |   36.28249    5.12833    25.41   0.000     27.50328    47.86408
                       |
                1.male |   1.499098   .1355563     4.48   0.000     1.255625    1.789782
----------------------------------------------------------------------------------------

. estimates store A

. 
. stcox i.exposure##i.agegroup i.male

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -6765.9464
Iteration 1:   log likelihood = -6401.5447
Iteration 2:   log likelihood = -6329.1081
Iteration 3:   log likelihood = -6302.8316
Iteration 4:   log likelihood = -6302.6117
Iteration 5:   log likelihood = -6302.6116
Refining estimates:
Iteration 0:   log likelihood = -6302.6116

Cox regression -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(12)      =      926.67
Log likelihood  =   -6302.6116                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |   1.655927   .7178944     1.16   0.245     .7079776    3.873136
             ICS (High Dose)  |   2.688241   1.344191     1.98   0.048     1.008893    7.162942
                              |
                     agegroup |
                      60-<70  |   8.673402   4.571299     4.10   0.000     3.087205    24.36764
                      70-<80  |   21.04764   10.27135     6.24   0.000     8.087472    54.77644
                         80+  |   48.04521   22.82444     8.15   0.000      18.9355    121.9055
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .3498654   .1993607    -1.84   0.065     .1145166    1.068891
ICS (Low/Medium Dose)#70-<80  |   .4619235    .240081    -1.49   0.137     .1667881    1.279308
   ICS (Low/Medium Dose)#80+  |   .7641215   .3840666    -0.54   0.592     .2853167    2.046433
      ICS (High Dose)#60-<70  |   .5568516   .3594471    -0.91   0.364     .1571411    1.973282
      ICS (High Dose)#70-<80  |   .5814623   .3448595    -0.91   0.361      .181837    1.859348
         ICS (High Dose)#80+  |   .5860191   .3392795    -0.92   0.356     .1884097    1.822722
                              |
                       1.male |   1.499333   .1355897     4.48   0.000     1.255801    1.790091
-----------------------------------------------------------------------------------------------

. estimates store B

. estimates save ./$tempdir/multivar1_int, replace 
file ./asthma_tempdata/multivar1_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      9.91
(Assumption: A nested in B)                           Prob > chi2 =    0.1286

. local multivar1_p = round(r(p),0.001)

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.agegroup i.male      i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss             
>              ///
>                                                                                 i.imd                      
>                      ///
>                                                                                 i.ckd                      
>                      ///             
>                                                                                 i.hypertension             
>              ///             
>                                                                                 i.heart_failure            
>              ///             
>                                                                                 i.other_heart_disease      
>      ///             
>                                                                                 i.diabcat                  
>                      ///             
>                                                                                 i.cancer_ever              
>              ///                                                     
>                                                                                 i.statin                   
>                      ///                     
>                                                                                 i.flu_vaccine              
>              ///     
>                                                                                 i.pneumococcal_vaccine     
>      ///     
>                                                                                 i.exacerbations, strata(stp
> )                                    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5149.6348
Iteration 1:   log likelihood = -4742.2939
Iteration 2:   log likelihood = -4599.6737
Iteration 3:   log likelihood = -4573.2536
Iteration 4:   log likelihood = -4573.0492
Iteration 5:   log likelihood = -4573.0491
Refining estimates:
Iteration 0:   log likelihood = -4573.0491

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(27)      =     1153.17
Log likelihood  =   -4573.0491                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
     ICS (Low/Medium Dose)  |   1.140365   .1797659     0.83   0.405     .8372623    1.553196
           ICS (High Dose)  |     1.5894   .2857946     2.58   0.010     1.117316    2.260946
                            |
                   agegroup |
                    60-<70  |   2.782286   .5122542     5.56   0.000     1.939478    3.991341
                    70-<80  |   6.822974    1.17244    11.18   0.000     4.871982    9.555244
                       80+  |   17.41442   3.049799    16.32   0.000     12.35485    24.54599
                            |
                     1.male |   1.521616   .1429362     4.47   0.000     1.265743    1.829214
                            |
                  obese4cat |
         Obese I (30-34.9)  |    1.08144   .1211562     0.70   0.485     .8682407     1.34699
        Obese II (35-39.9)  |   1.032932   .1667059     0.20   0.841     .7528271    1.417255
           Obese III (40+)  |   1.653382   .2949528     2.82   0.005     1.165532    2.345428
                            |
               smoke_nomiss |
                    Former  |   1.198816   .1142889     1.90   0.057     .9944973    1.445113
                   Current  |   .6125645   .1591357    -1.89   0.059     .3681473    1.019253
                            |
                        imd |
                         2  |   1.128249    .177786     0.77   0.444      .828467    1.536507
                         3  |   1.342972   .2045887     1.94   0.053     .9963104    1.810253
                         4  |   1.581368   .2396235     3.02   0.002     1.175035    2.128212
           5 most deprived  |   1.750295   .2763747     3.55   0.000     1.284414     2.38516
                            |
                        ckd |
                       CKD  |   1.649302   .1771607     4.66   0.000     1.336189    2.035788
             1.hypertension |    1.55543   .1777044     3.87   0.000     1.243376      1.9458
            1.heart_failure |   1.508568   .2108535     2.94   0.003     1.147075    1.983982
      1.other_heart_disease |   1.152164   .1301412     1.25   0.210     .9233535    1.437675
                            |
                    diabcat |
       Controlled diabetes  |   1.770036   .1991111     5.08   0.000     1.419811    2.206651
     Uncontrolled diabetes  |   2.663067   .3711758     7.03   0.000     2.026481    3.499627
Diabetes, no hba1c measure  |   2.294405    1.33943     1.42   0.155     .7307263    7.204193
                            |
              1.cancer_ever |   1.466471   .1695791     3.31   0.001     1.169076    1.839519
                   1.statin |   .8184405   .0837914    -1.96   0.050     .6696405    1.000305
              1.flu_vaccine |   .9716225   .1045564    -0.27   0.789     .7868641    1.199763
     1.pneumococcal_vaccine |   .8295219   .1404914    -1.10   0.270     .5952024    1.156088
            1.exacerbations |   1.291174   .1295423     2.55   0.011     1.060681    1.571756
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                 
. estimates store A

. 
. stcox i.exposure##i.agegroup i.male     i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss             
>              ///
>                                                                                 i.imd                      
>                      ///
>                                                                                 i.ckd                      
>                      ///             
>                                                                                 i.hypertension             
>              ///             
>                                                                                 i.heart_failure            
>              ///             
>                                                                                 i.other_heart_disease      
>      ///             
>                                                                                 i.diabcat                  
>                      ///             
>                                                                                 i.cancer_ever              
>              ///                                                     
>                                                                                 i.statin                   
>                      ///             
>                                                                                 i.flu_vaccine              
>              ///     
>                                                                                 i.pneumococcal_vaccine     
>      ///     
>                                                                                 i.exacerbations , strata(st
> p)                   

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5149.6348
Iteration 1:   log likelihood = -4749.9521
Iteration 2:   log likelihood = -4605.0768
Iteration 3:   log likelihood = -4569.1672
Iteration 4:   log likelihood = -4568.6882
Iteration 5:   log likelihood = -4568.6879
Refining estimates:
Iteration 0:   log likelihood = -4568.6879

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      818,200                  Number of obs    =     818,200
No. of failures =          497
Time at risk    =     50681202
                                                LR chi2(33)      =     1161.89
Log likelihood  =   -4568.6879                  Prob > chi2      =      0.0000

-----------------------------------------------------------------------------------------------
                           _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
------------------------------+----------------------------------------------------------------
                     exposure |
       ICS (Low/Medium Dose)  |   1.643975   .7135058     1.15   0.252     .7022037    3.848818
             ICS (High Dose)  |   2.260935   1.133541     1.63   0.104     .8463112    6.040126
                              |
                     agegroup |
                      60-<70  |   5.792525   3.075398     3.31   0.001     2.046178    16.39806
                      70-<80  |   11.67477   5.795936     4.95   0.000     4.412343    30.89065
                         80+  |   20.08912   9.812333     6.14   0.000     7.712584    52.32653
                              |
            exposure#agegroup |
ICS (Low/Medium Dose)#60-<70  |   .3907665   .2227208    -1.65   0.099     .1278697    1.194173
ICS (Low/Medium Dose)#70-<80  |   .5245994   .2727991    -1.24   0.215     .1893176    1.453666
   ICS (Low/Medium Dose)#80+  |   .8928275   .4491556    -0.23   0.822     .3330832    2.393218
      ICS (High Dose)#60-<70  |    .600216   .3875277    -0.79   0.429     .1693291    2.127568
      ICS (High Dose)#70-<80  |   .6433964   .3818611    -0.74   0.457     .2010405    2.059082
         ICS (High Dose)#80+  |   .6947937   .4026525    -0.63   0.530     .2231314    2.163471
                              |
                       1.male |    1.52261   .1430515     4.47   0.000     1.266535    1.830461
                              |
                    obese4cat |
           Obese I (30-34.9)  |   1.081673   .1212018     0.70   0.484     .8683979    1.347328
          Obese II (35-39.9)  |   1.034508   .1670224     0.21   0.834     .7538877    1.419585
             Obese III (40+)  |   1.645328   .2937731     2.79   0.005     1.159499    2.334718
                              |
                 smoke_nomiss |
                      Former  |   1.197869   .1142142     1.89   0.058     .9936862    1.444008
                     Current  |   .6124823   .1590858    -1.89   0.059     .3681315    1.019023
                              |
                          imd |
                           2  |   1.126972   .1775821     0.76   0.448     .8275328    1.534761
                           3  |   1.341768   .2044139     1.93   0.054     .9954046    1.808652
                           4  |   1.577793   .2391335     3.01   0.003     1.172304    2.123537
             5 most deprived  |   1.746825   .2758182     3.53   0.000      1.28188    2.380408
                              |
                          ckd |
                         CKD  |   1.648997   .1769249     4.66   0.000     1.336265     2.03492
               1.hypertension |   1.551222   .1771396     3.84   0.000     1.240144    1.940331
              1.heart_failure |   1.513971   .2113703     2.97   0.003     1.151539    1.990474
        1.other_heart_disease |   1.152658   .1300941     1.26   0.208     .9239107    1.438039
                              |
                      diabcat |
         Controlled diabetes  |    1.76593   .1986144     5.06   0.000     1.416572    2.201447
       Uncontrolled diabetes  |   2.658859   .3705249     7.02   0.000     2.023374    3.493931
  Diabetes, no hba1c measure  |   2.275446    1.32833     1.41   0.159     .7247088    7.144464
                              |
                1.cancer_ever |   1.464511   .1693371     3.30   0.001     1.167538    1.837023
                     1.statin |   .8172359    .083631    -1.97   0.049     .6687142    .9987443
                1.flu_vaccine |   .9720475   .1045587    -0.26   0.792     .7872771    1.200183
       1.pneumococcal_vaccine |   .8335117   .1411783    -1.08   0.282     .5980495    1.161679
              1.exacerbations |    1.29014   .1294754     2.54   0.011     1.059771    1.570585
-----------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates store B

. estimates save ./$tempdir/multivar2_int, replace 
file ./asthma_tempdata/multivar2_int.ster saved

. 
. lrtest A B

Likelihood-ratio test                                 LR chi2(6)  =      8.72
(Assumption: A nested in B)                           Prob > chi2 =    0.1898

. local multivar2_p = round(r(p),0.001)

. 
. /* Print interaction table====================================================*/ 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table3.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 3: Current ICS use and COVID-19 death, Age Interaction - $population Popula
> tion") _n

. file write tablecontent _tab ("N") _tab ("Univariable") _tab _tab _tab ("Age/Sex Adjusted") _tab _tab _tab 
>  ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _tab _n

. file write tablecontent _tab _tab ("HR") _tab ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("p (interaction)") _tab ("HR") _tab ("95% 
> CI") _tab ("p (interaction)") _tab _n

. 
. * Overall p-values 
. file write tablecontent ("Agegroup") _tab _tab _tab _tab ("`univar_p'") ///
>                                                 _tab _tab _tab ("`multivar1_p'") /// 
>                                                 _tab _tab _tab ("`multivar2_p'") _n

. 
.                                                 
. * Generic program to print model for a level of another variable 
. cap prog drop printinteraction

. prog define printinteraction 
  1. syntax, variable(varname) min(real) max(real) 
  2. 
.         forvalues varlevel = `min'/`max'{ 
  3. 
.                 * Row headings 
.                 file write tablecontent ("`varlevel'") _n       
  4. 
.                 local lab0: label exposure 0
  5.                 local lab1: label exposure 1
  6.                 local lab2: label exposure 2
  7.                  
.                 /* Counts */
.                         
.                 * First row, exposure = 0 (reference)
.                 
.         file write tablecontent ("`lab0'") _tab
  8. 
.                         cou if exposure == 0 & `variable' == `varlevel'
  9.                         local rowdenom = r(N)
 10.                         cou if exposure == 0  & `variable' == `varlevel' & cpnsdeath == 1
 11.                         local pct = 100*(r(N)/`rowdenom')
 12.                         
.                         
.                 file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab
 13.                 file write tablecontent ("1.00 (ref)") _tab _tab _tab ("1.00 (ref)") _tab _tab _tab ("1.
> 00 (ref)") _n
 14.                         
.                 * Second row, exposure = 1 (comparator)
. 
.                 file write tablecontent ("`lab1'") _tab  
 15. 
.                         cou if exposure == 1 & `variable' == `varlevel'
 16.                         local rowdenom = r(N)
 17.                         cou if exposure == 1 & `variable' == `varlevel' & cpnsdeath == 1
 18.                         local pct = 100*(r(N)/`rowdenom')
 19.                         
.                 file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab
 20. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 21.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 22.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _tab
 23. 
.                 estimates use ./$tempdir/multivar1_int
 24.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 25.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _tab
 26. 
.                 estimates use ./$tempdir/multivar2_int
 27.                 qui lincom 1.exposure + 1.exposure#`varlevel'.`variable', eform
 28.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _n 
 29.                 
.                 * Third row, exposure = 2 (comparator)
. 
.                 file write tablecontent ("`lab2'") _tab  
 30. 
.                         cou if exposure == 2 & `variable' == `varlevel'
 31.                         local rowdenom = r(N)
 32.                         cou if exposure == 2 & `variable' == `varlevel' & cpnsdeath == 1
 33.                         local pct = 100*(r(N)/`rowdenom')
 34.                         
.                 file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab
 35. 
.                 * Print models 
.                 estimates use ./$tempdir/univar_int 
 36.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 37.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _tab
 38. 
.                 estimates use ./$tempdir/multivar1_int
 39.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 40.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _tab
 41. 
.                 estimates use ./$tempdir/multivar2_int
 42.                 qui lincom 2.exposure + 2.exposure#`varlevel'.`variable', eform
 43.                 file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _ta
> b _n 
 44.         
.         } 
 45.                 
. end

. 
. printinteraction, variable(agegroup) min(3) max(6) 
  80,169
  5
  383,126
  35
  61,027
  9
  13,968
  7
  105,846
  31
  18,962
  12
  9,206
  9
  79,752
  65
  13,897
  21
  5,076
  9
  40,013
  94
  7,158
  22

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log\07_an_models_interact_asthma.log
  log type:  text
 closed on:  27 May 2020, 10:46:43
-------------------------------------------------------------------------------------------------------------
