-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log_sens1\S1-04_an_descriptive_table_copd.log
  log type:  text
 opened on:   9 Jun 2020, 11:35:07

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset, clear

. 
. /* PROGRAMS TO AUTOMATE TABULATIONS===========================================*/ 
. 
. ********************************************************************************
. * All below code from K Baskharan 
. * Generic code to output one row of table
. 
. cap prog drop generaterow

. program define generaterow
  1. syntax, variable(varname) condition(string) 
  2.         
.         cou
  3.         local overalldenom=r(N)
  4.         
.         qui sum `variable' if `variable' `condition'
  5.         file write tablecontent (r(max)) _tab
  6.         
.         cou if `variable' `condition'
  7.         local rowdenom = r(N)
  8.         local colpct = 100*(r(N)/`overalldenom')
  9.         file write tablecontent %9.0gc (`rowdenom')  (" (") %3.1f (`colpct') (")") _tab
 10. 
.         cou if exposure == 0 
 11.         local rowdenom = r(N)
 12.         cou if exposure == 0 & `variable' `condition'
 13.         local pct = 100*(r(N)/`rowdenom') 
 14.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _tab
 15. 
.         cou if exposure == 1 
 16.         local rowdenom = r(N)
 17.         cou if exposure == 1 & `variable' `condition'
 18.         local pct = 100*(r(N)/`rowdenom')
 19.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 20. 
.         cou if exposure == 2
 21.         local rowdenom = r(N)
 22.         cou if exposure == 2 & `variable' `condition'
 23.         local pct = 100*(r(N)/`rowdenom')
 24.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 25. 
.         cou if exposure >= .
 26.         local rowdenom = r(N)
 27.         cou if exposure >= . & `variable' `condition'
 28.         local pct = 100*(r(N)/`rowdenom')
 29.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _n
 30.         
. end

. 
. /* Explanatory Notes 
> 
> defines a program (SAS macro/R function equivalent), generate row
> the syntax row specifies two inputs for the program: 
> 
>         a VARNAME which is your variable 
>         a CONDITION which is a string of some condition you impose 
>         
> the program counts if variable and condition and returns the counts
> column percentages are then automatically generated
> this is then written to the text file 'tablecontent' 
> the number followed by space, brackets, formatted pct, end bracket and then tab
> 
> the format %3.1f specifies length of 3, followed by 1 dp. 
> 
> */ 
. 
. ********************************************************************************
. * Generic code to output one section (varible) within table (calls above)
. 
. cap prog drop tabulatevariable

. prog define tabulatevariable
  1. syntax, variable(varname) min(real) max(real) [missing]
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4. 
.         forvalues varlevel = `min'/`max'{ 
  5.                 generaterow, variable(`variable') condition("==`varlevel'")
  6.         }
  7.         
.         if "`missing'"!="" generaterow, variable(`variable') condition(">=.")
  8. 
. end

. 
. ********************************************************************************
. 
. /* Explanatory Notes 
> 
> defines program tabulate variable 
> syntax is : 
> 
>         - a VARNAME which you stick in variable 
>         - a numeric minimum 
>         - a numeric maximum 
>         - optional missing option, default value is . 
> 
> forvalues lowest to highest of the variable, manually set for each var
> run the generate row program for the level of the variable 
> if there is a missing specified, then run the generate row for missing vals
> 
> */ 
. 
. ********************************************************************************
. * Generic code to summarize a continous variable 
. 
. cap prog drop summarizevariable 

. prog define summarizevariable
  1. syntax, variable(varname) 
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4.         
.         qui summarize `variable', d
  5.         file write tablecontent ("Median (IQR)") _tab 
  6.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  7.                                                         
.         qui summarize `variable' if exposure == 0, d
  8.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  9. 
.         qui summarize `variable' if exposure == 1, d
 10.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 11.         
.         qui summarize `variable' if exposure == 2, d
 12.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 13. 
.         qui summarize `variable' if exposure >= ., d
 14.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _n
 15.         
.         qui summarize `variable', d
 16.         file write tablecontent ("Mean (SD)") _tab 
 17.         file write tablecontent (r(mean)) (" (") (r(sd)) (")") _tab
 18.                                                         
.         qui summarize `variable' if exposure == 0, d
 19.         file write tablecontent (r(mean)) (" (") (r(sd)) (")") _tab
 20. 
.         qui summarize `variable' if exposure == 1, d
 21.         file write tablecontent (r(mean)) (" (") (r(sd)) (")") _tab
 22.         
.         qui summarize `variable' if exposure == 2, d
 23.         file write tablecontent (r(mean)) (" (") (r(sd))  (")") _tab
 24. 
.         qui summarize `variable' if exposure >= ., d
 25.         file write tablecontent (r(mean)) (" (") (r(sd))  (")") _n
 26.         
.         qui summarize `variable', d
 27.         file write tablecontent ("Min, Max") _tab 
 28.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 29.                                                         
.         qui summarize `variable' if exposure == 0, d
 30.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 31. 
.         qui summarize `variable' if exposure == 1, d
 32.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 33.         
.         qui summarize `variable' if exposure == 2, d
 34.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 35. 
.         qui summarize `variable' if exposure >= ., d
 36.         file write tablecontent (r(min)) (", ") (r(max)) ("") _n
 37.         
. end

. 
. 
. /* INVOKE PROGRAMS FOR TABLE 1================================================*/ 
. 
. *Set up output file
. cap file close tablecontent

. file open tablecontent using ./$outdir/S1table1.txt, write text replace

. 
. file write tablecontent ("S1 Table 1: Demographic and Clinical Characteristics - $population") _n

. 
. * Exposure labelled columns
. 
. local lab0: label exposure 0

. local lab1: label exposure 1

. local lab2: label exposure 2

. local labu: label exposure .u

. 
. 
. file write tablecontent _tab ("Total")                                                    _tab ///
>                                                          ("`lab0'")                                                   _tab ///
>                                                          ("`lab1'")                                               _tab ///
>                                                          ("`lab2'")                                                       _tab ///
>                                                          ("`labu'")                                                       _n 

. 
. * DEMOGRAPHICS (more than one level, potentially missing) 
. 
. gen byte cons=1

. tabulatevariable, variable(cons) min(1) max(1) 
  291,805
  291,805
  43,278
  43,278
  29,868
  29,868
  75,342
  75,342
  143,317
  143,317

. file write tablecontent _n 

. 
. tabulatevariable, variable(agegroup) min(1) max(6) 
  291,805
  1,232
  43,278
  85
  29,868
  91
  75,342
  93
  143,317
  963
  291,805
  10,028
  43,278
  1,060
  29,868
  872
  75,342
  1,417
  143,317
  6,679
  291,805
  40,910
  43,278
  5,746
  29,868
  3,872
  75,342
  8,365
  143,317
  22,927
  291,805
  80,788
  43,278
  12,599
  29,868
  7,920
  75,342
  21,599
  143,317
  38,670
  291,805
  104,319
  43,278
  16,092
  29,868
  10,863
  75,342
  29,507
  143,317
  47,857
  291,805
  54,528
  43,278
  7,696
  29,868
  6,250
  75,342
  14,361
  143,317
  26,221

. file write tablecontent _n 

. 
. tabulatevariable, variable(male) min(0) max(1) 
  291,805
  133,738
  43,278
  19,699
  29,868
  13,990
  75,342
  34,717
  143,317
  65,332
  291,805
  158,067
  43,278
  23,579
  29,868
  15,878
  75,342
  40,625
  143,317
  77,985

. file write tablecontent _n 

. 
. tabulatevariable, variable(bmicat) min(1) max(6) missing
  291,805
  11,359
  43,278
  1,682
  29,868
  1,062
  75,342
  3,682
  143,317
  4,933
  291,805
  89,195
  43,278
  12,938
  29,868
  8,667
  75,342
  23,191
  143,317
  44,399
  291,805
  95,443
  43,278
  14,011
  29,868
  10,019
  75,342
  23,475
  143,317
  47,938
  291,805
  55,541
  43,278
  8,590
  29,868
  6,002
  75,342
  14,276
  143,317
  26,673
  291,805
  22,054
  43,278
  3,568
  29,868
  2,260
  75,342
  6,119
  143,317
  10,107
  291,805
  10,006
  43,278
  1,580
  29,868
  1,061
  75,342
  2,884
  143,317
  4,481
  291,805
  8,207
  43,278
  909
  29,868
  797
  75,342
  1,715
  143,317
  4,786

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke) min(1) max(3) missing 
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0
  291,805
  184,400
  43,278
  26,015
  29,868
  19,656
  75,342
  50,054
  143,317
  88,675
  291,805
  107,405
  43,278
  17,263
  29,868
  10,212
  75,342
  25,288
  143,317
  54,642
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(ethnicity) min(1) max(5) missing 
  291,805
  218,717
  43,278
  32,455
  29,868
  22,388
  75,342
  57,294
  143,317
  106,580
  291,805
  676
  43,278
  92
  29,868
  54
  75,342
  132
  143,317
  398
  291,805
  3,366
  43,278
  258
  29,868
  357
  75,342
  478
  143,317
  2,273
  291,805
  1,208
  43,278
  103
  29,868
  124
  75,342
  178
  143,317
  803
  291,805
  1,060
  43,278
  113
  29,868
  103
  75,342
  183
  143,317
  661
  291,805
  66,778
  43,278
  10,257
  29,868
  6,842
  75,342
  17,077
  143,317
  32,602

. file write tablecontent _n 

. 
. tabulatevariable, variable(imd) min(1) max(5) missing
  291,805
  58,902
  43,278
  8,049
  29,868
  6,280
  75,342
  13,613
  143,317
  30,960
  291,805
  58,779
  43,278
  8,419
  29,868
  6,100
  75,342
  14,519
  143,317
  29,741
  291,805
  59,175
  43,278
  8,755
  29,868
  6,218
  75,342
  15,017
  143,317
  29,185
  291,805
  57,633
  43,278
  8,431
  29,868
  5,868
  75,342
  15,766
  143,317
  27,568
  291,805
  57,316
  43,278
  9,624
  29,868
  5,402
  75,342
  16,427
  143,317
  25,863
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(diabcat) min(1) max(4) missing
  291,805
  221,197
  43,278
  32,888
  29,868
  22,705
  75,342
  56,826
  143,317
  108,778
  291,805
  51,265
  43,278
  7,583
  29,868
  5,207
  75,342
  13,804
  143,317
  24,671
  291,805
  18,561
  43,278
  2,711
  29,868
  1,872
  75,342
  4,491
  143,317
  9,487
  291,805
  782
  43,278
  96
  29,868
  84
  75,342
  221
  143,317
  381
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0

. file write tablecontent _n 

. 
. file write tablecontent _n _n

. 
. ** COPD TREATMENT VARIABLES (binary)
. foreach treat of varlist        saba_single             ///
>                                                         high_dose_ics           ///
>                                                         low_med_dose_ics        ///
>                                                         ics_single              ///
>                                                         sama_single             ///
>                                                         laba_single                     ///
>                                                         lama_single                     ///
>                                                         laba_ics                        ///
>                                                         laba_lama                       ///
>                                                         laba_lama_ics           ///
>                             ltra_single                 ///     
>                                                 {               
  2. 
. local lab: variable label `treat'
  3. file write tablecontent ("`lab'") _n 
  4.         
. generaterow, variable(`treat') condition("==0")
  5. generaterow, variable(`treat') condition("==1")
  6. 
. file write tablecontent _n
  7. 
. }
  291,805
  125,025
  43,278
  12,349
  29,868
  8,757
  75,342
  12,787
  143,317
  91,132
  291,805
  166,780
  43,278
  30,929
  29,868
  21,111
  75,342
  62,555
  143,317
  52,185
  291,805
  266,112
  43,278
  43,278
  29,868
  22,200
  75,342
  57,548
  143,317
  143,086
  291,805
  25,693
  43,278
  0
  29,868
  7,668
  75,342
  17,794
  143,317
  231
  291,805
  204,577
  43,278
  43,278
  29,868
  7,286
  75,342
  15,453
  143,317
  138,560
  291,805
  87,228
  43,278
  0
  29,868
  22,582
  75,342
  59,889
  143,317
  4,757
  291,805
  284,499
  43,278
  43,278
  29,868
  29,330
  75,342
  73,557
  143,317
  138,334
  291,805
  7,306
  43,278
  0
  29,868
  538
  75,342
  1,785
  143,317
  4,983
  291,805
  288,487
  43,278
  43,120
  29,868
  28,691
  75,342
  75,034
  143,317
  141,642
  291,805
  3,318
  43,278
  158
  29,868
  1,177
  75,342
  308
  143,317
  1,675
  291,805
  283,744
  43,278
  40,849
  29,868
  29,405
  75,342
  74,951
  143,317
  138,539
  291,805
  8,061
  43,278
  2,429
  29,868
  463
  75,342
  391
  143,317
  4,778
  291,805
  204,171
  43,278
  38,690
  29,868
  29,868
  75,342
  29,868
  143,317
  105,745
  291,805
  87,634
  43,278
  4,588
  29,868
  0
  75,342
  45,474
  143,317
  37,572
  291,805
  216,279
  43,278
  43,278
  29,868
  255
  75,342
  29,429
  143,317
  143,317
  291,805
  75,526
  43,278
  0
  29,868
  29,613
  75,342
  45,913
  143,317
  0
  291,805
  245,652
  43,278
  1,929
  29,868
  28,785
  75,342
  71,621
  143,317
  143,317
  291,805
  46,153
  43,278
  41,349
  29,868
  1,083
  75,342
  3,721
  143,317
  0
  291,805
  258,774
  43,278
  43,278
  29,868
  29,868
  75,342
  42,311
  143,317
  143,317
  291,805
  33,031
  43,278
  0
  29,868
  0
  75,342
  33,031
  143,317
  0
  291,805
  291,805
  43,278
  43,278
  29,868
  29,868
  75,342
  75,342
  143,317
  143,317
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0

. 
. ** COMORBIDITIES (categorical and continous)
. 
. ** COMORBIDITIES (binary)
. 
. foreach comorb of varlist       asthma_ever                                             ///
>                                                         ckd                                                             ///
>                                                         copd                                                    ///
>                                                         hypertension                                    ///
>                                                         heart_failure                                   ///
>                                                         other_heart_disease                             ///
>                                                         diabetes                                                ///
>                                                         cancer_ever                                     ///
>                                                         immunodef_any                                   ///
>                                                         other_respiratory                               ///
>                                                         statin                                                  ///
>                                                         insulin                                                 ///
>                                                         oral_steroids                                   ///
>                                                         flu_vaccine                                     ///
>                                                         pneumococcal_vaccine                    ///
>                                                         exacerbations                                   ///
>                                                         gp_consult {
  2. 
. local lab: variable label `comorb'
  3. file write tablecontent ("`lab'") _n 
  4.                                                         
. generaterow, variable(`comorb') condition("==0")
  5. generaterow, variable(`comorb') condition("==1")
  6. file write tablecontent _n
  7. 
. }
  291,805
  236,592
  43,278
  37,705
  29,868
  21,994
  75,342
  54,039
  143,317
  122,854
  291,805
  55,213
  43,278
  5,573
  29,868
  7,874
  75,342
  21,303
  143,317
  20,463
  291,805
  241,927
  43,278
  35,547
  29,868
  24,515
  75,342
  62,342
  143,317
  119,523
  291,805
  49,878
  43,278
  7,731
  29,868
  5,353
  75,342
  13,000
  143,317
  23,794
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0
  291,805
  291,805
  43,278
  43,278
  29,868
  29,868
  75,342
  75,342
  143,317
  143,317
  291,805
  146,895
  43,278
  21,595
  29,868
  14,433
  75,342
  36,528
  143,317
  74,339
  291,805
  144,910
  43,278
  21,683
  29,868
  15,435
  75,342
  38,814
  143,317
  68,978
  291,805
  267,221
  43,278
  39,424
  29,868
  27,365
  75,342
  67,890
  143,317
  132,542
  291,805
  24,584
  43,278
  3,854
  29,868
  2,503
  75,342
  7,452
  143,317
  10,775
  291,805
  226,356
  43,278
  33,233
  29,868
  23,386
  75,342
  57,728
  143,317
  112,009
  291,805
  65,449
  43,278
  10,045
  29,868
  6,482
  75,342
  17,614
  143,317
  31,308
  291,805
  221,197
  43,278
  32,888
  29,868
  22,705
  75,342
  56,826
  143,317
  108,778
  291,805
  70,608
  43,278
  10,390
  29,868
  7,163
  75,342
  18,516
  143,317
  34,539
  291,805
  251,789
  43,278
  37,060
  29,868
  25,788
  75,342
  64,356
  143,317
  124,585
  291,805
  40,016
  43,278
  6,218
  29,868
  4,080
  75,342
  10,986
  143,317
  18,732
  291,805
  290,160
  43,278
  43,073
  29,868
  29,683
  75,342
  74,989
  143,317
  142,415
  291,805
  1,645
  43,278
  205
  29,868
  185
  75,342
  353
  143,317
  902
  291,805
  291,805
  43,278
  43,278
  29,868
  29,868
  75,342
  75,342
  143,317
  143,317
  291,805
  0
  43,278
  0
  29,868
  0
  75,342
  0
  143,317
  0
  291,805
  150,420
  43,278
  20,517
  29,868
  15,362
  75,342
  35,532
  143,317
  79,009
  291,805
  141,385
  43,278
  22,761
  29,868
  14,506
  75,342
  39,810
  143,317
  64,308
  291,805
  283,085
  43,278
  42,053
  29,868
  28,968
  75,342
  73,176
  143,317
  138,888
  291,805
  8,720
  43,278
  1,225
  29,868
  900
  75,342
  2,166
  143,317
  4,429
  291,805
  230,237
  43,278
  34,141
  29,868
  22,604
  75,342
  45,786
  143,317
  127,706
  291,805
  61,568
  43,278
  9,137
  29,868
  7,264
  75,342
  29,556
  143,317
  15,611
  291,805
  73,828
  43,278
  8,683
  29,868
  6,666
  75,342
  13,238
  143,317
  45,241
  291,805
  217,977
  43,278
  34,595
  29,868
  23,202
  75,342
  62,104
  143,317
  98,076
  291,805
  231,323
  43,278
  32,266
  29,868
  23,827
  75,342
  60,079
  143,317
  115,151
  291,805
  60,482
  43,278
  11,012
  29,868
  6,041
  75,342
  15,263
  143,317
  28,166
  291,805
  236,123
  43,278
  34,748
  29,868
  23,527
  75,342
  54,331
  143,317
  123,517
  291,805
  55,682
  43,278
  8,530
  29,868
  6,341
  75,342
  21,011
  143,317
  19,800
  291,805
  8,476
  43,278
  492
  29,868
  510
  75,342
  999
  143,317
  6,475
  291,805
  283,329
  43,278
  42,786
  29,868
  29,358
  75,342
  74,343
  143,317
  136,842

. 
. * COMORBIDITIES (continous)
. 
. summarizevariable, variable(gp_consult_count)

. summarizevariable, variable(exacerbation_count)

. summarizevariable, variable(age)

. 
. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log_sens1\S1-04_an_descriptive_table_copd.log
  log type:  text
 closed on:   9 Jun 2020, 11:35:21
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
