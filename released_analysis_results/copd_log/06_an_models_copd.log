----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\06_an_models_copd.log
  log type:  text
 opened on:  24 Jul 2020, 09:39:30

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Sense check outcomes=======================================================*/ 
. 
. tab exposure $outcome, missing row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: ONS covid
       COPD Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
LABA/LAMA Combination |    43,217         91 |    43,308 
                      |     99.79       0.21 |    100.00 
----------------------+----------------------+----------
      ICS Combination |   104,911        338 |   105,249 
                      |     99.68       0.32 |    100.00 
----------------------+----------------------+----------
                Other |   143,227        313 |   143,540 
                      |     99.78       0.22 |    100.00 
----------------------+----------------------+----------
                Total |   291,355        742 |   292,097 
                      |     99.75       0.25 |    100.00 

. 
. /* Main Model=================================================================*/
. 
. *Post to a stata dataset for appending with other results later
. capture postfile temp str30 outcome str30 population str30 level str30 title estimate min95 max95 using "$tempdir/temp_copd.dta",replace

. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5105.7923
Iteration 1:   log likelihood = -5098.8056
Iteration 2:   log likelihood = -5098.7475
Iteration 3:   log likelihood = -5098.7475
Refining estimates:
Iteration 0:   log likelihood = -5098.7475

Cox regression -- Breslow method for ties

No. of subjects =      148,557                  Number of obs    =     148,557
No. of failures =          429
Time at risk    =      9751453
                                                LR chi2(1)       =       14.09
Log likelihood  =   -5098.7475                  Prob > chi2      =      0.0002

----------------------------------------------------------------------------------
              _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        exposure |
ICS Combination  |   1.531689   .1808923     3.61   0.000     1.215188    1.930622
----------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
file ./copd_tempdata/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5105.7923
Iteration 1:   log likelihood = -4907.1247
Iteration 2:   log likelihood =  -4869.758
Iteration 3:   log likelihood = -4867.8134
Iteration 4:   log likelihood = -4867.7242
Iteration 5:   log likelihood = -4867.7235
Iteration 6:   log likelihood = -4867.7235
Refining estimates:
Iteration 0:   log likelihood = -4867.7235

Cox regression -- Breslow method for ties

No. of subjects =      148,557                  Number of obs    =     148,557
No. of failures =          429
Time at risk    =      9751453
                                                LR chi2(5)       =      476.14
Log likelihood  =   -4867.7235                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------
              _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        exposure |
ICS Combination  |   1.426807   .1685832     3.01   0.003     1.131858    1.798615
          1.male |   1.754351   .1817014     5.43   0.000     1.432043    2.149201
            age1 |   1.044186   .0472074     0.96   0.339     .9556418    1.140934
            age2 |   1.119608   .0898268     1.41   0.159     .9566948    1.310262
            age3 |   .6686459   .2089448    -1.29   0.198     .3624137    1.233638
----------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
file ./copd_tempdata/multivar1.ster saved

.   
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)                                                                                                            

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -3752.968
Iteration 1:   log likelihood = -3707.6093
Iteration 2:   log likelihood = -3467.0015
Iteration 3:   log likelihood = -3445.1794
Iteration 4:   log likelihood = -3444.2007
Iteration 5:   log likelihood =  -3444.179
Iteration 6:   log likelihood = -3444.1789
Refining estimates:
Iteration 0:   log likelihood = -3444.1789

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      148,557                  Number of obs    =     148,557
No. of failures =          429
Time at risk    =      9751453
                                                LR chi2(27)      =      617.58
Log likelihood  =   -3444.1789                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
           ICS Combination  |    1.39087   .1685448     2.72   0.006     1.096828     1.76374
                     1.male |    1.72225   .1826043     5.13   0.000     1.399092     2.12005
                       age1 |    1.04105   .0472369     0.89   0.375     .9524645    1.137874
                       age2 |   1.095673   .0883443     1.13   0.257     .9355102    1.283257
                       age3 |   .7214074   .2269358    -1.04   0.299      .389417     1.33643
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.148933   .1420575     1.12   0.261     .9016745    1.463996
        Obese II (35-39.9)  |   1.274165   .2301911     1.34   0.180     .8942262    1.815533
           Obese III (40+)  |   1.772486   .4255288     2.38   0.017     1.107212    2.837492
                            |
               smoke_nomiss |
                   Current  |   .5942096   .0895876    -3.45   0.001      .442187    .7984971
                            |
                        imd |
                         2  |   .9609012   .1434719    -0.27   0.789     .7171104    1.287572
                         3  |   .7868556   .1263829    -1.49   0.136     .5743506    1.077986
                         4  |    1.19294   .1815413     1.16   0.246     .8852847    1.607512
           5 most deprived  |   1.439739   .2257694     2.32   0.020     1.058777    1.957777
                            |
                        ckd |
                       CKD  |   1.651443   .1789556     4.63   0.000     1.335441    2.042219
             1.hypertension |   .9738829   .1051416    -0.25   0.806      .788152    1.203382
            1.heart_failure |   1.643566   .1963089     4.16   0.000     1.300526     2.07709
      1.other_heart_disease |   1.123439   .1236158     1.06   0.290      .905501    1.393831
                            |
                    diabcat |
       Controlled diabetes  |    1.37356   .1595493     2.73   0.006     1.093891     1.72473
     Uncontrolled diabetes  |     1.6433   .2762112     2.96   0.003     1.182072    2.284491
Diabetes, no hba1c measure  |   1.638509   1.168344     0.69   0.489     .4050389    6.628281
                            |
              1.cancer_ever |   1.060261   .1279851     0.48   0.628     .8368808    1.343266
                   1.statin |   .8464061   .0907205    -1.56   0.120     .6860319    1.044271
              1.flu_vaccine |    .864368   .1216364    -1.04   0.300     .6560171    1.138891
     1.pneumococcal_vaccine |   .9355952    .148654    -0.42   0.675     .6852406    1.277418
            1.exacerbations |   1.443892   .1497993     3.54   0.000     1.178217    1.769474
              1.asthma_ever |   .8264591   .0965487    -1.63   0.103     .6573281    1.039108
            1.immunodef_any |   1.698843   1.703295     0.53   0.597     .2380791    12.12231
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estimates save ./$tempdir/multivar2, replace
file ./copd_tempdata/multivar2.ster saved

.    
. 
. /* Print table================================================================*/ 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current ICS use and $tableoutcome - $population Population") _n

. file write tablecontent _tab _tab _tab _tab ("Univariable") _tab _tab ("Age/Sex Adjusted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _tab _n

. file write tablecontent _tab ("Events") _tab ("Person-weeks") _tab ("Rate per 1,000") _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("95% CI") _n                               

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts and Rates */
.  
. * First row, exposure = 0 (reference)
. 
.         count if exposure == 0 & $outcome == 1
  91

.         local event = r(N)

.     bysort exposure: egen total_follow_up = total(_t)

.         summarize total_follow_up if exposure == 0

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |     43,308     2846060           0    2846060    2846060

.         local person_week = r(mean)/7

.         * note, mean is fine as total_follow_up the same for each person 
.         local rate = 1000*(`event'/`person_week')

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _tab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (comparator)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         count if exposure == 1 & $outcome == 1
  338

.         local event = r(N)

.         summarize total_follow_up if exposure == 1

    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
total_foll~p |    105,249     6905393           0    6905393    6905393

.         local person_week = r(mean)/7

.         local rate = 1000*(`event'/`person_week')

.         file write tablecontent (`event') _tab %10.0f (`person_week') _tab %3.2f (`rate') _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.531689   .1808923     3.61   0.000     1.215188    1.930622
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. post temp ("$tableoutcome") ("$population") ("Univariable") ("`lab1'") (round(r(estimate)),0.01) (round(r(lb)),0.01) (round(r(ub)),0.01)           

.       
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.426807   .1685832     3.01   0.003     1.131858    1.798615
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _tab 

. post temp ("$tableoutcome") ("$population") ("Age/Sex adjusted") ("`lab1'") (round(r(estimate)),0.01) (round(r(lb)),0.01) (round(r(ub)),0.01)           

. 
. estimates use ./$tempdir/multivar2 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.39087   .1685448     2.72   0.006     1.096828     1.76374
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r(ub)) _n 

. post temp ("$tableoutcome") ("$population") ("Fully adjusted") ("`lab1'") (round(r(estimate)),0.01) (round(r(lb)),0.01) (round(r(ub)),0.01)

. 
. file write tablecontent _n

. file close tablecontent

. postclose temp  

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\06_an_models_copd.log
  log type:  text
 closed on:  24 Jul 2020, 09:39:55
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
