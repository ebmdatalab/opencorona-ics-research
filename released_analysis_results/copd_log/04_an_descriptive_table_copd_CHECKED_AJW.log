--------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\04_an_descriptive_table_copd.log
  log type:  text
 opened on:  22 May 2020, 09:12:43

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset, clear

. 
. /* PROGRAMS TO AUTOMATE TABULATIONS===========================================*/ 
. 
. ********************************************************************************
. * All below code from K Baskharan 
. * Generic code to output one row of table
. 
. cap prog drop generaterow

. program define generaterow
  1. syntax, variable(varname) condition(string) 
  2.         
.         cou
  3.         local overalldenom=r(N)
  4.         
.         qui sum `variable' if `variable' `condition'
  5.         file write tablecontent (r(max)) _tab
  6.         
.         cou if `variable' `condition'
  7.         local rowdenom = r(N)
  8.         local colpct = 100*(r(N)/`overalldenom')
  9.         file write tablecontent %9.0gc (`rowdenom')  (" (") %3.1f (`colpct') (")") _tab
 10. 
.         cou if exposure == 0 
 11.         local rowdenom = r(N)
 12.         cou if exposure == 0 & `variable' `condition'
 13.         local pct = 100*(r(N)/`rowdenom') 
 14.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _tab
 15. 
.         cou if exposure == 1 
 16.         local rowdenom = r(N)
 17.         cou if exposure == 1 & `variable' `condition'
 18.         local pct = 100*(r(N)/`rowdenom')
 19.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 20. 
.         cou if exposure >= .
 21.         local rowdenom = r(N)
 22.         cou if exposure >= . & `variable' `condition'
 23.         local pct = 100*(r(N)/`rowdenom')
 24.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _n
 25.         
. end

. 
. /* Explanatory Notes 
> 
> defines a program (SAS macro/R function equivalent), generate row
> the syntax row specifies two inputs for the program: 
> 
>         a VARNAME which is your variable 
>         a CONDITION which is a string of some condition you impose 
>         
> the program counts if variable and condition and returns the counts
> column percentages are then automatically generated
> this is then written to the text file 'tablecontent' 
> the number followed by space, brackets, formatted pct, end bracket and then tab
> 
> the format %3.1f specifies length of 3, followed by 1 dp. 
> 
> */ 
. 
. ********************************************************************************
. * Generic code to output one section (varible) within table (calls above)
. 
. cap prog drop tabulatevariable

. prog define tabulatevariable
  1. syntax, variable(varname) min(real) max(real) [missing]
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4. 
.         forvalues varlevel = `min'/`max'{ 
  5.                 generaterow, variable(`variable') condition("==`varlevel'")
  6.         }
  7.         
.         if "`missing'"!="" generaterow, variable(`variable') condition(">=.")
  8. 
. end

. 
. ********************************************************************************
. 
. /* Explanatory Notes 
> 
> defines program tabulate variable 
> syntax is : 
> 
>         - a VARNAME which you stick in variable 
>         - a numeric minimum 
>         - a numeric maximum 
>         - optional missing option, default value is . 
> 
> forvalues lowest to highest of the variable, manually set for each var
> run the generate row program for the level of the variable 
> if there is a missing specified, then run the generate row for missing vals
> 
> */ 
. 
. ********************************************************************************
. * Generic code to summarize a continous variable 
. 
. cap prog drop summarizevariable 

. prog define summarizevariable
  1. syntax, variable(varname) 
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4.         
.         qui summarize `variable', d
  5.         file write tablecontent ("Median (IQR)") _tab 
  6.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  7.                                                         
.         qui summarize `variable' if exposure == 0, d
  8.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  9. 
.         qui summarize `variable' if exposure == 1, d
 10.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 11. 
.         qui summarize `variable' if exposure >= ., d
 12.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _n
 13.         
.         qui summarize `variable', d
 14.         file write tablecontent ("Min, Max") _tab 
 15.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 16.                                                         
.         qui summarize `variable' if exposure == 0, d
 17.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 18. 
.         qui summarize `variable' if exposure == 1, d
 19.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 20. 
.         qui summarize `variable' if exposure >= ., d
 21.         file write tablecontent (r(min)) (", ") (r(max)) ("") _n
 22.         
. end

. 
. /* QUESTION FOR STATA REVIEWER - I WROTE THIS CONTINOUS VAR SUMMARY PROGRAM
> but I don't quite understand why I seem to need ("") on the last row for the 
> maxium value to display properly? Otherwise it seems to just be missing. 
> 
> Please check this extra carefully as well
> 
> */ 
. 
. /* INVOKE PROGRAMS FOR TABLE 1================================================*/ 
. 
. *Set up output file
. cap file close tablecontent

. file open tablecontent using ./$outdir/table1.txt, write text replace

. 
. file write tablecontent ("Table 1: Demographic and Clinical Characteristics - $Population") _n

. 
. * Exposure labelled columns
. 
. local lab0: label exposure 0

. local lab1: label exposure 1

. local labu: label exposure .u

. 
. file write tablecontent _tab ("Total")                                                    _tab ///
>                                                          ("`lab0'")                                   
>                 _tab ///
>                                                          ("`lab1'")                                   
>             _tab ///
>                                                          ("`labu'")                                   
>                     _n 

. 
. * DEMOGRAPHICS (more than one level, potentially missing) 
. 
. gen byte cons=1

. tabulatevariable, variable(cons) min(1) max(1) 
  291,868
  291,868
  43,282
  43,282
  105,251
  105,251
  143,335
  143,335

. file write tablecontent _n 

. 
. tabulatevariable, variable(agegroup) min(1) max(6) 
  291,868
  1,232
  43,282
  85
  105,251
  185
  143,335
  962
  291,868
  10,025
  43,282
  1,060
  105,251
  2,290
  143,335
  6,675
  291,868
  40,910
  43,282
  5,746
  105,251
  12,239
  143,335
  22,925
  291,868
  80,792
  43,282
  12,596
  105,251
  29,526
  143,335
  38,670
  291,868
  104,351
  43,282
  16,098
  105,251
  40,385
  143,335
  47,868
  291,868
  54,558
  43,282
  7,697
  105,251
  20,626
  143,335
  26,235

. file write tablecontent _n 

. 
. tabulatevariable, variable(male) min(0) max(1) 
  291,868
  133,771
  43,282
  19,698
  105,251
  48,721
  143,335
  65,352
  291,868
  158,097
  43,282
  23,584
  105,251
  56,530
  143,335
  77,983

. file write tablecontent _n 

. 
. tabulatevariable, variable(bmicat) min(1) max(6) missing
  291,868
  11,358
  43,282
  1,682
  105,251
  4,745
  143,335
  4,931
  291,868
  89,200
  43,282
  12,939
  105,251
  31,870
  143,335
  44,391
  291,868
  95,475
  43,282
  14,010
  105,251
  33,510
  143,335
  47,955
  291,868
  55,550
  43,282
  8,588
  105,251
  20,284
  143,335
  26,678
  291,868
  22,066
  43,282
  3,572
  105,251
  8,382
  143,335
  10,112
  291,868
  10,011
  43,282
  1,579
  105,251
  3,948
  143,335
  4,484
  291,868
  8,208
  43,282
  912
  105,251
  2,512
  143,335
  4,784

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke) min(1) max(3) missing 
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0
  291,868
  184,444
  43,282
  26,013
  105,251
  69,725
  143,335
  88,706
  291,868
  107,424
  43,282
  17,269
  105,251
  35,526
  143,335
  54,629
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(ethnicity) min(1) max(5) missing 
  291,868
  218,768
  43,282
  32,459
  105,251
  79,718
  143,335
  106,591
  291,868
  674
  43,282
  92
  105,251
  184
  143,335
  398
  291,868
  3,363
  43,282
  257
  105,251
  833
  143,335
  2,273
  291,868
  1,209
  43,282
  103
  105,251
  302
  143,335
  804
  291,868
  1,061
  43,282
  114
  105,251
  288
  143,335
  659
  291,868
  66,793
  43,282
  10,257
  105,251
  23,926
  143,335
  32,610

. file write tablecontent _n 

. 
. tabulatevariable, variable(imd) min(1) max(5) missing
  291,868
  58,967
  43,282
  8,056
  105,251
  19,921
  143,335
  30,990
  291,868
  58,791
  43,282
  8,427
  105,251
  20,637
  143,335
  29,727
  291,868
  59,170
  43,282
  8,749
  105,251
  21,231
  143,335
  29,190
  291,868
  57,637
  43,282
  8,425
  105,251
  21,639
  143,335
  27,573
  291,868
  57,303
  43,282
  9,625
  105,251
  21,823
  143,335
  25,855
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0

. file write tablecontent _n 

. 
. file write tablecontent _n _n

. 
. ** COPD TREATMENT VARIABLES (binary)
. foreach treat of varlist        saba_single             ///
>                                                         high_dose_ics           ///
>                                                         low_med_dose_ics        ///
>                                                         ics_single              ///
>                                                         sama_single             ///
>                                                         laba_single                     ///
>                                                         lama_single                     ///
>                                                         laba_ics                        ///
>                                                         laba_lama                       ///
>                                                         laba_lama_ics           ///
>                             ltra_single                 ///     
>                                                 {               
  2. 
. local lab: variable label `treat'
  3. file write tablecontent ("`lab'") _n 
  4.         
. generaterow, variable(`treat') condition("==0")
  5. generaterow, variable(`treat') condition("==1")
  6. 
. file write tablecontent _n
  7. 
. }
  291,868
  125,038
  43,282
  12,351
  105,251
  21,545
  143,335
  91,142
  291,868
  166,830
  43,282
  30,931
  105,251
  83,706
  143,335
  52,193
  291,868
  266,157
  43,282
  43,282
  105,251
  79,771
  143,335
  143,104
  291,868
  25,711
  43,282
  0
  105,251
  25,480
  143,335
  231
  291,868
  204,612
  43,282
  43,282
  105,251
  22,753
  143,335
  138,577
  291,868
  87,256
  43,282
  0
  105,251
  82,498
  143,335
  4,758
  291,868
  284,559
  43,282
  43,282
  105,251
  102,926
  143,335
  138,351
  291,868
  7,309
  43,282
  0
  105,251
  2,325
  143,335
  4,984
  291,868
  288,547
  43,282
  43,123
  105,251
  103,764
  143,335
  141,660
  291,868
  3,321
  43,282
  159
  105,251
  1,487
  143,335
  1,675
  291,868
  283,805
  43,282
  40,852
  105,251
  104,397
  143,335
  138,556
  291,868
  8,063
  43,282
  2,430
  105,251
  854
  143,335
  4,779
  291,868
  204,195
  43,282
  38,692
  105,251
  59,758
  143,335
  105,745
  291,868
  87,673
  43,282
  4,590
  105,251
  45,493
  143,335
  37,590
  291,868
  216,312
  43,282
  43,282
  105,251
  29,695
  143,335
  143,335
  291,868
  75,556
  43,282
  0
  105,251
  75,556
  143,335
  0
  291,868
  245,709
  43,282
  1,930
  105,251
  100,444
  143,335
  143,335
  291,868
  46,159
  43,282
  41,352
  105,251
  4,807
  143,335
  0
  291,868
  258,826
  43,282
  43,282
  105,251
  72,209
  143,335
  143,335
  291,868
  33,042
  43,282
  0
  105,251
  33,042
  143,335
  0
  291,868
  291,868
  43,282
  43,282
  105,251
  105,251
  143,335
  143,335
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0

. 
. ** COMORBIDITIES (categorical and continous)
. 
. ** COMORBIDITIES (binary)
. 
. foreach comorb of varlist       asthma_ever                                             ///
>                                                         ckd                                           
>                   ///
>                                                         copd                                          
>           ///
>                                                         hypertension                                  
>   ///
>                                                         heart_failure                                 
>   ///
>                                                         other_heart_disease                           
>   ///
>                                                         diabetes                                      
>           ///
>                                                         cancer_ever                                   
>   ///
>                                                         immunodef_any                                 
>   ///
>                                                         other_respiratory                             
>   ///
>                                                         statin                                        
>           ///
>                                                         insulin                                       
>           ///
>                                                         oral_steroids                                 
>   ///
>                                                         flu_vaccine                                   
>   ///
>                                                         pneumococcal_vaccine                    ///
>                                                         exacerbations                                 
>   ///
>                                                         gp_consult {
  2. 
. local lab: variable label `comorb'
  3. file write tablecontent ("`lab'") _n 
  4.                                                         
. generaterow, variable(`comorb') condition("==0")
  5. generaterow, variable(`comorb') condition("==1")
  6. file write tablecontent _n
  7. 
. }
  291,868
  236,635
  43,282
  37,704
  105,251
  76,067
  143,335
  122,864
  291,868
  55,233
  43,282
  5,578
  105,251
  29,184
  143,335
  20,471
  291,868
  9,573
  43,282
  1,268
  105,251
  2,984
  143,335
  5,321
  291,868
  57,217
  43,282
  8,756
  105,251
  20,981
  143,335
  27,480
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0
  291,868
  291,868
  43,282
  43,282
  105,251
  105,251
  143,335
  143,335
  291,868
  146,932
  43,282
  21,601
  105,251
  50,986
  143,335
  74,345
  291,868
  144,936
  43,282
  21,681
  105,251
  54,265
  143,335
  68,990
  291,868
  267,295
  43,282
  39,432
  105,251
  95,299
  143,335
  132,564
  291,868
  24,573
  43,282
  3,850
  105,251
  9,952
  143,335
  10,771
  291,868
  226,407
  43,282
  33,240
  105,251
  81,148
  143,335
  112,019
  291,868
  65,461
  43,282
  10,042
  105,251
  24,103
  143,335
  31,316
  291,868
  221,238
  43,282
  32,888
  105,251
  79,561
  143,335
  108,789
  291,868
  70,630
  43,282
  10,394
  105,251
  25,690
  143,335
  34,546
  291,868
  251,831
  43,282
  37,061
  105,251
  90,179
  143,335
  124,591
  291,868
  40,037
  43,282
  6,221
  105,251
  15,072
  143,335
  18,744
  291,868
  290,221
  43,282
  43,077
  105,251
  104,712
  143,335
  142,432
  291,868
  1,647
  43,282
  205
  105,251
  539
  143,335
  903
  291,868
  291,868
  43,282
  43,282
  105,251
  105,251
  143,335
  143,335
  291,868
  0
  43,282
  0
  105,251
  0
  143,335
  0
  291,868
  150,448
  43,282
  20,518
  105,251
  50,916
  143,335
  79,014
  291,868
  141,420
  43,282
  22,764
  105,251
  54,335
  143,335
  64,321
  291,868
  283,143
  43,282
  42,055
  105,251
  102,184
  143,335
  138,904
  291,868
  8,725
  43,282
  1,227
  105,251
  3,067
  143,335
  4,431
  291,868
  230,263
  43,282
  34,136
  105,251
  68,410
  143,335
  127,717
  291,868
  61,605
  43,282
  9,146
  105,251
  36,841
  143,335
  15,618
  291,868
  88,776
  43,282
  10,898
  105,251
  25,868
  143,335
  52,010
  291,868
  203,092
  43,282
  32,384
  105,251
  79,383
  143,335
  91,325
  291,868
  232,576
  43,282
  32,447
  105,251
  84,450
  143,335
  115,679
  291,868
  59,292
  43,282
  10,835
  105,251
  20,801
  143,335
  27,656
  291,868
  236,167
  43,282
  34,749
  105,251
  77,883
  143,335
  123,535
  291,868
  55,701
  43,282
  8,533
  105,251
  27,368
  143,335
  19,800
  291,868
  8,477
  43,282
  492
  105,251
  1,513
  143,335
  6,472
  291,868
  283,391
  43,282
  42,790
  105,251
  103,738
  143,335
  136,863

. 
. * COMORBIDITIES (continous)
. 
. summarizevariable, variable(gp_consult_count)

. summarizevariable, variable(exacerbation_count)

. 
. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\04_an_descriptive_table_copd.log
  log type:  text
 closed on:  22 May 2020, 09:12:52
--------------------------------------------------------------------------------------------------------
