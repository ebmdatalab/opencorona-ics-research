-------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\04_an_descriptive_table_copd.log
  log type:  text
 opened on:  27 May 2020, 10:30:28

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset, clear

. 
. /* PROGRAMS TO AUTOMATE TABULATIONS===========================================*/ 
. 
. ********************************************************************************
. * All below code from K Baskharan 
. * Generic code to output one row of table
. 
. cap prog drop generaterow

. program define generaterow
  1. syntax, variable(varname) condition(string) 
  2.         
.         cou
  3.         local overalldenom=r(N)
  4.         
.         qui sum `variable' if `variable' `condition'
  5.         file write tablecontent (r(max)) _tab
  6.         
.         cou if `variable' `condition'
  7.         local rowdenom = r(N)
  8.         local colpct = 100*(r(N)/`overalldenom')
  9.         file write tablecontent %9.0gc (`rowdenom')  (" (") %3.1f (`colpct') (")") _tab
 10. 
.         cou if exposure == 0 
 11.         local rowdenom = r(N)
 12.         cou if exposure == 0 & `variable' `condition'
 13.         local pct = 100*(r(N)/`rowdenom') 
 14.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _tab
 15. 
.         cou if exposure == 1 
 16.         local rowdenom = r(N)
 17.         cou if exposure == 1 & `variable' `condition'
 18.         local pct = 100*(r(N)/`rowdenom')
 19.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f  (`pct') (")") _tab
 20. 
.         cou if exposure >= .
 21.         local rowdenom = r(N)
 22.         cou if exposure >= . & `variable' `condition'
 23.         local pct = 100*(r(N)/`rowdenom')
 24.         file write tablecontent %9.0gc (r(N)) (" (") %3.1f (`pct') (")") _n
 25.         
. end

. 
. /* Explanatory Notes 
> 
> defines a program (SAS macro/R function equivalent), generate row
> the syntax row specifies two inputs for the program: 
> 
>         a VARNAME which is your variable 
>         a CONDITION which is a string of some condition you impose 
>         
> the program counts if variable and condition and returns the counts
> column percentages are then automatically generated
> this is then written to the text file 'tablecontent' 
> the number followed by space, brackets, formatted pct, end bracket and then tab
> 
> the format %3.1f specifies length of 3, followed by 1 dp. 
> 
> */ 
. 
. ********************************************************************************
. * Generic code to output one section (varible) within table (calls above)
. 
. cap prog drop tabulatevariable

. prog define tabulatevariable
  1. syntax, variable(varname) min(real) max(real) [missing]
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4. 
.         forvalues varlevel = `min'/`max'{ 
  5.                 generaterow, variable(`variable') condition("==`varlevel'")
  6.         }
  7.         
.         if "`missing'"!="" generaterow, variable(`variable') condition(">=.")
  8. 
. end

. 
. ********************************************************************************
. 
. /* Explanatory Notes 
> 
> defines program tabulate variable 
> syntax is : 
> 
>         - a VARNAME which you stick in variable 
>         - a numeric minimum 
>         - a numeric maximum 
>         - optional missing option, default value is . 
> 
> forvalues lowest to highest of the variable, manually set for each var
> run the generate row program for the level of the variable 
> if there is a missing specified, then run the generate row for missing vals
> 
> */ 
. 
. ********************************************************************************
. * Generic code to summarize a continous variable 
. 
. cap prog drop summarizevariable 

. prog define summarizevariable
  1. syntax, variable(varname) 
  2. 
.         local lab: variable label `variable'
  3.         file write tablecontent ("`lab'") _n 
  4.         
.         qui summarize `variable', d
  5.         file write tablecontent ("Median (IQR)") _tab 
  6.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  7.                                                         
.         qui summarize `variable' if exposure == 0, d
  8.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
  9. 
.         qui summarize `variable' if exposure == 1, d
 10.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _tab
 11. 
.         qui summarize `variable' if exposure >= ., d
 12.         file write tablecontent (r(p50)) (" (") (r(p25)) ("-") (r(p75)) (")") _n
 13.         
.         qui summarize `variable', d
 14.         file write tablecontent ("Min, Max") _tab 
 15.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 16.                                                         
.         qui summarize `variable' if exposure == 0, d
 17.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 18. 
.         qui summarize `variable' if exposure == 1, d
 19.         file write tablecontent (r(min)) (", ") (r(max)) ("") _tab
 20. 
.         qui summarize `variable' if exposure >= ., d
 21.         file write tablecontent (r(min)) (", ") (r(max)) ("") _n
 22.         
. end

. 
. /* QUESTION FOR STATA REVIEWER - I WROTE THIS CONTINOUS VAR SUMMARY PROGRAM
> but I don't quite understand why I seem to need ("") on the last row for the 
> maxium value to display properly? Otherwise it seems to just be missing. 
> 
> Please check this extra carefully as well
> 
> */ 
. 
. /* INVOKE PROGRAMS FOR TABLE 1================================================*/ 
. 
. *Set up output file
. cap file close tablecontent

. file open tablecontent using ./$outdir/table1.txt, write text replace

. 
. file write tablecontent ("Table 1: Demographic and Clinical Characteristics - $population") _n

. 
. * Exposure labelled columns
. 
. local lab0: label exposure 0

. local lab1: label exposure 1

. local labu: label exposure .u

. 
. file write tablecontent _tab ("Total")                                                    _tab ///
>                                                          ("`lab0'")                                        
>            _tab ///
>                                                          ("`lab1'")                                        
>        _tab ///
>                                                          ("`labu'")                                        
>                _n 

. 
. * DEMOGRAPHICS (more than one level, potentially missing) 
. 
. gen byte cons=1

. tabulatevariable, variable(cons) min(1) max(1) 
  291,825
  291,825
  43,276
  43,276
  105,231
  105,231
  143,318
  143,318

. file write tablecontent _n 

. 
. tabulatevariable, variable(agegroup) min(1) max(6) 
  291,825
  1,232
  43,276
  85
  105,231
  185
  143,318
  962
  291,825
  10,025
  43,276
  1,060
  105,231
  2,290
  143,318
  6,675
  291,825
  40,908
  43,276
  5,746
  105,231
  12,238
  143,318
  22,924
  291,825
  80,784
  43,276
  12,595
  105,231
  29,523
  143,318
  38,666
  291,825
  104,338
  43,276
  16,096
  105,231
  40,378
  143,318
  47,864
  291,825
  54,538
  43,276
  7,694
  105,231
  20,617
  143,318
  26,227

. file write tablecontent _n 

. 
. tabulatevariable, variable(male) min(0) max(1) 
  291,825
  133,750
  43,276
  19,696
  105,231
  48,713
  143,318
  65,341
  291,825
  158,075
  43,276
  23,580
  105,231
  56,518
  143,318
  77,977

. file write tablecontent _n 

. 
. tabulatevariable, variable(bmicat) min(1) max(6) missing
  291,825
  11,356
  43,276
  1,682
  105,231
  4,744
  143,318
  4,930
  291,825
  89,184
  43,276
  12,935
  105,231
  31,863
  143,318
  44,386
  291,825
  95,463
  43,276
  14,009
  105,231
  33,504
  143,318
  47,950
  291,825
  55,545
  43,276
  8,587
  105,231
  20,281
  143,318
  26,677
  291,825
  22,063
  43,276
  3,572
  105,231
  8,381
  143,318
  10,110
  291,825
  10,008
  43,276
  1,579
  105,231
  3,947
  143,318
  4,482
  291,825
  8,206
  43,276
  912
  105,231
  2,511
  143,318
  4,783

. file write tablecontent _n 

. 
. tabulatevariable, variable(smoke) min(1) max(3) missing 
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0
  291,825
  184,415
  43,276
  26,011
  105,231
  69,711
  143,318
  88,693
  291,825
  107,410
  43,276
  17,265
  105,231
  35,520
  143,318
  54,625
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(ethnicity) min(1) max(5) missing 
  291,825
  218,731
  43,276
  32,453
  105,231
  79,701
  143,318
  106,577
  291,825
  674
  43,276
  92
  105,231
  185
  143,318
  397
  291,825
  3,365
  43,276
  258
  105,231
  833
  143,318
  2,274
  291,825
  1,210
  43,276
  103
  105,231
  302
  143,318
  805
  291,825
  1,058
  43,276
  113
  105,231
  287
  143,318
  658
  291,825
  66,787
  43,276
  10,257
  105,231
  23,923
  143,318
  32,607

. file write tablecontent _n 

. 
. tabulatevariable, variable(imd) min(1) max(5) missing
  291,825
  58,961
  43,276
  8,055
  105,231
  19,917
  143,318
  30,989
  291,825
  58,783
  43,276
  8,426
  105,231
  20,632
  143,318
  29,725
  291,825
  59,164
  43,276
  8,748
  105,231
  21,228
  143,318
  29,188
  291,825
  57,620
  43,276
  8,422
  105,231
  21,632
  143,318
  27,566
  291,825
  57,297
  43,276
  9,625
  105,231
  21,822
  143,318
  25,850
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0

. file write tablecontent _n 

. 
. tabulatevariable, variable(diabcat) min(1) max(4) missing
  291,825
  221,210
  43,276
  32,884
  105,231
  79,548
  143,318
  108,778
  291,825
  51,260
  43,276
  7,583
  105,231
  19,012
  143,318
  24,665
  291,825
  18,572
  43,276
  2,712
  105,231
  6,366
  143,318
  9,494
  291,825
  783
  43,276
  97
  105,231
  305
  143,318
  381
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0

. file write tablecontent _n 

. 
. file write tablecontent _n _n

. 
. ** COPD TREATMENT VARIABLES (binary)
. foreach treat of varlist        saba_single             ///
>                                                         high_dose_ics           ///
>                                                         low_med_dose_ics        ///
>                                                         ics_single              ///
>                                                         sama_single             ///
>                                                         laba_single                     ///
>                                                         lama_single                     ///
>                                                         laba_ics                        ///
>                                                         laba_lama                       ///
>                                                         laba_lama_ics           ///
>                             ltra_single                 ///     
>                                                 {               
  2. 
. local lab: variable label `treat'
  3. file write tablecontent ("`lab'") _n 
  4.         
. generaterow, variable(`treat') condition("==0")
  5. generaterow, variable(`treat') condition("==1")
  6. 
. file write tablecontent _n
  7. 
. }
  291,825
  125,029
  43,276
  12,351
  105,231
  21,545
  143,318
  91,133
  291,825
  166,796
  43,276
  30,925
  105,231
  83,686
  143,318
  52,185
  291,825
  266,115
  43,276
  43,276
  105,231
  79,752
  143,318
  143,087
  291,825
  25,710
  43,276
  0
  105,231
  25,479
  143,318
  231
  291,825
  204,589
  43,276
  43,276
  105,231
  22,752
  143,318
  138,561
  291,825
  87,236
  43,276
  0
  105,231
  82,479
  143,318
  4,757
  291,825
  284,518
  43,276
  43,276
  105,231
  102,907
  143,318
  138,335
  291,825
  7,307
  43,276
  0
  105,231
  2,324
  143,318
  4,983
  291,825
  288,504
  43,276
  43,117
  105,231
  103,744
  143,318
  141,643
  291,825
  3,321
  43,276
  159
  105,231
  1,487
  143,318
  1,675
  291,825
  283,764
  43,276
  40,846
  105,231
  104,377
  143,318
  138,541
  291,825
  8,061
  43,276
  2,430
  105,231
  854
  143,318
  4,777
  291,825
  204,166
  43,276
  38,687
  105,231
  59,747
  143,318
  105,732
  291,825
  87,659
  43,276
  4,589
  105,231
  45,484
  143,318
  37,586
  291,825
  216,281
  43,276
  43,276
  105,231
  29,687
  143,318
  143,318
  291,825
  75,544
  43,276
  0
  105,231
  75,544
  143,318
  0
  291,825
  245,675
  43,276
  1,930
  105,231
  100,427
  143,318
  143,318
  291,825
  46,150
  43,276
  41,346
  105,231
  4,804
  143,318
  0
  291,825
  258,791
  43,276
  43,276
  105,231
  72,197
  143,318
  143,318
  291,825
  33,034
  43,276
  0
  105,231
  33,034
  143,318
  0
  291,825
  291,825
  43,276
  43,276
  105,231
  105,231
  143,318
  143,318
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0

. 
. ** COMORBIDITIES (categorical and continous)
. 
. ** COMORBIDITIES (binary)
. 
. foreach comorb of varlist       asthma_ever                                             ///
>                                                         ckd                                                
>              ///
>                                                         copd                                               
>      ///
>                                                         hypertension                                    ///
>                                                         heart_failure                                   ///
>                                                         other_heart_disease                             ///
>                                                         diabetes                                           
>      ///
>                                                         cancer_ever                                     ///
>                                                         immunodef_any                                   ///
>                                                         other_respiratory                               ///
>                                                         statin                                             
>      ///
>                                                         insulin                                            
>      ///
>                                                         oral_steroids                                   ///
>                                                         flu_vaccine                                     ///
>                                                         pneumococcal_vaccine                    ///
>                                                         exacerbations                                   ///
>                                                         gp_consult {
  2. 
. local lab: variable label `comorb'
  3. file write tablecontent ("`lab'") _n 
  4.                                                         
. generaterow, variable(`comorb') condition("==0")
  5. generaterow, variable(`comorb') condition("==1")
  6. file write tablecontent _n
  7. 
. }
  291,825
  236,606
  43,276
  37,702
  105,231
  76,054
  143,318
  122,850
  291,825
  55,219
  43,276
  5,574
  105,231
  29,177
  143,318
  20,468
  291,825
  241,951
  43,276
  35,550
  105,231
  86,877
  143,318
  119,524
  291,825
  49,874
  43,276
  7,726
  105,231
  18,354
  143,318
  23,794
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0
  291,825
  291,825
  43,276
  43,276
  105,231
  105,231
  143,318
  143,318
  291,825
  146,916
  43,276
  21,601
  105,231
  50,976
  143,318
  74,339
  291,825
  144,909
  43,276
  21,675
  105,231
  54,255
  143,318
  68,979
  291,825
  267,258
  43,276
  39,427
  105,231
  95,281
  143,318
  132,550
  291,825
  24,567
  43,276
  3,849
  105,231
  9,950
  143,318
  10,768
  291,825
  226,379
  43,276
  33,238
  105,231
  81,130
  143,318
  112,011
  291,825
  65,446
  43,276
  10,038
  105,231
  24,101
  143,318
  31,307
  291,825
  221,210
  43,276
  32,884
  105,231
  79,548
  143,318
  108,778
  291,825
  70,615
  43,276
  10,392
  105,231
  25,683
  143,318
  34,540
  291,825
  251,806
  43,276
  37,058
  105,231
  90,165
  143,318
  124,583
  291,825
  40,019
  43,276
  6,218
  105,231
  15,066
  143,318
  18,735
  291,825
  290,179
  43,276
  43,071
  105,231
  104,693
  143,318
  142,415
  291,825
  1,646
  43,276
  205
  105,231
  538
  143,318
  903
  291,825
  291,825
  43,276
  43,276
  105,231
  105,231
  143,318
  143,318
  291,825
  0
  43,276
  0
  105,231
  0
  143,318
  0
  291,825
  150,426
  43,276
  20,518
  105,231
  50,905
  143,318
  79,003
  291,825
  141,399
  43,276
  22,758
  105,231
  54,326
  143,318
  64,315
  291,825
  283,101
  43,276
  42,049
  105,231
  102,164
  143,318
  138,888
  291,825
  8,724
  43,276
  1,227
  105,231
  3,067
  143,318
  4,430
  291,825
  230,237
  43,276
  34,134
  105,231
  68,402
  143,318
  127,701
  291,825
  61,588
  43,276
  9,142
  105,231
  36,829
  143,318
  15,617
  291,825
  88,759
  43,276
  10,897
  105,231
  25,862
  143,318
  52,000
  291,825
  203,066
  43,276
  32,379
  105,231
  79,369
  143,318
  91,318
  291,825
  232,537
  43,276
  32,442
  105,231
  84,433
  143,318
  115,662
  291,825
  59,288
  43,276
  10,834
  105,231
  20,798
  143,318
  27,656
  291,825
  236,136
  43,276
  34,746
  105,231
  77,871
  143,318
  123,519
  291,825
  55,689
  43,276
  8,530
  105,231
  27,360
  143,318
  19,799
  291,825
  8,475
  43,276
  492
  105,231
  1,511
  143,318
  6,472
  291,825
  283,350
  43,276
  42,784
  105,231
  103,720
  143,318
  136,846

. 
. * COMORBIDITIES (continous)
. 
. summarizevariable, variable(gp_consult_count)

. summarizevariable, variable(exacerbation_count)

. 
. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\04_an_descriptive_table_copd.log
  log type:  text
 closed on:  27 May 2020, 10:30:36
-------------------------------------------------------------------------------------------------------------
