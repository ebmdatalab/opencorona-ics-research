---------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\06_an_models_c
> opd.log
  log type:  text
 opened on:  22 May 2020, 13:49:37

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_cpnsdeath, clear

. 
. /* Sense check outcomes=======================================================*
> / 
. 
. tab exposure cpnsdeath, missing row

+----------------+
| Key            |
|----------------|
|   frequency    |
| row percentage |
+----------------+

                      |   Failure/censoring
                      |     indicator for
                      |  outcome: CPNS covid
       COPD Treatment |         death
             Exposure |         0          1 |     Total
----------------------+----------------------+----------
LABA/LAMA Combination |    43,230         52 |    43,282 
                      |     99.88       0.12 |    100.00 
----------------------+----------------------+----------
      ICS Combination |   105,042        209 |   105,251 
                      |     99.80       0.20 |    100.00 
----------------------+----------------------+----------
                Other |   143,185        150 |   143,335 
                      |     99.90       0.10 |    100.00 
----------------------+----------------------+----------
                Total |   291,457        411 |   291,868 
                      |     99.86       0.14 |    100.00 

. 
. /* Main Model=================================================================*
> /
. 
. /* Univariable model */ 
. 
. stcox i.exposure 

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -3106.5553
Iteration 1:   log likelihood = -3100.7919
Iteration 2:   log likelihood = -3100.7247
Iteration 3:   log likelihood = -3100.7247
Refining estimates:
Iteration 0:   log likelihood = -3100.7247

Cox regression -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          261
Time at risk    =      7838493
                                                LR chi2(1)       =       11.66
Log likelihood  =   -3100.7247                  Prob > chi2      =      0.0006

--------------------------------------------------------------------------------
            _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
      exposure |
ICS Combina..  |   1.655991   .2566276     3.25   0.001     1.222216    2.243716
--------------------------------------------------------------------------------

. estimates save ./$tempdir/univar, replace 
file ./copd_tempdata/univar.ster saved

. 
. /* Multivariable models */ 
. 
. * Age and Gender 
. * Age fit as spline in first instance, categorical below 
. 
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -3106.5553
Iteration 1:   log likelihood = -3042.2896
Iteration 2:   log likelihood = -2992.6499
Iteration 3:   log likelihood = -2990.8971
Iteration 4:   log likelihood = -2990.8874
Iteration 5:   log likelihood = -2990.8874
Refining estimates:
Iteration 0:   log likelihood = -2990.8874

Cox regression -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          261
Time at risk    =      7838493
                                                LR chi2(5)       =      231.34
Log likelihood  =   -2990.8874                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------
            _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
      exposure |
ICS Combina..  |   1.563032   .2423232     2.88   0.004      1.15346    2.118034
        1.male |   2.124234   .2929928     5.46   0.000     1.621053    2.783604
          age1 |   1.003114   .0441136     0.07   0.944     .9202738     1.09341
          age2 |   1.185902   .1003251     2.02   0.044     1.004705    1.399777
          age3 |   .5126707   .1774241    -1.93   0.054     .2601695    1.010231
--------------------------------------------------------------------------------

. estimates save ./$tempdir/multivar1, replace 
file ./copd_tempdata/multivar1.ster saved

. 
. * Age, Gender and Comorbidities 
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                            
>          ///
>                                                                                
>  i.smoke_nomiss                          ///
>                                                                                
>  i.imd                                           ///
>                                                                                
>  i.ckd                                           ///             
>                                                                                
>  i.hypertension                          ///             
>                                                                                
>  i.heart_failure                         ///             
>                                                                                
>  i.other_heart_disease           ///             
>                                                                                
>  i.diabetes                                      ///             
>                                                                                
>  i.cancer_ever                           ///                                   
>                   
>                                                                                
>  i.statin                                        ///             
>                                                                                
>  i.insulin                                       ///             
>                                                                                
>  i.flu_vaccine                           ///     
>                                                                                
>  i.pneumococcal_vaccine          ///     
>                                                                                
>  i.exacerbations                         ///
>                                                                                
>  i.gp_consult, strata(stp)                               

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -2288.5064
Iteration 1:   log likelihood = -2172.6002
Iteration 2:   log likelihood = -2108.3852
Iteration 3:   log likelihood = -2106.5091
Iteration 4:   log likelihood = -2106.5019
Iteration 5:   log likelihood = -2106.5019
Refining estimates:
Iteration 0:   log likelihood = -2106.5019

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          261
Time at risk    =      7838493
                                                LR chi2(25)      =      364.01
Log likelihood  =   -2106.5019                  Prob > chi2      =      0.0000

--------------------------------------------------------------------------------
            _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
---------------+----------------------------------------------------------------
      exposure |
ICS Combina..  |    1.46394   .2306141     2.42   0.016     1.075063    1.993485
        1.male |   2.060263   .2901388     5.13   0.000     1.563332    2.715151
          age1 |   .9869523   .0432477    -0.30   0.764     .9057264    1.075463
          age2 |   1.154599   .0976736     1.70   0.089     .9781905     1.36282
          age3 |   .5762494   .2001175    -1.59   0.112     .2917486    1.138183
               |
     obese4cat |
Obese I (3..)  |   1.318086   .1988573     1.83   0.067     .9806733    1.771589
Obese II (..)  |   1.263183   .2856596     1.03   0.302      .810911    1.967702
Obese III ..)  |   1.691969   .5065994     1.76   0.079     .9408722    3.042665
               |
  smoke_nomiss |
      Current  |   .3433717   .0783604    -4.68   0.000     .2195396    .5370517
               |
           imd |
            2  |   1.091478   .2096636     0.46   0.649     .7490426    1.590463
            3  |   .8388757   .1752956    -0.84   0.400     .5569631    1.263481
            4  |   1.283023   .2547491     1.26   0.209     .8694111    1.893406
5 most depr..  |   1.594871   .3260575     2.28   0.022     1.068329    2.380928
               |
           ckd |
          CKD  |   2.104774   .2951573     5.31   0.000     1.598967    2.770585
1.hypertension |   .9365192   .1290902    -0.48   0.634     .7148035    1.227006
1.heart_fai~re |    1.71135   .2616705     3.51   0.000       1.2682    2.309352
1.other_hea~se |   1.011927   .1440349     0.08   0.934      .765582    1.337541
    1.diabetes |   1.512294   .2109933     2.96   0.003     1.150476    1.987901
 1.cancer_ever |   .9994561   .1586918    -0.00   0.997     .7321693    1.364319
      1.statin |    .934248   .1297436    -0.49   0.624     .7116257    1.226514
     1.insulin |   .9851398   .2777179    -0.05   0.958     .5669413    1.711818
 1.flu_vaccine |   1.031175   .1711828     0.18   0.853     .7447773    1.427704
1.pneumococc~e |   1.015081   .1968584     0.08   0.938     .6941028     1.48449
1.exacerbati~s |    1.48149   .1971312     2.95   0.003     1.141394    1.922924
  1.gp_consult |   1.334821   .9525281     0.40   0.686     .3296141    5.405556
--------------------------------------------------------------------------------
                                                             Stratified by stp

.                                                                                
>  
. estimates save ./$tempdir/multivar2, replace 
file ./copd_tempdata/multivar2.ster saved

. 
. /* MODEL CHANGES TO DO: 
> - Diabetes as severity, remove insulin 
> */ 
. 
. /* Print table================================================================*
> / 
. *  Print the results for the main model 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table2.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 2: Association between current ICS use and CPNS
>  death - COPD Population") _n

. file write tablecontent _tab ("N") _tab ("Univariable") _tab _tab ("Age/Sex Adj
> usted") _tab _tab ///
>                                                 ("Age/Sex and Comorbidity Adjus
> ted") _tab _tab _n

. file write tablecontent _tab _tab ("HR") _tab ("95% CI") _tab ("HR") _tab ///
>                                                 ("95% CI") _tab ("HR") _tab ("9
> 5% CI") _n

. file write tablecontent ("Main Analysis") _n                                   
>  

. 
. * Row headings 
. local lab0: label exposure 0

. local lab1: label exposure 1

.  
. /* Counts */
.  
. * First row, exposure = 0 (reference)
. 
.         cou if exposure == 0 
  43,282

.         local rowdenom = r(N)

.         cou if exposure == 0 & cpnsdeath == 1
  52

.         local pct = 100*(r(N)/`rowdenom') 

.         
.         file write tablecontent ("`lab0'") _tab

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

.         file write tablecontent ("1.00 (ref)") _tab _tab ("1.00 (ref)") _tab _t
> ab ("1.00 (ref)") _n

.         
. * Second row, exposure = 1 (comparator)
. 
. file write tablecontent ("`lab1'") _tab  

. 
.         cou if exposure == 1 
  105,251

.         local rowdenom = r(N)

.         cou if exposure == 1 & cpnsdeath == 1
  209

.         local pct = 100*(r(N)/`rowdenom') 

.         file write tablecontent (r(N)) (" (") %3.1f (`pct') (")") _tab

. 
. /* Main Model */ 
. estimates use ./$tempdir/univar 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.655991   .2566276     3.25   0.001     1.222216    2.243716
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r
> (ub)) _tab 

. 
. estimates use ./$tempdir/multivar1 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.563032   .2423232     2.88   0.004      1.15346    2.118034
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r
> (ub)) _tab 

. 
. estimates use ./$tempdir/multivar2 

. lincom 1.exposure, eform

 ( 1)  1.exposure = 0

------------------------------------------------------------------------------
          _t |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |    1.46394   .2306141     2.42   0.016     1.075063    1.993485
------------------------------------------------------------------------------

. file write tablecontent %4.2f (r(estimate)) _tab %4.2f (r(lb)) (" - ") %4.2f (r
> (ub)) _n 

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\06_an_models_c
> opd.log
  log type:  text
 closed on:  22 May 2020, 13:50:02
---------------------------------------------------------------------------------
