--------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\08_an_model_checks_copd.log
  log type:  text
 opened on:  22 May 2020, 09:13:54

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_cpnsdeath, clear

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.08608         1.93        1         0.1644
      ------------+---------------------------------------------------
      global test |                      1.93        1         0.1644
      ----------------------------------------------------------------

. local univar_p = round(r(p),0.001)

. di `univar_p'
.164

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable", position(11) size(m
> edsmall)) 

. 
. graph export "$outdir/schoenplot1.svg", as(svg) replace
(note: file copd_output/schoenplot1.svg not found)
(file copd_output/schoenplot1.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -3106.5553
Iteration 1:   log likelihood = -3042.2896
Iteration 2:   log likelihood = -2992.6499
Iteration 3:   log likelihood = -2990.8971
Iteration 4:   log likelihood = -2990.8874
Iteration 5:   log likelihood = -2990.8874
Refining estimates:
Iteration 0:   log likelihood = -2990.8874

Cox regression -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          261
Time at risk    =      7838493
                                                LR chi2(5)       =      231.34
Log likelihood  =   -2990.8874                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------
              _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        exposure |
ICS Combination  |   1.563032   .2423232     2.88   0.004      1.15346    2.118034
          1.male |   2.124234   .2929928     5.46   0.000     1.621053    2.783604
            age1 |   1.003114   .0441136     0.07   0.944     .9202738     1.09341
            age2 |   1.185902   .1003251     2.02   0.044     1.004705    1.399777
            age3 |   .5126707   .1774241    -1.93   0.054     .2601695    1.010231
----------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.08727         2.00        1         0.1577
      0b.male     |            .            .        1             .
      1.male      |      0.04810         0.61        1         0.4362
      age1        |     -0.03490         0.36        1         0.5508
      age2        |      0.00165         0.00        1         0.9781
      age3        |      0.02355         0.15        1         0.6985
      ------------+---------------------------------------------------
      global test |                      7.98        5         0.1572
      ----------------------------------------------------------------

. local multivar1_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted", position(1
> 1) size(medsmall))                          

. 
. graph export "$outdir/schoenplot2.svg", as(svg) replace
(note: file copd_output/schoenplot2.svg not found)
(file copd_output/schoenplot2.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss        
>                   ///
>                                                                                 i.imd                 
>                           ///
>                                                                                 i.ckd                 
>                           ///             
>                                                                                 i.hypertension        
>                   ///             
>                                                                                 i.heart_failure       
>                   ///             
>                                                                                 i.other_heart_disease 
>           ///             
>                                                                                 i.diabetes            
>                           ///             
>                                                                                 i.cancer_ever         
>                   ///                                     
>                                                                                 i.statin              
>                           ///             
>                                                                                 i.insulin             
>                           ///             
>                                                                                 i.flu_vaccine         
>                   ///     
>                                                                                 i.pneumococcal_vaccine
>           ///
>                                                                                 i.exacerbations       
>                   ///
>                                                                                 i.gp_consult, strata(s
> tp)       

         failure _d:  cpnsdeath
   analysis time _t:  (stime_cpnsdeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -1015.1487
Iteration 1:   log likelihood = -971.21963
Iteration 2:   log likelihood = -967.17436
Iteration 3:   log likelihood = -966.89395
Iteration 4:   log likelihood = -966.88361
Iteration 5:   log likelihood = -966.88359
Iteration 6:   log likelihood = -966.88359
Refining estimates:
Iteration 0:   log likelihood = -966.88359

Stratified Cox regr. -- Breslow method for ties

No. of subjects =       33,978                  Number of obs    =      33,978
No. of failures =          140
Time at risk    =      1788146
                                                LR chi2(25)      =       96.53
Log likelihood  =   -966.88359                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
      ICS Combination  |   1.034255   .2024932     0.17   0.863     .7046504    1.518034
                1.male |   1.755388   .3286111     3.01   0.003     1.216262    2.533491
                  age1 |   1.026847   .1240822     0.22   0.826     .8103043    1.301257
                  age2 |   1.008299    .194247     0.04   0.966     .6912048    1.470862
                  age3 |   1.018261    .719293     0.03   0.980     .2550208    4.065767
                       |
             obese4cat |
    Obese I (30-34.9)  |    1.09547   .2277283     0.44   0.661     .7288714    1.646454
   Obese II (35-39.9)  |   .9244274   .3042548    -0.24   0.811     .4849743    1.762085
      Obese III (40+)  |   1.447784   .5927164     0.90   0.366     .6489712    3.229847
                       |
          smoke_nomiss |
              Current  |   .4529573   .1465491    -2.45   0.014     .2402486    .8539919
                       |
                   imd |
                    2  |   1.246056   .3128674     0.88   0.381     .7617507    2.038274
                    3  |   .8649923   .2405932    -0.52   0.602     .5014814    1.492003
                    4  |   1.058186   .2993679     0.20   0.842     .6077873    1.842352
      5 most deprived  |   1.546232   .4398382     1.53   0.125      .885408    2.700262
                       |
                   ckd |
                  CKD  |    7.16743   5.365686     2.63   0.009     1.652481    31.08783
        1.hypertension |   .8903438   .1707632    -0.61   0.545     .6113668    1.296623
       1.heart_failure |   1.492587   .2880643     2.08   0.038     1.022494    2.178807
 1.other_heart_disease |   1.178267   .2205546     0.88   0.381      .816415    1.700499
            1.diabetes |   1.792779   .3349426     3.12   0.002     1.243077    2.585566
         1.cancer_ever |   1.032986   .2144598     0.16   0.876     .6876621    1.551721
              1.statin |   .7604311   .1417563    -1.47   0.142     .5276944    1.095815
             1.insulin |   .7718456   .2805558    -0.71   0.476     .3785557    1.573733
         1.flu_vaccine |   .7949355   .1696161    -1.08   0.282     .5232512    1.207685
1.pneumococcal_vaccine |   1.118319   .3061719     0.41   0.683     .6539206    1.912523
       1.exacerbations |   1.272749   .2398751     1.28   0.201      .879664    1.841488
          1.gp_consult |   .7796388   .5609635    -0.35   0.729     .1903002    3.194093
----------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.04766         0.33        1         0.5663
      0b.male     |            .            .        1             .
      1.male      |     -0.00890         0.01        1         0.9159
      age1        |     -0.00016         0.00        1         0.9990
      age2        |     -0.03299         0.07        1         0.7900
      age3        |      0.05223         0.21        1         0.6477
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.05493         0.40        1         0.5271
      3.obese4cat |     -0.00812         0.01        1         0.9232
      4.obese4cat |     -0.02850         0.11        1         0.7354
      2b.smoke_n~s|            .            .        1             .
      3.smoke_no~s|      0.11582         1.85        1         0.1741
      1b.imd      |            .            .        1             .
      2.imd       |      0.06746         0.62        1         0.4292
      3.imd       |     -0.00429         0.00        1         0.9601
      4.imd       |      0.06961         0.62        1         0.4300
      5.imd       |      0.19151         4.72        1         0.0298
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.00374         0.00        1         0.9651
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.05061         0.37        1         0.5451
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|      0.20361         6.00        1         0.0143
      0b.other_~se|            .            .        1             .
      1.other_h~se|     -0.02124         0.06        1         0.7998
      0b.diabetes |            .            .        1             .
      1.diabetes  |      0.24399         8.24        1         0.0041
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.05077         0.37        1         0.5434
      0b.statin   |            .            .        1             .
      1.statin    |      0.03066         0.15        1         0.6967
      0b.insulin  |            .            .        1             .
      1.insulin   |     -0.10361         1.55        1         0.2133
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.00420         0.00        1         0.9597
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.09421         1.22        1         0.2703
      0b.exacerb~s|            .            .        1             .
      1.exacerba~s|     -0.02143         0.07        1         0.7967
      0b.gp_con~lt|            .            .        1             .
      1.gp_consult|      0.09543         1.32        1         0.2500
      ------------+---------------------------------------------------
      global test |                     29.92       25         0.2274
      ----------------------------------------------------------------

. local multivar2_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted", position(11) siz
> e(medsmall))                

.                           
. graph export "$outdir/schoenplot3.svg", as(svg) replace
(note: file copd_output/schoenplot3.svg not found)
(file copd_output/schoenplot3.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace
(note: file ./copd_output/table4.txt not found)

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("Treatment Exposure") _tab

. file write tablecontent ("`univar_p'") _tab ("`multivar1_p'") _tab ("`multivar2_p'")

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\08_an_model_checks_copd.log
  log type:  text
 closed on:  22 May 2020, 09:14:55
--------------------------------------------------------------------------------------------------------
