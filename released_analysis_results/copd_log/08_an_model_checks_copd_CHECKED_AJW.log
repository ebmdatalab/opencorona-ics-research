-------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\08_an_model_checks_copd.log
  log type:  text
 opened on:  27 May 2020, 10:32:00

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.12082         5.85        1         0.0155
      ------------+---------------------------------------------------
      global test |                      5.85        1         0.0155
      ----------------------------------------------------------------

. local univar_p = round(r(p),0.001)

. di `univar_p'
.016

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable", position(11) size(medsma
> ll)) 

. 
. graph export "$outdir/schoenplot1.svg", as(svg) replace
(file copd_output/schoenplot1.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -4772.5589
Iteration 1:   log likelihood = -4752.3796
Iteration 2:   log likelihood = -4564.5315
Iteration 3:   log likelihood = -4557.2836
Iteration 4:   log likelihood = -4556.8832
Iteration 5:   log likelihood = -4556.8734
Iteration 6:   log likelihood = -4556.8734
Refining estimates:
Iteration 0:   log likelihood = -4556.8734

Cox regression -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          401
Time at risk    =      9161390
                                                LR chi2(5)       =      431.37
Log likelihood  =   -4556.8734                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------
              _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        exposure |
ICS Combination  |   1.388106   .1682552     2.71   0.007     1.094578    1.760348
          1.male |    1.81638   .1958543     5.54   0.000     1.470363    2.243825
            age1 |   1.031967   .0460505     0.71   0.481     .9455442    1.126289
            age2 |   1.147757   .0922743     1.71   0.087     .9804319    1.343639
            age3 |   .5977683   .1888873    -1.63   0.103     .3217836    1.110457
----------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.12392         6.19        1         0.0129
      0b.male     |            .            .        1             .
      1.male      |     -0.02531         0.26        1         0.6117
      age1        |      0.02303         0.25        1         0.6139
      age2        |     -0.02627         0.31        1         0.5785
      age3        |      0.03522         0.53        1         0.4657
      ------------+---------------------------------------------------
      global test |                     12.25        5         0.0315
      ----------------------------------------------------------------

. local multivar1_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted", position(11) si
> ze(medsmall))                          

. 
. graph export "$outdir/schoenplot2.svg", as(svg) replace
(file copd_output/schoenplot2.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3  i.obese4cat                                     ///
>                                                                                 i.smoke_nomiss             
>              ///
>                                                                                 i.asthma_ever              
>              ///
>                                                                                 i.imd                      
>                      ///
>                                                                                 i.ckd                      
>                      ///             
>                                                                                 i.hypertension             
>              ///             
>                                                                                 i.heart_failure            
>              ///             
>                                                                                 i.other_heart_disease      
>      ///             
>                                                                                 i.diabcat                  
>                      ///             
>                                                                                 i.cancer_ever              
>              ///                                     
>                                                                                 i.statin                   
>                      ///                     
>                                                                                 i.flu_vaccine              
>              ///     
>                                                                                 i.pneumococcal_vaccine     
>      ///
>                                                                                 i.exacerbations, strata(stp
> )    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -3515.1894
Iteration 1:   log likelihood = -3444.1544
Iteration 2:   log likelihood = -3241.6651
Iteration 3:   log likelihood = -3229.2647
Iteration 4:   log likelihood = -3228.7772
Iteration 5:   log likelihood = -3228.7655
Iteration 6:   log likelihood = -3228.7655
Refining estimates:
Iteration 0:   log likelihood = -3228.7655

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      148,507                  Number of obs    =     148,507
No. of failures =          401
Time at risk    =      9161390
                                                LR chi2(26)      =      572.85
Log likelihood  =   -3228.7655                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
           ICS Combination  |    1.34812   .1675898     2.40   0.016     1.056605    1.720064
                     1.male |   1.782977   .1966634     5.24   0.000     1.436342    2.213267
                       age1 |   1.025266   .0458021     0.56   0.576     .9393137    1.119084
                       age2 |   1.124151   .0906797     1.45   0.147     .9597598    1.316701
                       age3 |   .6472393   .2056674    -1.37   0.171     .3472052    1.206545
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.172384    .148887     1.25   0.210     .9140532    1.503725
        Obese II (35-39.9)  |   1.317985   .2423574     1.50   0.133     .9191527    1.889877
           Obese III (40+)  |   1.787156   .4407092     2.35   0.019     1.102194    2.897791
                            |
               smoke_nomiss |
                   Current  |    .539666    .086739    -3.84   0.000     .3938345    .7394968
              1.asthma_ever |   .8107676   .0986668    -1.72   0.085     .6387176    1.029162
                            |
                        imd |
                         2  |   1.056669   .1623975     0.36   0.720     .7818427      1.4281
                         3  |   .8263892   .1381415    -1.14   0.254     .5955187    1.146763
                         4  |   1.216528   .1945685     1.23   0.220     .8891666    1.664413
           5 most deprived  |    1.54374    .251532     2.66   0.008     1.121714    2.124547
                            |
                        ckd |
                       CKD  |   1.748166   .1958005     4.99   0.000     1.403606    2.177309
             1.hypertension |   .9300387   .1032854    -0.65   0.514     .7481194    1.156195
            1.heart_failure |   1.659199   .2053634     4.09   0.000     1.301796    2.114725
      1.other_heart_disease |   1.030783   .1181775     0.26   0.791     .8233388    1.290494
                            |
                    diabcat |
       Controlled diabetes  |   1.346124   .1621741     2.47   0.014     1.063008    1.704643
     Uncontrolled diabetes  |    1.63621   .2820754     2.86   0.004     1.167066    2.293942
Diabetes, no hba1c measure  |    1.74544   1.245492     0.78   0.435     .4310362    7.067994
                            |
              1.cancer_ever |   1.060451   .1324614     0.47   0.638      .830169    1.354611
                   1.statin |   .8724727   .0967129    -1.23   0.218     .7020965    1.084194
              1.flu_vaccine |   1.024969    .136788     0.18   0.853     .7890651    1.331399
     1.pneumococcal_vaccine |   .9336154   .1550067    -0.41   0.679     .6742864    1.292682
            1.exacerbations |   1.437441   .1544265     3.38   0.001     1.164512    1.774336
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |     -0.11548         5.31        1         0.0212
      0b.male     |            .            .        1             .
      1.male      |     -0.02828         0.31        1         0.5749
      age1        |      0.02809         0.38        1         0.5381
      age2        |     -0.03126         0.44        1         0.5078
      age3        |      0.03901         0.65        1         0.4185
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.05854         1.32        1         0.2502
      3.obese4cat |     -0.00210         0.00        1         0.9670
      4.obese4cat |     -0.09768         3.83        1         0.0504
      2b.smoke_n~s|            .            .        1             .
      3.smoke_no~s|      0.08839         3.15        1         0.0758
      0b.asthma_~r|            .            .        1             .
      1.asthma_e~r|      0.02613         0.28        1         0.6000
      1b.imd      |            .            .        1             .
      2.imd       |      0.00668         0.02        1         0.8953
      3.imd       |      0.02433         0.23        1         0.6322
      4.imd       |      0.08444         2.74        1         0.0976
      5.imd       |      0.03951         0.59        1         0.4408
      0b.ckd      |            .            .        1             .
      1.ckd       |      0.01341         0.08        1         0.7755
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|      0.04683         0.90        1         0.3429
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|      0.06608         1.70        1         0.1920
      0b.other_~se|            .            .        1             .
      1.other_h~se|      0.01808         0.13        1         0.7209
      1b.diabcat  |            .            .        1             .
      2.diabcat   |      0.09461         3.73        1         0.0534
      3.diabcat   |      0.01729         0.12        1         0.7295
      4.diabcat   |      0.01736         0.12        1         0.7290
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.00225         0.00        1         0.9634
      0b.statin   |            .            .        1             .
      1.statin    |     -0.03128         0.43        1         0.5120
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|     -0.00690         0.02        1         0.8894
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.00032         0.00        1         0.9950
      0b.exacerb~s|            .            .        1             .
      1.exacerba~s|      0.01305         0.07        1         0.7965
      ------------+---------------------------------------------------
      global test |                     31.67       26         0.2042
      ----------------------------------------------------------------

. local multivar2_p = round(r(phtest)[2,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted", position(11) size(med
> small))                

.                           
. graph export "$outdir/schoenplot3.svg", as(svg) replace
(file copd_output/schoenplot3.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("Treatment Exposure") _tab

. file write tablecontent ("`univar_p'") _tab ("`multivar1_p'") _tab ("`multivar2_p'")

. 
. file write tablecontent _n

. file close tablecontent

. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\copd_log\08_an_model_checks_copd.log
  log type:  text
 closed on:  27 May 2020, 10:33:25
-------------------------------------------------------------------------------------------------------------
