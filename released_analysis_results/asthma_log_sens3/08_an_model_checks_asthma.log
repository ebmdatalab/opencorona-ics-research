----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log_sens3\08_an_model_checks_asthma.log
  log type:  text
 opened on:  27 Jul 2020, 14:53:47

. 
. * Open Stata dataset
. use $tempdir\analysis_dataset_STSET_$outcome, clear

. 
. * Exposure labels 
. local lab1: label exposure 1

. local lab2: label exposure 2

. 
. /* Quietly run models, perform test and store results in local macro==========*/
. 
. qui stcox i.exposure 

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.03285         0.62        1         0.4324
      2.exposure  |      0.02210         0.28        1         0.5974
      ------------+---------------------------------------------------
      global test |                      0.62        2         0.7325
      ----------------------------------------------------------------

. local univar_p1 = round(r(phtest)[2,4],0.001)

. local univar_p2 = round(r(phtest)[3,4],0.001)

. 
. di `univar_p1'
.432

. di `univar_p2'
.597

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab1'", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1a.svg", as(svg) replace
(file asthma_output_sens3/schoenplot1a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, univariable `lab2'", position(11) size(medsmall)) 

. 
. graph export "$outdir/schoenplot1b.svg", as(svg) replace
(file asthma_output_sens3/schoenplot1b.svg written in SVG format)

. 
. * Close window 
. graph close  

.                           
. stcox i.exposure i.male age1 age2 age3 

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood =  -7804.066
Iteration 1:   log likelihood = -7282.9383
Iteration 2:   log likelihood = -7209.9123
Iteration 3:   log likelihood = -7206.4155
Iteration 4:   log likelihood = -7205.8498
Iteration 5:   log likelihood = -7205.8161
Iteration 6:   log likelihood = -7205.8159
Refining estimates:
Iteration 0:   log likelihood = -7205.8159

Cox regression -- Breslow method for ties

No. of subjects =      863,523                  Number of obs    =     863,523
No. of failures =          571
Time at risk    =     56931867
                                                LR chi2(6)       =     1196.50
Log likelihood  =   -7205.8159                  Prob > chi2      =      0.0000

----------------------------------------------------------------------------------------
                    _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------------+----------------------------------------------------------------
              exposure |
ICS (Low/Medium Dose)  |   1.028409   .1396341     0.21   0.837     .7881205    1.341959
      ICS (High Dose)  |   1.623327   .2567927     3.06   0.002     1.190571    2.213385
                       |
                1.male |   1.514413   .1283917     4.90   0.000     1.282566    1.788171
                  age1 |   1.139368   .0681017     2.18   0.029     1.013413    1.280978
                  age2 |   .8790282   .1087202    -1.04   0.297     .6898017    1.120163
                  age3 |   1.508491   .4923339     1.26   0.208     .7956681    2.859919
----------------------------------------------------------------------------------------

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.03614         0.75        1         0.3869
      2.exposure  |      0.02468         0.35        1         0.5551
      0b.male     |            .            .        1             .
      1.male      |     -0.09259         4.98        1         0.0256
      age1        |      0.04395         1.33        1         0.2488
      age2        |     -0.05713         2.20        1         0.1379
      age3        |      0.06471         2.78        1         0.0953
      ------------+---------------------------------------------------
      global test |                     17.65        6         0.0072
      ----------------------------------------------------------------

. local multivar1_p1 = round(r(phtest)[2,4],0.001)

. local multivar1_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab1'", position(11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2a.svg", as(svg) replace
(file asthma_output_sens3/schoenplot2a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, age and sex adjusted `lab2'", position(11) size(medsmall))                           

. 
. graph export "$outdir/schoenplot2b.svg", as(svg) replace
(file asthma_output_sens3/schoenplot2b.svg written in SVG format)

. 
. * Close window 
. graph close

.                   
. stcox i.exposure i.male age1 age2 age3 $varlist, strata(stp)    

         failure _d:  onscoviddeath
   analysis time _t:  (stime_onscoviddeath-origin)
             origin:  time enter_date
  enter on or after:  time enter_date
                 id:  patient_id

Iteration 0:   log likelihood = -5949.1022
Iteration 1:   log likelihood = -5462.9223
Iteration 2:   log likelihood = -5233.7455
Iteration 3:   log likelihood = -5229.0346
Iteration 4:   log likelihood = -5228.9982
Iteration 5:   log likelihood =  -5228.998
Refining estimates:
Iteration 0:   log likelihood =  -5228.998

Stratified Cox regr. -- Breslow method for ties

No. of subjects =      863,523                  Number of obs    =     863,523
No. of failures =          571
Time at risk    =     56931867
                                                LR chi2(28)      =     1440.21
Log likelihood  =    -5228.998                  Prob > chi2      =      0.0000

---------------------------------------------------------------------------------------------
                         _t | Haz. Ratio   Std. Err.      z    P>|z|     [95% Conf. Interval]
----------------------------+----------------------------------------------------------------
                   exposure |
     ICS (Low/Medium Dose)  |   1.156903   .1579159     1.07   0.286     .8853375    1.511767
           ICS (High Dose)  |   1.551277   .2481296     2.75   0.006     1.133804    2.122465
                            |
                     1.male |    1.54575   .1361682     4.94   0.000     1.300635     1.83706
                       age1 |   1.131716   .0678422     2.06   0.039     1.006262     1.27281
                       age2 |   .8735186   .1092959    -1.08   0.280     .6835473    1.116287
                       age3 |   1.524438   .5057726     1.27   0.204      .795612    2.920911
                            |
                  obese4cat |
         Obese I (30-34.9)  |   1.126314   .1190347     1.13   0.260     .9155879    1.385539
        Obese II (35-39.9)  |   1.073456   .1651526     0.46   0.645     .7940102    1.451252
           Obese III (40+)  |   1.831066   .3073802     3.60   0.000      1.31769    2.544455
                            |
               smoke_nomiss |
                    Former  |   1.114263   .0986063     1.22   0.221     .9368301    1.325301
                   Current  |   .6517899   .1564843    -1.78   0.075     .4071437     1.04344
                            |
                        imd |
                         2  |   1.171881   .1702018     1.09   0.275     .8815694    1.557795
                         3  |   1.313901   .1872607     1.92   0.055     .9936809    1.737313
                         4  |   1.595816   .2247289     3.32   0.001     1.210914    2.103062
           5 most deprived  |   1.865784   .2728365     4.27   0.000     1.400841    2.485043
                            |
                        ckd |
                       CKD  |   1.394655   .1414209     3.28   0.001     1.143282    1.701298
             1.hypertension |   1.337974    .138576     2.81   0.005     1.092163    1.639109
            1.heart_failure |   1.688832   .2094912     4.22   0.000     1.324339    2.153644
      1.other_heart_disease |    1.13237    .118398     1.19   0.234     .9225475    1.389914
                            |
                    diabcat |
       Controlled diabetes  |    1.68957   .1769974     5.01   0.000     1.375958     2.07466
     Uncontrolled diabetes  |   2.677787   .3459833     7.62   0.000     2.078723    3.449495
Diabetes, no hba1c measure  |   1.981796   1.154981     1.17   0.241     .6323872    6.210621
                            |
              1.cancer_ever |   1.414796   .1527858     3.21   0.001      1.14491    1.748302
                   1.statin |   .8373682   .0792921    -1.87   0.061     .6955277    1.008135
              1.flu_vaccine |     .87015   .0934095    -1.30   0.195      .705048    1.073914
     1.pneumococcal_vaccine |   .8615777    .133235    -0.96   0.335     .6363031    1.166608
            1.exacerbations |   1.315969   .1232562     2.93   0.003     1.095268    1.581142
            1.immunodef_any |   2.222538   1.289085     1.38   0.169     .7130947    6.927094
---------------------------------------------------------------------------------------------
                                                             Stratified by stp

. estat phtest, detail

      Test of proportional-hazards assumption

      Time:  Time
      ----------------------------------------------------------------
                  |       rho            chi2       df       Prob>chi2
      ------------+---------------------------------------------------
      0b.exposure |            .            .        1             .
      1.exposure  |      0.02817         0.46        1         0.4987
      2.exposure  |      0.02487         0.36        1         0.5510
      0b.male     |            .            .        1             .
      1.male      |     -0.08833         4.62        1         0.0315
      age1        |      0.04521         1.41        1         0.2345
      age2        |     -0.05537         2.12        1         0.1458
      age3        |      0.06177         2.61        1         0.1059
      1b.obese4cat|            .            .        1             .
      2.obese4cat |     -0.06302         2.25        1         0.1334
      3.obese4cat |     -0.00237         0.00        1         0.9548
      4.obese4cat |     -0.02574         0.37        1         0.5433
      1b.smoke_n~s|            .            .        1             .
      2.smoke_no~s|     -0.06117         2.09        1         0.1484
      3.smoke_no~s|      0.00775         0.04        1         0.8488
      1b.imd      |            .            .        1             .
      2.imd       |      0.07206         2.94        1         0.0864
      3.imd       |      0.02065         0.24        1         0.6230
      4.imd       |      0.04035         0.91        1         0.3398
      5.imd       |      0.03470         0.68        1         0.4088
      0b.ckd      |            .            .        1             .
      1.ckd       |     -0.05800         2.12        1         0.1456
      0b.hyperte~n|            .            .        1             .
      1.hyperten~n|     -0.00446         0.01        1         0.9088
      0b.heart_~re|            .            .        1             .
      1.heart_f~re|      0.04012         1.01        1         0.3138
      0b.other_~se|            .            .        1             .
      1.other_h~se|      0.00100         0.00        1         0.9801
      1b.diabcat  |            .            .        1             .
      2.diabcat   |     -0.05394         1.60        1         0.2053
      3.diabcat   |     -0.03487         0.73        1         0.3936
      4.diabcat   |      0.01839         0.19        1         0.6605
      0b.cancer_~r|            .            .        1             .
      1.cancer_e~r|      0.04045         0.98        1         0.3227
      0b.statin   |            .            .        1             .
      1.statin    |     -0.01093         0.07        1         0.7905
      0b.flu_vac~e|            .            .        1             .
      1.flu_vacc~e|      0.03155         0.61        1         0.4353
      0b.pneumoc~e|            .            .        1             .
      1.pneumoco~e|     -0.00059         0.00        1         0.9888
      0b.exacerb~s|            .            .        1             .
      1.exacerba~s|     -0.04424         1.12        1         0.2892
      0b.immunod~y|            .            .        1             .
      1.immunode~y|      0.01199         0.08        1         0.7744
      ------------+---------------------------------------------------
      global test |                     35.79       28         0.1479
      ----------------------------------------------------------------

. local multivar2_p1 = round(r(phtest)[2,4],0.001)

. local multivar2_p2 = round(r(phtest)[3,4],0.001)

.  
. estat phtest, plot(1.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) /// 
>                           title ("Schoenfeld residuals against time, fully adjusted `lab1'", position(11) size(medsmall))                 

.                           
. graph export "$outdir/schoenplot3a.svg", as(svg) replace
(file asthma_output_sens3/schoenplot3a.svg written in SVG format)

. 
. estat phtest, plot(2.exposure) ///
>                           graphregion(fcolor(white)) ///
>                           ylabel(, nogrid labsize(small)) ///
>                           xlabel(, labsize(small)) ///
>                           xtitle("Time", size(small)) ///
>                           ytitle("Scaled Shoenfeld Residuals", size(small)) ///
>                           msize(small) ///
>                           mcolor(gs6) ///
>                           msymbol(circle_hollow) ///
>                           scheme(s1mono) ///
>                           title ("Schoenfeld residuals against time, fully adjusted `lab2'", position(11) size(medsmall))                 

.                           
. graph export "$outdir/schoenplot3b.svg", as(svg) replace
(file asthma_output_sens3/schoenplot3b.svg written in SVG format)

. 
. * Close window 
. graph close

. 
. * Print table of results======================================================*/        
. 
. 
. cap file close tablecontent

. file open tablecontent using ./$outdir/table4.txt, write text replace

. 
. * Column headings 
. file write tablecontent ("Table 4: Testing the PH assumption for $tableoutcome - $population Population") _n

. file write tablecontent _tab ("Univariable") _tab ("Age/Sex Adjusted") _tab ///
>                                                 ("Age/Sex and Comorbidity Adjusted") _tab _n

.                                                 
. file write tablecontent _tab ("p-value") _tab ("p-value") _tab ("p-value") _tab _n

. 
. * Row heading and content  
. file write tablecontent ("`lab1'") _tab

. file write tablecontent ("`univar_p1'") _tab ("`multivar1_p1'") _tab ("`multivar2_p1'") _n

. 
. file write tablecontent ("`lab2'") _tab

. file write tablecontent ("`univar_p2'") _tab ("`multivar1_p2'") _tab ("`multivar2_p2'") _n

. 
. file write tablecontent _n

. file close tablecontent

. 
. 
. * Close log file 
. log close
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\asthma_log_sens3\08_an_model_checks_asthma.log
  log type:  text
 closed on:  27 Jul 2020, 15:05:57
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
