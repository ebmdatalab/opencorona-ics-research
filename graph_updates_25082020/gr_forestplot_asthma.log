-------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\graph_log\gr_forestpl
> ot_asthma.log
  log type:  text
 opened on:  25 Aug 2020, 14:36:23

. 
. * All dta outputted from 06, append into one dataset 
. clear

. use asthma_tempdata/temp_asthma.dta

. append using asthma_tempdata/temp_asthma_eth.dta

. append using asthma_tempdata_sens2/temp_asthma.dta

. append using asthma_tempdata_sens3/temp_asthma.dta

. append using asthma_tempdata_psm/temp_asthma.dta

. 
. replace population = "Asthma - Ethn." if _n == 7
(1 real change made)

. replace population = "Asthma - Ethn." if _n == 8
(1 real change made)

. replace population = "Asthma - Ethn." if _n == 9
(1 real change made)

. 
. replace population = "Asthma - Ethn." if _n == 10
(1 real change made)

. replace population = "Asthma - Ethn." if _n == 11
(1 real change made)

. replace population = "Asthma - Ethn." if _n == 12
(1 real change made)

. 
. replace population = "Asthma - PS" if _n == 25
(1 real change made)

. replace population = "Asthma - PS" if _n == 26
(1 real change made)

. 
. 
. *rename to match the code below 
. rename level analysis 

. gen primsec = outcome + " - " + population 

. drop outcome population

. gen outcome = _n

. 
. *need to add in analysis column, in between primsec and title
. 
. gen result_label =string(estimate,"%6.2f") + " (" + string(min95,"%6.2f") + "
> -" + string(max95,"%6.2f") + ")"

. 
. egen first_primsec = tag(primsec)

. egen first_analysis = tag(outcome)

. gen order = _n

. 
. ** Now for the figure
. 
. *only keep variable/estimates you need for now
. *keep if parm == "1.t2dm"
. graph set window fontface "Calibri"

. **sort primsec outcome     
. 
. cap drop label

. gen label = outcome

. local obs1 = _N + 1

. set obs `obs1'
number of observations (_N) was 26, now 27

. replace outcome=0 if outcome == .
(1 real change made)

. replace order=0 if order == .
(1 real change made)

. sort  outcome  order 

. 
. * set some label values to missing so that we don't replicate information on 
> the graph
. replace primsec="" if first_primsec != 1
(21 real changes made)

. replace analysis="" if first_analysis != 1
(0 real changes made)

. 
. 
. * create label for outcome column
. cap drop obs

. gen obs = _n

. replace title="Exposure" if obs==1
(1 real change made)

. replace analysis="Analysis" if obs==1
(1 real change made)

. replace result_label = "HR (95% CI)" if obs==1
(1 real change made)

. replace exp1 = "ICS, by dose (n/N)" if obs==1
(1 real change made)

. replace exp0 = "SABA (n/N)" if obs==1
(1 real change made)

. 
. 
. *bold face some labels
. gen bftitle = "{bf:" + title + "}" if title == "Exposure"
(26 missing values generated)

. replace bftitle = title if bftitle == ""
variable bftitle was str13 now str21
(26 real changes made)

. gen bfanalysis = "{bf:" + analysis + "}" if analysis == "Analysis"
(26 missing values generated)

. replace bfanalysis = analysis if bfanalysis == ""
variable bfanalysis was str13 now str16
(26 real changes made)

. gen bf_result = "{bf:" + result_label + "}" if result_label == "HR (95% CI)"
(26 missing values generated)

. replace bf_result = result_label if bf_result == ""
(26 real changes made)

. gen bf_primsec = "{bf:" + primsec + "}" 

. 
. gen bf_exp0 = "{bf:" + exp0 + "}" if exp0 == "SABA (n/N)"
(26 missing values generated)

. replace bf_exp0 = exp0 if bf_exp0 == ""
(10 real changes made)

. 
. gen bf_exp1 = "{bf:" + exp1 + "}" if exp1 == "ICS, by dose (n/N)"
(26 missing values generated)

. replace bf_exp1 = exp1 if bf_exp1 == ""
(10 real changes made)

. 
. 
. cap drop x0_*

. gen x0_7 = -40.5

. gen x0_3=-20.5

. gen x0_1=-12

. gen x0_14=10

. 
. gen x0_exp1 = 18

. gen x0_exp0 = 25

. 
. cap drop obs

. gen obs = _n 

. cap drop no_obs 

. cap drop obs2

. cap drop obs3

. 
. egen no_obs = max(obs) 

. gen obs2 = no_obs - obs + 1

. rename obs obs3 

. rename obs2 obs

. *add space between column titles and data
. replace obs=obs+0.5 if obs==no_obs
(1 real change made)

. *add space between primary and secondary outcomes
. // replace obs=obs+.5 if outcome <=9
. // replace obs=obs+.5 if outcome <=6
. // replace obs=obs+.5 if outcome <=3
. // *add to no_obs the extra space I added
. // replace no_obs = no_obs+2
. local height=obs

. 
. 
. graph twoway ///
> || scatter obs estimate if obs<no_obs, msymbol(circle) msize(vsmall) mcolor(b
> lack)              /// data points 
>                 xline(1, lp(solid) lw(vthin) lcolor(black))                  
>                    /// add ref line
>         || rcap min95 max95 obs if obs<no_obs, horizontal lw(vthin) lcolor(bl
> ack)                                       /// add the CIs
> || scatter obs estimate if obs<no_obs, msymbol(circle) msize(vsmall) mcolor(b
> lack)              /// data points 
>                 xline(1, lp(solid) lw(vthin) lcolor(black))                  
>                    /// add ref line
>         || rcap min95 max95 obs if obs<no_obs, horizontal lw(vthin) lcolor(bl
> ack)                                       /// add the CIs
>                 /// Primary/Secondary outcomes
> || scatter obs x0_7 if obs<no_obs, m(i) mlab(bf_primsec) mlabcol(black) mlabs
> ize(vsmall) ///
> || scatter obs x0_7 if obs>no_obs, m(i) mlab(bf_primsec) mlabcol(black) mlabs
> ize(vsmall) ///            
>                 /// Analysis
> || scatter obs x0_3 if obs<no_obs, m(i) mlab(bfanalysis) mlabcol(black) mlabs
> ize(vsmall) ///
> || scatter obs x0_3 if obs>no_obs, m(i) mlab(bfanalysis) mlabcol(black) mlabs
> ize(vsmall) ///    
>                 /// Exposure
> || scatter obs x0_1 if obs<no_obs, m(i)  mlab(bftitle) mlabcol(black) mlabsiz
> e(vsmall)  ///
> || scatter obs x0_1 if obs>no_obs, m(i)  mlab(bftitle) mlabcol(black) mlabsiz
> e(vsmall)  ///
>                 /// add results labels
> || scatter obs x0_14 if obs<no_obs, m(i)  mlab(bf_result) mlabcol(black) mlab
> size(vsmall) mlabposition(0) mlabgap(tiny)   ///
> || scatter obs x0_14 if obs>no_obs, m(i)  mlab(bf_result) mlabcol(black) mlab
> size(vsmall) mlabposition(0) mlabgap(tiny)   ///
>                 /// add numerator  1
> || scatter obs x0_exp1 if obs<no_obs, m(i) mlab(bf_exp1) mlabcol(black) mlabs
> ize(vsmall) mlabposition(0) mlabgap(tiny)  ///
> || scatter obs x0_exp1 if obs>no_obs, m(i) mlab(bf_exp1) mlabcol(black) mlabs
> ize(vsmall) mlabposition(0) mlabgap(tiny)  ///
>                 /// add denominator   
> || scatter obs x0_exp0 if obs<no_obs, m(i) mlab(bf_exp0) mlabcol(black) mlabs
> ize(vsmall) mlabposition(0) mlabgap(tiny)  ///
> || scatter obs x0_exp0 if obs>no_obs, m(i) mlab(bf_exp0) mlabcol(black) mlabs
> ize(vsmall) mlabposition(0) mlabgap(tiny)  ///
>                 , legend(off)                                           /// t
> urn legend off
>                 xtitle("Hazard ratio (HR)", size(vsmall) margin(40 0 0 2))   
>            /// x-axis title (left right bottom top) - legend off
>                 xlab(0(1)6, labsize(vsmall)) /// x-axis tick marks
>                 xscale(range(0.01 26))                                  ///  
>    resize x-axis
>                 , ylab(none) ytitle("")         /// y-axis no labels or title
>                 yscale(range(1 `height') lcolor(white))                      
>            /// resize y-axis
>                 graphregion(color(white)) ysize(15) xsize(20) saving(forestpl
> ot1_asthma, replace)       /// get rid of rubbish grey/blue around graph
> 
(file forestplot1_asthma.gph saved)

. graph export "$outdir/forestplot1_asthma.pdf", as(pdf) replace
(file graph_out/forestplot1_asthma.pdf written in PDF format)

. 
. log close 
      name:  <unnamed>
       log:  E:\analyses\opensafely-ics-research\analysis\graph_log\gr_forestpl
> ot_asthma.log
  log type:  text
 closed on:  25 Aug 2020, 14:36:26
-------------------------------------------------------------------------------
